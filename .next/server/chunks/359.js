"use strict";exports.id=359,exports.ids=[359],exports.modules={8860:(e,t,r)=>{r.d(t,{En:()=>w,bZ:()=>y,ss:()=>p,gE:()=>I,bO:()=>f});var i=r(92891),n=r(65655),o=r(47833);let s={district:{select:{id:!0,name:!0,unionId:!0}},_count:{select:{members:!0,sessions:!0}}},d=async(e,t={})=>{if("UNION_ADMIN"===e.role)return i.d.findMany({where:t.districtId?{districtId:t.districtId}:void 0,include:s,orderBy:{name:"asc"}});if("DISTRICT_ADMIN"===e.role){if(!e.districtId)throw new o.lY("No district assigned to this account");if(t.districtId&&t.districtId!==e.districtId)throw new o.lY("Cannot view churches outside your district");return i.d.findMany({where:{districtId:e.districtId},include:s,orderBy:{name:"asc"}})}if("CHURCH_ADMIN"===e.role){if(!e.churchId)throw new o.lY("No church assigned to this account");let t=await i.d.findById(e.churchId,{where:{id:e.churchId},include:s});if(!t)throw new o.dR("Church not found");return[t]}throw new o.lY("Not allowed to view churches")},a=async(e,t)=>{if("UNION_ADMIN"!==e.role&&"DISTRICT_ADMIN"!==e.role)throw new o.lY("Not allowed to create churches");let r=await n.e.findById(t.districtId,{include:{union:!0}});if(!r)throw new o.dR("District not found");if("UNION_ADMIN"===e.role&&e.unionId&&r.unionId!==e.unionId)throw new o.lY("Cannot create church outside your union");if("DISTRICT_ADMIN"===e.role&&e.districtId!==r.id)throw new o.lY("Cannot create church outside your district");return i.d.create({data:{districtId:t.districtId,name:t.name,location:t.location},include:s})},c=async(e,t)=>{let r=await i.d.findById({where:{id:t},include:s});if(!r)throw new o.dR("Church not found");if("UNION_ADMIN"===e.role){if(e.unionId&&r.district?.unionId!==e.unionId)throw new o.lY("Cannot view church outside your union");return r}if("DISTRICT_ADMIN"===e.role){if(!e.districtId||e.districtId!==r.districtId)throw new o.lY("Cannot view church outside your district");return r}if("CHURCH_ADMIN"===e.role){if(!e.churchId||e.churchId!==r.id)throw new o.lY("Cannot view another church");return r}throw new o.lY("Not allowed to view churches")},u=async(e,t,r)=>{let d=await i.d.findById({where:{id:t},include:{district:{include:{union:!0}}}});if(!d)throw new o.dR("Church not found");if("UNION_ADMIN"===e.role){if(e.unionId&&d.district.unionId!==e.unionId)throw new o.lY("Cannot modify church outside your union")}else if("DISTRICT_ADMIN"===e.role){if(!e.districtId||e.districtId!==d.districtId)throw new o.lY("Cannot modify church outside your district")}else if("CHURCH_ADMIN"===e.role){if(!e.churchId||e.churchId!==d.id)throw new o.lY("Cannot modify another church")}else throw new o.lY("Not allowed to update churches");let a=d.districtId;if(r.districtId){let t=await n.e.findById(r.districtId,{include:{union:!0}});if(!t)throw new o.dR("District not found");if("UNION_ADMIN"===e.role){if(e.unionId&&t.unionId!==e.unionId)throw new o.lY("Cannot move church outside your union")}else if("DISTRICT_ADMIN"===e.role){if(!e.districtId||e.districtId!==t.id)throw new o.lY("Cannot move church outside your district")}else throw new o.lY("Not allowed to move church");a=t.id}return await i.d.update({where:{id:t},data:{name:r.name,location:r.location,districtId:a},include:s})},l=async(e,t)=>{let r=await i.d.findById({where:{id:t},include:{district:{include:{union:!0}}}});if(!r)throw new o.dR("Church not found");if("UNION_ADMIN"===e.role){if(e.unionId&&r.district.unionId!==e.unionId)throw new o.lY("Cannot delete church outside your union")}else if("DISTRICT_ADMIN"===e.role){if(!e.districtId||e.districtId!==r.districtId)throw new o.lY("Cannot delete church outside your district")}else throw new o.lY("Not allowed to delete churches");return await prisma.church.delete({where:{id:t}}),{success:!0}};var h=r(6974);let I=async e=>({churches:await d(e.user,e.queryData??{})}),w=async e=>{if(!e.body)throw Error("Missing request body");let t=await a(e.user,e.body);return await (0,h.R)({req:e.req,user:e.user,action:"church.create",details:{churchId:t.id,name:t.name,districtId:t.districtId,location:t.location}}),{church:t}},f=async e=>{if(!e.params.churchId)throw Error("Church id is required");let t=e.body??{},r=await u(e.user,e.params.churchId,t),i=Object.fromEntries(Object.entries(t).filter(([,e])=>void 0!==e)),n={churchId:r.id,name:r.name,districtId:r.districtId,location:r.location,...Object.keys(i).length>0?{changes:i}:{}};return await (0,h.R)({req:e.req,user:e.user,action:"church.update",details:n}),{church:r}},y=async e=>{if(!e.params.churchId)throw Error("Church id is required");let t=await l(e.user,e.params.churchId);return await (0,h.R)({req:e.req,user:e.user,action:"church.delete",details:{churchId:e.params.churchId}}),t},p=async e=>{if(!e.params.churchId)throw Error("Church id is required");return{church:await c(e.user,e.params.churchId)}}},37848:(e,t,r)=>{r.d(t,{O:()=>s});let i=e=>{let t=process.env[e];if(!t)throw Error(`Missing required environment variable: ${e}`);return t},n="http://localhost:3000",o=(process.env.CORS_ORIGIN??n).split(",").map(e=>e.trim()).filter(Boolean),s={DATABASE_URL:i("DATABASE_URL"),JWT_SECRET:i("JWT_SECRET"),SMS_API_KEY:process.env.SMS_API_KEY??"",CORS_ORIGIN:process.env.CORS_ORIGIN??n,PRIMARY_ORIGIN:o[0]??n,TWILIO_ACCOUNT_SID:process.env.TWILIO_ACCOUNT_SID??"",TWILIO_AUTH_TOKEN:process.env.TWILIO_AUTH_TOKEN??"",TWILIO_FROM_NUMBER:process.env.TWILIO_FROM_NUMBER??"",GMAIL_USER:process.env.GMAIL_USER,GMAIL_APP_PASSWORD:process.env.GMAIL_APP_PASSWORD,GMAIL_FROM_NAME:process.env.GMAIL_FROM_NAME||"Umuganda SDA",SMTP_HOST:process.env.SMTP_HOST||"smtp.gmail.com",SMTP_PORT:process.env.SMTP_PORT||"587",SMTP_SECURE:process.env.SMTP_SECURE||"false"}},47833:(e,t,r)=>{r.d(t,{AY:()=>d,HC:()=>c,dR:()=>s,gz:()=>i,lY:()=>o,p8:()=>a,yj:()=>n});class i extends Error{constructor(e,t=400,r){super(e),this.name="AppError",this.status=t,this.details=r}}class n extends i{constructor(e="Unauthorized"){super(e,401),this.name="UnauthorizedError"}}class o extends i{constructor(e="Forbidden"){super(e,403),this.name="ForbiddenError"}}class s extends i{constructor(e="Resource not found"){super(e,404),this.name="NotFoundError"}}class d extends i{constructor(e="Conflict"){super(e,409),this.name="ConflictError"}}class a extends i{constructor(e="Validation failed",t){super(e,422,t),this.name="ValidationError"}}let c=e=>e instanceof i},9293:(e,t,r)=>{r.d(t,{X:()=>a});var i=r(87070),n=r(26033),o=r(47833),s=r(37848);let d=(e,t)=>i.NextResponse.json(e,t),a=async(e,t)=>{if("OPTIONS"===e.method)return h(new i.NextResponse(null,{status:204}),e);try{let r;let n=await t();return r=n instanceof i.NextResponse?n:d({data:n}),h(r,e)}catch(r){let t;if(r instanceof n.jm){let e=new o.p8("Validation failed",r.flatten());t=i.NextResponse.json({error:e.message,details:e.details},{status:e.status})}else(0,o.HC)(r)?t=i.NextResponse.json({error:r.message,details:r.details},{status:r.status}):(r instanceof Error?console.error(r):console.error("Unknown error",r),t=i.NextResponse.json({error:"Internal Server Error"},{status:500}));return h(t,e)}},c=e=>e.replace(/^"|"$/g,"").replace(/^'|'$/g,""),u=e=>c(e).replace(/\/$/,""),l=()=>s.O.CORS_ORIGIN?s.O.CORS_ORIGIN.split(",").map(e=>e.trim()).filter(Boolean).map(e=>u(e)):[],h=(e,t)=>{let r=l();if(!r.length)return e;let i=t?.headers.get("origin")??null,n=i?u(i):null,o=null;if(n&&r.includes(n)?o=n:n&&r.includes("*")?o=n:1===r.length&&(o=r[0]),!o&&r.length&&(o=r[0]),!o)return e;e.headers.set("Access-Control-Allow-Origin",o);let s=t?.headers.get("access-control-request-headers");return e.headers.set("Access-Control-Allow-Methods","GET,POST,PUT,PATCH,DELETE,OPTIONS"),e.headers.set("Access-Control-Allow-Headers",s&&s.length?s:"Content-Type,Authorization,Accept"),e.headers.set("Access-Control-Allow-Credentials","true"),e.headers.set("Access-Control-Max-Age","600"),e.headers.set("Vary","Origin"),e}},13538:(e,t,r)=>{r.d(t,{_:()=>n});var i=r(53524);let n=globalThis.prisma??new i.PrismaClient({log:["error"]})},5754:(e,t,r)=>{r.d(t,{o:()=>n});var i=r(9293);let n=({middlewares:e=[],controller:t})=>async(r,n)=>(0,i.X)(r,async()=>{let i=new URL(r.url),o={req:r,params:n?.params??{},query:i.searchParams};for(let t of e)o=await t(o);return t({...o,params:o.params})})},46526:(e,t,r)=>{r.d(t,{Dy:()=>u,J$:()=>c});var i=r(13538),n=r(47833);let o=async(e,t)=>{let r=await i._.district.findUnique({where:{id:t},include:{union:!0}});if(!r)throw new n.dR("District not found");if("UNION_ADMIN"===e.role||"DISTRICT_ADMIN"===e.role&&e.districtId===t)return r;throw new n.lY("Not allowed to access this district")},s=async(e,t)=>{let r=await i._.church.findUnique({where:{id:t},include:{district:{include:{union:!0}}}});if(!r)throw new n.dR("Church not found");if("UNION_ADMIN"===e.role||"DISTRICT_ADMIN"===e.role&&e.districtId===r.districtId||"CHURCH_ADMIN"===e.role&&e.churchId===t)return r;throw new n.lY("Not allowed to access this church")},d=(e,t)=>{let r="paramsData"in e&&e.paramsData&&"object"==typeof e.paramsData?e.paramsData[t]:void 0,i=e.params?.[t],n="queryData"in e&&e.queryData&&"object"==typeof e.queryData?e.queryData[t]:void 0,o="body"in e&&e.body&&"object"==typeof e.body?e.body[t]:void 0,s=r??i??n??o;return"string"==typeof s&&s.trim().length>0?s:void 0},a=(e,t,{optional:r}={})=>{let i=d(e,t);if(!i&&!r)throw new n.p8(`Missing or invalid identifier for ${t}`);return i},c=(e={})=>{let t=e.key??"districtId",r=e.optional??!1;return async e=>{if(!e.user)throw new n.yj("Authentication required");let i=a(e,t,{optional:r});if(!i)return{...e,district:e.district};let s=await o(e.user,i);return{...e,district:s}}},u=(e={})=>{let t=e.key??"churchId",r=e.optional??!1;return async e=>{if(!e.user)throw new n.yj("Authentication required");let i=a(e,t,{optional:r});if(!i)return{...e,church:e.church};let o=await s(e.user,i);return{...e,church:o}}}},9846:(e,t,r)=>{r.d(t,{k:()=>s});var i=r(47833),n=r(75145);let o=e=>{let t=e.headers.get("authorization")??e.headers.get("Authorization");if(!t)throw new i.yj("Missing Authorization header");let r=t.split(" ");if(2!==r.length||"Bearer"!==r[0])throw new i.yj("Malformed Authorization header");return r[1]},s=e=>async t=>{let r=o(t.req),s=await (0,n.Sk)(r);if(e&&!e.includes(s.role))throw new i.yj("Insufficient permissions");return{...t,user:s}}},38553:(e,t,r)=>{r.d(t,{m:()=>o});var i=r(26033),n=r(47833);let o=e=>async t=>{let r;try{r=await t.req.json()}catch(t){if(e.isOptional())r=void 0;else throw new n.p8("Invalid JSON body")}try{let i=e.parse(r);return{...t,body:i}}catch(e){if(e instanceof i.jm)throw new n.p8("Validation failed",e.flatten());throw e}}},92891:(e,t,r)=>{r.d(t,{d:()=>n});var i=r(13538);let n={findById:(e,t)=>i._.church.findUnique({...t??{},where:{id:e}}),findMany:e=>i._.church.findMany(e),create:e=>i._.church.create(e),update:e=>i._.church.update(e),delete:e=>i._.church.delete(e),count:e=>i._.church.count(e)}},65655:(e,t,r)=>{r.d(t,{e:()=>n});var i=r(13538);let n={findById:(e,t)=>i._.district.findUnique({where:{id:e},...t}),findMany:e=>i._.district.findMany(e),create:e=>i._.district.create(e),update:e=>i._.district.update(e),delete:e=>i._.district.delete(e),count:e=>i._.district.count(e)}},54164:(e,t,r)=>{r.d(t,{T:()=>n});var i=r(13538);let n={findById:(e,t)=>i._.user.findUnique({where:{id:e},...t??{}}),findByUsername:(e,t)=>i._.user.findUnique({where:{username:e},...t??{}}),findByEmail:(e,t)=>i._.user.findUnique({where:{email:e},...t??{}}),findByPhoneNumber:(e,t)=>i._.user.findUnique({where:{phoneNumber:e},...t??{}}),findByNationalId:(e,t)=>i._.user.findUnique({where:{nationalId:e},...t??{}}),findMany:e=>i._.user.findMany(e),count:e=>i._.user.count(e),create:e=>i._.user.create(e),update:e=>i._.user.update(e),delete:e=>i._.user.delete(e)}},6974:(e,t,r)=>{r.d(t,{B:()=>c,R:()=>d});var i=r(13538),n=r(47833);let o=e=>{let t=e.headers.get("x-forwarded-for")??e.headers.get("X-Forwarded-For");return t?t.split(",").map(e=>e.trim()).find(Boolean)??null:(e.headers.get("x-real-ip")??e.headers.get("X-Real-Ip")??e.headers.get("cf-connecting-ip")??e.headers.get("CF-Connecting-Ip"))||null},s=e=>e?`${e.firstName??""} ${e.lastName??""}`.trim()||(e.username??"Unknown"):"Unknown",d=async({req:e,user:t,action:r,details:n})=>{try{let d=o(e),a=e.headers.get("user-agent")??e.headers.get("User-Agent")??null;await i._.auditLog.create({data:{action:r,userName:s(t),userRole:t?.role??null,userId:t?.id??null,unionId:t?.unionId??null,districtId:t?.districtId??null,churchId:t?.churchId??null,ipAddress:d,userAgent:a,details:n??void 0}})}catch(e){console.error("Failed to record audit log",e)}},a=e=>{if(e)return{OR:[{userName:{contains:e,mode:"insensitive"}},{action:{contains:e,mode:"insensitive"}},{ipAddress:{contains:e,mode:"insensitive"}},{userAgent:{contains:e,mode:"insensitive"}}]}},c=async(e,{action:t,role:r,search:o,cursor:s,limit:d=25})=>{if("UNION_ADMIN"!==e.role)throw new n.lY("Only union admins can view audit logs");if(!e.unionId)throw new n.lY("Union context is required to view audit logs");let c={unionId:e.unionId,...t?{action:t}:{},...r?{userRole:r}:{}},u=a(o);u&&(c.AND=[...c.AND??[],u]);let l=Math.min(Math.max(d,1),100),h=await i._.auditLog.findMany({where:c,orderBy:{createdAt:"desc"},take:l+1,cursor:s?{id:s}:void 0,skip:s?1:0}),I=i._.auditLog.count({where:c}),w=i._.auditLog.groupBy({where:c,by:["action"],_count:{action:!0}}),f=i._.auditLog.groupBy({where:c,by:["userRole"],_count:{userRole:!0}}),[y,p,_]=await Promise.all([I,w,f]),m=null;if(h.length>l){let e=h.pop();m=e?e.id:null}return{logs:h,total:y,countsByAction:p.map(e=>({action:e.action,count:e._count.action})),countsByRole:_.map(e=>({role:e.userRole??null,count:e._count.userRole})),nextCursor:m}}},75145:(e,t,r)=>{r.d(t,{$N:()=>y,Cp:()=>p,Sk:()=>f,c_:()=>h});var i=r(42023),n=r.n(i),o=r(41482),s=r.n(o),d=r(53524),a=r(13538),c=r(37848),u=r(47833),l=r(54164);let h=async e=>{let t=await n().genSalt(10);return n().hash(e,t)},I=async(e,t)=>n().compare(e,t),w=e=>{let t={sub:e.id,role:e.role,unionId:e.unionId,districtId:e.districtId,churchId:e.churchId};return s().sign(t,c.O.JWT_SECRET,{expiresIn:43200})},f=async e=>{try{let t=s().verify(e,c.O.JWT_SECRET),r=await a._.user.findUnique({where:{id:t.sub}});if(!r)throw new u.yj("User not found");if(!r.isActive)throw new u.yj("Account disabled");return r}catch(e){if(e instanceof u.yj)throw e;throw new u.yj("Invalid token")}},y=async({email:e,phoneNumber:t,password:r})=>{let i=null;if(t){if(!(i=await l.T.findByPhoneNumber(t))||!i.isActive)throw new u.yj("Invalid credentials");if(i.role!==d.Role.MEMBER)throw new u.yj("Phone number login is restricted to members")}else if(e){if(!(i=await l.T.findByEmail(e))||!i.isActive)throw new u.yj("Invalid credentials");if(i.role===d.Role.MEMBER)throw new u.yj("Members must sign in with their phone number")}else throw new u.yj("Email or phone number is required");if(!await I(r,i.passwordHash))throw new u.yj("Invalid credentials");let n=w({id:i.id,role:i.role,unionId:i.unionId,districtId:i.districtId,churchId:i.churchId}),{passwordHash:o,...s}=i;return{token:n,user:s}},p=async(e,t)=>{if(!await I(t.currentPassword,e.passwordHash))throw new u.yj("Invalid current password");let r=await h(t.newPassword),{passwordHash:i,...n}=await a._.user.update({where:{id:e.id},data:{passwordHash:r}});return{user:n}}}};