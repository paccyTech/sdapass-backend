"use strict";exports.id=193,exports.ids=[193],exports.modules={11393:(e,t,r)=>{r.d(t,{_O:()=>h,EZ:()=>w,bz:()=>u});var n=r(53524),s=r(13538),i=r(15242),a=r(47833);let o=async e=>{if("UNION_ADMIN"!==e.role)throw new a.lY("Not allowed to view unions");return i.t.findMany({orderBy:{name:"asc"}})},d=async e=>{if("UNION_ADMIN"!==e.role)throw new a.lY("Not allowed to view union stats");if(!e.unionId)throw new a.lY("Union context is required");let t=e.unionId,r=new Date;r.setDate(r.getDate()-29);let n=new Date;n.setMonth(n.getMonth()-5),n.setDate(1);let[i,o,d,c,l,u,h,w,m,p]=await Promise.all([s._.user.count({where:{role:"MEMBER",church:{district:{unionId:t}}}}),s._.district.count({where:{unionId:t}}),s._.church.count({where:{district:{unionId:t}}}),s._.user.count({where:{role:"DISTRICT_ADMIN",district:{unionId:t}}}),s._.user.findMany({where:{role:"MEMBER",createdAt:{gte:r},church:{district:{unionId:t}}},select:{createdAt:!0}}),s._.attendanceRecord.findMany({where:{session:{church:{district:{unionId:t}},date:{gte:n}}},select:{session:{select:{date:!0}}}}),s._.user.findMany({where:{role:"MEMBER",church:{district:{unionId:t}}},orderBy:{createdAt:"desc"},take:5,select:{id:!0,firstName:!0,lastName:!0,createdAt:!0,church:{select:{name:!0}}}}),s._.attendanceRecord.findMany({where:{session:{church:{district:{unionId:t}}}},orderBy:{createdAt:"desc"},take:5,select:{id:!0,createdAt:!0,session:{select:{date:!0,church:{select:{name:!0}}}}}}),s._.church.findMany({where:{district:{unionId:t}},orderBy:{createdAt:"desc"},take:5,select:{id:!0,name:!0,createdAt:!0,district:{select:{name:!0}}}}),s._.district.findMany({where:{unionId:t},orderBy:{createdAt:"desc"},take:5,select:{id:!0,name:!0,createdAt:!0}})]),f=(()=>{if(0===l.length)return[];let e=new Map;for(let t of l){let r=t.createdAt.toISOString().split("T")[0];e.set(r,(e.get(r)??0)+1)}let t=Array.from(e.entries()).sort((e,t)=>e[0].localeCompare(t[0])),r=0;return t.map(([e,t])=>({date:e,count:r+=t}))})(),I=(()=>{if(0===u.length)return[];let e=new Map;for(let t of u){let r=new Date(t.session.date),n=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`;e.set(n,(e.get(n)??0)+1)}return Array.from(e.entries()).sort((e,t)=>e[0].localeCompare(t[0])).map(([e,t])=>({month:e,attendance:t}))})();return{totalMembers:i,totalDistricts:o,totalChurches:d,totalPastors:c,recentActivity:(()=>{let e=[];for(let t of h){let r=[t.firstName,t.lastName].filter(Boolean).join(" ").trim()||"Member";e.push({id:`member-${t.id}`,type:"member_added",description:`${r} joined ${t.church?.name??"the union"}`,timestamp:t.createdAt.toISOString()})}for(let t of w){let r=new Date(t.session.date).toLocaleDateString("en-US",{month:"short",day:"numeric"});e.push({id:`attendance-${t.id}`,type:"attendance_recorded",description:`Attendance recorded for ${t.session.church?.name??"a church"} (${r})`,timestamp:t.createdAt.toISOString()})}for(let t of m)e.push({id:`church-${t.id}`,type:"new_church",description:`Church ${t.name} added${t.district?.name?` in ${t.district.name}`:""}`,timestamp:t.createdAt.toISOString()});for(let t of p)e.push({id:`district-${t.id}`,type:"new_district",description:`District ${t.name} registered`,timestamp:t.createdAt.toISOString()});return e.sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime()).slice(0,8)})(),memberGrowth:f,attendanceTrends:I}},c=async(e,t)=>{if("UNION_ADMIN"!==e.role)throw new a.lY("Not allowed to create unions");try{return await i.t.create({data:{name:t.name,description:t.description??void 0}})}catch(e){if(e instanceof n.Prisma.PrismaClientKnownRequestError&&"P2002"===e.code)throw new a.AY("A union with this name already exists");throw e}};var l=r(6974);let u=async e=>({unions:await o(e.user)}),h=async e=>{if(!e.body)throw Error("Missing request body");let t=await c(e.user,e.body);return await (0,l.R)({req:e.req,user:e.user,action:"union.create",details:{unionId:t.id,name:t.name}}),{union:t}},w=async e=>({stats:await d(e.user)})},37848:(e,t,r)=>{r.d(t,{O:()=>a});let n=e=>{let t=process.env[e];if(!t)throw Error(`Missing required environment variable: ${e}`);return t},s="http://localhost:3000",i=(process.env.CORS_ORIGIN??s).split(",").map(e=>e.trim()).filter(Boolean),a={DATABASE_URL:n("DATABASE_URL"),JWT_SECRET:n("JWT_SECRET"),SMS_API_KEY:process.env.SMS_API_KEY??"",CORS_ORIGIN:process.env.CORS_ORIGIN??s,PRIMARY_ORIGIN:i[0]??s,TWILIO_ACCOUNT_SID:process.env.TWILIO_ACCOUNT_SID??"",TWILIO_AUTH_TOKEN:process.env.TWILIO_AUTH_TOKEN??"",TWILIO_FROM_NUMBER:process.env.TWILIO_FROM_NUMBER??"",GMAIL_USER:process.env.GMAIL_USER,GMAIL_APP_PASSWORD:process.env.GMAIL_APP_PASSWORD,GMAIL_FROM_NAME:process.env.GMAIL_FROM_NAME||"Umuganda SDA",SMTP_HOST:process.env.SMTP_HOST||"smtp.gmail.com",SMTP_PORT:process.env.SMTP_PORT||"587",SMTP_SECURE:process.env.SMTP_SECURE||"false"}},47833:(e,t,r)=>{r.d(t,{AY:()=>o,HC:()=>c,dR:()=>a,gz:()=>n,lY:()=>i,p8:()=>d,yj:()=>s});class n extends Error{constructor(e,t=400,r){super(e),this.name="AppError",this.status=t,this.details=r}}class s extends n{constructor(e="Unauthorized"){super(e,401),this.name="UnauthorizedError"}}class i extends n{constructor(e="Forbidden"){super(e,403),this.name="ForbiddenError"}}class a extends n{constructor(e="Resource not found"){super(e,404),this.name="NotFoundError"}}class o extends n{constructor(e="Conflict"){super(e,409),this.name="ConflictError"}}class d extends n{constructor(e="Validation failed",t){super(e,422,t),this.name="ValidationError"}}let c=e=>e instanceof n},9293:(e,t,r)=>{r.d(t,{X:()=>d});var n=r(87070),s=r(26033),i=r(47833),a=r(37848);let o=(e,t)=>n.NextResponse.json(e,t),d=async(e,t)=>{if("OPTIONS"===e.method)return h(new n.NextResponse(null,{status:204}),e);try{let r;let s=await t();return r=s instanceof n.NextResponse?s:o({data:s}),h(r,e)}catch(r){let t;if(r instanceof s.jm){let e=new i.p8("Validation failed",r.flatten());t=n.NextResponse.json({error:e.message,details:e.details},{status:e.status})}else(0,i.HC)(r)?t=n.NextResponse.json({error:r.message,details:r.details},{status:r.status}):(r instanceof Error?console.error(r):console.error("Unknown error",r),t=n.NextResponse.json({error:"Internal Server Error"},{status:500}));return h(t,e)}},c=e=>e.replace(/^"|"$/g,"").replace(/^'|'$/g,""),l=e=>c(e).replace(/\/$/,""),u=()=>a.O.CORS_ORIGIN?a.O.CORS_ORIGIN.split(",").map(e=>e.trim()).filter(Boolean).map(e=>l(e)):[],h=(e,t)=>{let r=u();if(!r.length)return e;let n=t?.headers.get("origin")??null,s=n?l(n):null,i=null;if(s&&r.includes(s)?i=s:s&&r.includes("*")?i=s:1===r.length&&(i=r[0]),!i&&r.length&&(i=r[0]),!i)return e;e.headers.set("Access-Control-Allow-Origin",i);let a=t?.headers.get("access-control-request-headers");return e.headers.set("Access-Control-Allow-Methods","GET,POST,PUT,PATCH,DELETE,OPTIONS"),e.headers.set("Access-Control-Allow-Headers",a&&a.length?a:"Content-Type,Authorization,Accept"),e.headers.set("Access-Control-Allow-Credentials","true"),e.headers.set("Access-Control-Max-Age","600"),e.headers.set("Vary","Origin"),e}},13538:(e,t,r)=>{r.d(t,{_:()=>s});var n=r(53524);let s=globalThis.prisma??new n.PrismaClient({log:["error"]})},5754:(e,t,r)=>{r.d(t,{o:()=>s});var n=r(9293);let s=({middlewares:e=[],controller:t})=>async(r,s)=>(0,n.X)(r,async()=>{let n=new URL(r.url),i={req:r,params:s?.params??{},query:n.searchParams};for(let t of e)i=await t(i);return t({...i,params:i.params})})},9846:(e,t,r)=>{r.d(t,{k:()=>a});var n=r(47833),s=r(75145);let i=e=>{let t=e.headers.get("authorization")??e.headers.get("Authorization");if(!t)throw new n.yj("Missing Authorization header");let r=t.split(" ");if(2!==r.length||"Bearer"!==r[0])throw new n.yj("Malformed Authorization header");return r[1]},a=e=>async t=>{let r=i(t.req),a=await (0,s.Sk)(r);if(e&&!e.includes(a.role))throw new n.yj("Insufficient permissions");return{...t,user:a}}},15242:(e,t,r)=>{r.d(t,{t:()=>s});var n=r(13538);let s={findById:(e,t)=>n._.union.findUnique({where:{id:e},...t??{}}),findMany:e=>n._.union.findMany(e),create:e=>n._.union.create(e)}},54164:(e,t,r)=>{r.d(t,{T:()=>s});var n=r(13538);let s={findById:(e,t)=>n._.user.findUnique({where:{id:e},...t??{}}),findByUsername:(e,t)=>n._.user.findUnique({where:{username:e},...t??{}}),findByEmail:(e,t)=>n._.user.findUnique({where:{email:e},...t??{}}),findByPhoneNumber:(e,t)=>n._.user.findUnique({where:{phoneNumber:e},...t??{}}),findByNationalId:(e,t)=>n._.user.findUnique({where:{nationalId:e},...t??{}}),findMany:e=>n._.user.findMany(e),count:e=>n._.user.count(e),create:e=>n._.user.create(e),update:e=>n._.user.update(e),delete:e=>n._.user.delete(e)}},6974:(e,t,r)=>{r.d(t,{B:()=>c,R:()=>o});var n=r(13538),s=r(47833);let i=e=>{let t=e.headers.get("x-forwarded-for")??e.headers.get("X-Forwarded-For");return t?t.split(",").map(e=>e.trim()).find(Boolean)??null:(e.headers.get("x-real-ip")??e.headers.get("X-Real-Ip")??e.headers.get("cf-connecting-ip")??e.headers.get("CF-Connecting-Ip"))||null},a=e=>e?`${e.firstName??""} ${e.lastName??""}`.trim()||(e.username??"Unknown"):"Unknown",o=async({req:e,user:t,action:r,details:s})=>{try{let o=i(e),d=e.headers.get("user-agent")??e.headers.get("User-Agent")??null;await n._.auditLog.create({data:{action:r,userName:a(t),userRole:t?.role??null,userId:t?.id??null,unionId:t?.unionId??null,districtId:t?.districtId??null,churchId:t?.churchId??null,ipAddress:o,userAgent:d,details:s??void 0}})}catch(e){console.error("Failed to record audit log",e)}},d=e=>{if(e)return{OR:[{userName:{contains:e,mode:"insensitive"}},{action:{contains:e,mode:"insensitive"}},{ipAddress:{contains:e,mode:"insensitive"}},{userAgent:{contains:e,mode:"insensitive"}}]}},c=async(e,{action:t,role:r,search:i,cursor:a,limit:o=25})=>{if("UNION_ADMIN"!==e.role)throw new s.lY("Only union admins can view audit logs");if(!e.unionId)throw new s.lY("Union context is required to view audit logs");let c={unionId:e.unionId,...t?{action:t}:{},...r?{userRole:r}:{}},l=d(i);l&&(c.AND=[...c.AND??[],l]);let u=Math.min(Math.max(o,1),100),h=await n._.auditLog.findMany({where:c,orderBy:{createdAt:"desc"},take:u+1,cursor:a?{id:a}:void 0,skip:a?1:0}),w=n._.auditLog.count({where:c}),m=n._.auditLog.groupBy({where:c,by:["action"],_count:{action:!0}}),p=n._.auditLog.groupBy({where:c,by:["userRole"],_count:{userRole:!0}}),[f,I,_]=await Promise.all([w,m,p]),y=null;if(h.length>u){let e=h.pop();y=e?e.id:null}return{logs:h,total:f,countsByAction:I.map(e=>({action:e.action,count:e._count.action})),countsByRole:_.map(e=>({role:e.userRole??null,count:e._count.userRole})),nextCursor:y}}},75145:(e,t,r)=>{r.d(t,{$N:()=>f,Cp:()=>I,Sk:()=>p,c_:()=>h});var n=r(42023),s=r.n(n),i=r(41482),a=r.n(i),o=r(53524),d=r(13538),c=r(37848),l=r(47833),u=r(54164);let h=async e=>{let t=await s().genSalt(10);return s().hash(e,t)},w=async(e,t)=>s().compare(e,t),m=e=>{let t={sub:e.id,role:e.role,unionId:e.unionId,districtId:e.districtId,churchId:e.churchId};return a().sign(t,c.O.JWT_SECRET,{expiresIn:43200})},p=async e=>{try{let t=a().verify(e,c.O.JWT_SECRET),r=await d._.user.findUnique({where:{id:t.sub}});if(!r)throw new l.yj("User not found");if(!r.isActive)throw new l.yj("Account disabled");return r}catch(e){if(e instanceof l.yj)throw e;throw new l.yj("Invalid token")}},f=async({email:e,phoneNumber:t,password:r})=>{let n=null;if(t){if(!(n=await u.T.findByPhoneNumber(t))||!n.isActive)throw new l.yj("Invalid credentials");if(n.role!==o.Role.MEMBER)throw new l.yj("Phone number login is restricted to members")}else if(e){if(!(n=await u.T.findByEmail(e))||!n.isActive)throw new l.yj("Invalid credentials");if(n.role===o.Role.MEMBER)throw new l.yj("Members must sign in with their phone number")}else throw new l.yj("Email or phone number is required");if(!await w(r,n.passwordHash))throw new l.yj("Invalid credentials");let s=m({id:n.id,role:n.role,unionId:n.unionId,districtId:n.districtId,churchId:n.churchId}),{passwordHash:i,...a}=n;return{token:s,user:a}},I=async(e,t)=>{if(!await w(t.currentPassword,e.passwordHash))throw new l.yj("Invalid current password");let r=await h(t.newPassword),{passwordHash:n,...s}=await d._.user.update({where:{id:e.id},data:{passwordHash:r}});return{user:s}}}};