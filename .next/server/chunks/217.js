"use strict";exports.id=217,exports.ids=[217],exports.modules={88217:(e,n,t)=>{t.d(n,{rI:()=>p,cK:()=>N,Fp:()=>U,dv:()=>b,sS:()=>M,YW:()=>g,M2:()=>_});var i=t(28633),a=t(13538),d=t(47833);let r={findById:(e,n)=>a._.umugandaEvent.findUnique({where:{id:e},...n??{}}),findMany:e=>a._.umugandaEvent.findMany(e),create:e=>a._.umugandaEvent.create(e),update:e=>a._.umugandaEvent.update(e),delete:e=>a._.umugandaEvent.delete(e)},o={findMany:e=>a._.umugandaEventAttendance.findMany(e),create:e=>a._.umugandaEventAttendance.create(e)},u={union:{select:{id:!0,name:!0}},createdBy:{select:{id:!0,firstName:!0,lastName:!0}},_count:{select:{attendance:!0}}},c=async e=>{if("UNION_ADMIN"===e.role){if(!e.unionId)throw new d.lY("No union assigned to this account");return e.unionId}if("DISTRICT_ADMIN"===e.role){if(!e.districtId)throw new d.lY("No district assigned to this account");let n=await a._.district.findUnique({where:{id:e.districtId},select:{unionId:!0}}),t=n?.unionId;if(!t)throw new d.lY("Unable to resolve union for this district");return t}if("CHURCH_ADMIN"===e.role){if(!e.churchId)throw new d.lY("No church assigned to this account");let n=await a._.church.findUnique({where:{id:e.churchId},select:{district:{select:{unionId:!0}}}}),t=n?.district.unionId;if(!t)throw new d.lY("Unable to resolve union for this church");return t}throw new d.lY("Not allowed to access Umuganda events")},s=async e=>{if("UNION_ADMIN"===e.role){if(!e.unionId)throw new d.lY("No union assigned to this account");return r.findMany({where:{unionId:e.unionId},include:u,orderBy:{date:"desc"}})}if("CHURCH_ADMIN"===e.role){if(!e.churchId)throw new d.lY("No church assigned to this account");let n=await a._.church.findUnique({where:{id:e.churchId},select:{district:{select:{unionId:!0}}}}),t=n?.district.unionId;if(!t)throw new d.lY("Unable to resolve union for this church");return r.findMany({where:{unionId:t},include:u,orderBy:{date:"desc"}})}if("DISTRICT_ADMIN"===e.role){if(!e.districtId)throw new d.lY("No district assigned to this account");let n=await a._.district.findUnique({where:{id:e.districtId},select:{unionId:!0}}),t=n?.unionId;if(!t)throw new d.lY("Unable to resolve union for this district");return r.findMany({where:{unionId:t},include:u,orderBy:{date:"desc"}})}throw new d.lY("Not allowed to view Umuganda events")},l=async(e,n)=>{if("UNION_ADMIN"!==e.role)throw new d.lY("Only union admins can create Umuganda events");if(!e.unionId)throw new d.lY("No union assigned to this account");return r.create({data:{unionId:e.unionId,date:n.date,theme:n.theme??null,location:n.location??null,createdById:e.id},include:u})},h=async(e,n)=>{let t=await c(e),i=await r.findById(n,{include:u});if(!i)throw new d.dR("Umuganda event not found");if(i.unionId!==t)throw new d.lY("Cannot access an event outside your union");return i},w=async(e,n,t)=>{if("UNION_ADMIN"!==e.role)throw new d.lY("Only union admins can update Umuganda events");if(!e.unionId)throw new d.lY("No union assigned to this account");let i=await r.findById(n,{select:{id:!0,unionId:!0}});if(!i)throw new d.dR("Umuganda event not found");if(i.unionId!==e.unionId)throw new d.lY("Cannot update an event outside your union");return r.update({where:{id:i.id},data:{date:t.date,theme:t.theme,location:t.location},include:u})},I=async(e,n)=>{if("UNION_ADMIN"!==e.role)throw new d.lY("Only union admins can delete Umuganda events");if(!e.unionId)throw new d.lY("No union assigned to this account");let t=await r.findById(n,{select:{id:!0,unionId:!0}});if(!t)throw new d.dR("Umuganda event not found");if(t.unionId!==e.unionId)throw new d.lY("Cannot delete an event outside your union");return await r.delete({where:{id:t.id}}),{success:!0}},m=async(e,n,t)=>{let i=await c(e),a=await r.findById(n,{select:{id:!0,unionId:!0}});if(!a)throw new d.dR("Umuganda event not found");if(a.unionId!==i)throw new d.lY("Cannot access an event outside your union");if("CHURCH_ADMIN"===e.role){if(!e.churchId)throw new d.lY("No church assigned to this account");return o.findMany({where:{eventId:a.id,churchId:e.churchId},orderBy:{checkedInAt:"desc"},include:{member:{select:{id:!0,firstName:!0,lastName:!0,nationalId:!0}},church:{select:{id:!0,name:!0}}}})}return o.findMany({where:{eventId:a.id,churchId:t?.churchId},orderBy:{checkedInAt:"desc"},include:{member:{select:{id:!0,firstName:!0,lastName:!0,nationalId:!0}},church:{select:{id:!0,name:!0}}}})},f=async e=>{let n=await a._.pass.findUnique({where:{token:e},select:{memberId:!0}});if(n?.memberId)return n.memberId;let t=await a._.memberPass.findUnique({where:{token:e},select:{memberId:!0}});if(t?.memberId)return t.memberId;throw new d.dR("Member QR token not found")},y=async(e,n)=>{if("CHURCH_ADMIN"!==e.role)throw new d.lY("Only church admins can record event attendance");if(!e.churchId)throw new d.lY("No church assigned to this account");let t=await r.findById(n.eventId,{select:{id:!0,unionId:!0,date:!0,theme:!0,location:!0}});if(!t)throw new d.dR("Umuganda event not found");let i=await a._.church.findUnique({where:{id:e.churchId},select:{id:!0,district:{select:{unionId:!0}}}}),u=i?.district.unionId;if(!u)throw new d.lY("Unable to resolve union for this church");if(t.unionId!==u)throw new d.lY("Cannot check in members for an event outside your union");let c=await f(n.token),s=await a._.user.findUnique({where:{id:c},select:{id:!0,role:!0,churchId:!0,firstName:!0,lastName:!0,nationalId:!0}});if(!s||"MEMBER"!==s.role)throw new d.dR("Member not found");if(s.churchId!==e.churchId)throw new d.lY("Member belongs to another church");try{return await o.create({data:{eventId:t.id,memberId:s.id,churchId:e.churchId},include:{event:{select:{id:!0,date:!0,theme:!0}},member:{select:{id:!0,firstName:!0,lastName:!0,nationalId:!0}},church:{select:{id:!0,name:!0}}}})}catch(e){if(e instanceof Prisma.PrismaClientKnownRequestError&&"P2002"===e.code)throw new d.AY("Attendance already recorded for this member");throw e}};var v=t(6974);let g=async e=>({events:await s(e.user)}),N=async e=>{if(!e.body)throw new d.p8("Missing request body");let n=(0,i.Z)(e.body.date);if(Number.isNaN(n.getTime()))throw new d.p8("Invalid event date");let t={date:n,theme:e.body.theme,location:e.body.location},a=await l(e.user,t);return await (0,v.R)({req:e.req,user:e.user,action:"umuganda_event.create",details:{eventId:a.id,unionId:a.unionId,date:a.date.toISOString()}}),{event:a}},b=async e=>({event:await h(e.user,e.paramsData.eventId)}),_=async e=>{let n;if(!e.body)throw new d.p8("Missing request body");if("string"==typeof e.body.date){let t=(0,i.Z)(e.body.date);if(Number.isNaN(t.getTime()))throw new d.p8("Invalid event date");n=t}let t={date:n,theme:e.body.theme,location:e.body.location},a=await w(e.user,e.paramsData.eventId,t);return await (0,v.R)({req:e.req,user:e.user,action:"umuganda_event.update",details:{eventId:a.id,unionId:a.unionId}}),{event:a}},U=async e=>{let n=await I(e.user,e.paramsData.eventId);return await (0,v.R)({req:e.req,user:e.user,action:"umuganda_event.delete",details:{eventId:e.paramsData.eventId}}),n},p=async e=>{if(!e.body)throw new d.p8("Missing request body");let n={eventId:e.paramsData.eventId,token:e.body.token},t=await y(e.user,n);return await (0,v.R)({req:e.req,user:e.user,action:"umuganda_event.check_in",details:{eventId:n.eventId,attendanceId:t.id,memberId:t.memberId,churchId:t.churchId}}),{attendance:t}},M=async e=>({attendance:await m(e.user,e.paramsData.eventId,{churchId:e.queryData.churchId})})},6974:(e,n,t)=>{t.d(n,{B:()=>c,R:()=>o});var i=t(13538),a=t(47833);let d=e=>{let n=e.headers.get("x-forwarded-for")??e.headers.get("X-Forwarded-For");return n?n.split(",").map(e=>e.trim()).find(Boolean)??null:(e.headers.get("x-real-ip")??e.headers.get("X-Real-Ip")??e.headers.get("cf-connecting-ip")??e.headers.get("CF-Connecting-Ip"))||null},r=e=>e?`${e.firstName??""} ${e.lastName??""}`.trim()||(e.username??"Unknown"):"Unknown",o=async({req:e,user:n,action:t,details:a})=>{try{let o=d(e),u=e.headers.get("user-agent")??e.headers.get("User-Agent")??null;await i._.auditLog.create({data:{action:t,userName:r(n),userRole:n?.role??null,userId:n?.id??null,unionId:n?.unionId??null,districtId:n?.districtId??null,churchId:n?.churchId??null,ipAddress:o,userAgent:u,details:a??void 0}})}catch(e){console.error("Failed to record audit log",e)}},u=e=>{if(e)return{OR:[{userName:{contains:e,mode:"insensitive"}},{action:{contains:e,mode:"insensitive"}},{ipAddress:{contains:e,mode:"insensitive"}},{userAgent:{contains:e,mode:"insensitive"}}]}},c=async(e,{action:n,role:t,search:d,cursor:r,limit:o=25})=>{if("UNION_ADMIN"!==e.role)throw new a.lY("Only union admins can view audit logs");if(!e.unionId)throw new a.lY("Union context is required to view audit logs");let c={unionId:e.unionId,...n?{action:n}:{},...t?{userRole:t}:{}},s=u(d);s&&(c.AND=[...c.AND??[],s]);let l=Math.min(Math.max(o,1),100),h=await i._.auditLog.findMany({where:c,orderBy:{createdAt:"desc"},take:l+1,cursor:r?{id:r}:void 0,skip:r?1:0}),w=i._.auditLog.count({where:c}),I=i._.auditLog.groupBy({where:c,by:["action"],_count:{action:!0}}),m=i._.auditLog.groupBy({where:c,by:["userRole"],_count:{userRole:!0}}),[f,y,v]=await Promise.all([w,I,m]),g=null;if(h.length>l){let e=h.pop();g=e?e.id:null}return{logs:h,total:f,countsByAction:y.map(e=>({action:e.action,count:e._count.action})),countsByRole:v.map(e=>({role:e.userRole??null,count:e._count.userRole})),nextCursor:g}}}};