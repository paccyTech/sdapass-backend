"use strict";exports.id=263,exports.ids=[263],exports.modules={9867:(e,t,n)=>{n.d(t,{Iu:()=>h,Aw:()=>p,p7:()=>y,zF:()=>I,fg:()=>f});var r=n(65655),i=n(15242),s=n(47833);let o={union:{select:{id:!0,name:!0}},churches:{select:{id:!0,name:!0}}},a=async(e,t={})=>{if("UNION_ADMIN"===e.role)return r.e.findMany({where:t.unionId?{unionId:t.unionId}:void 0,include:o,orderBy:{name:"asc"}});if("DISTRICT_ADMIN"===e.role){if(!e.districtId)throw new s.lY("No district assigned to this account");let t=await r.e.findById(e.districtId,{include:o});if(!t)throw new s.dR("District not found");return[t]}throw new s.lY("Not allowed to view districts")},d=async(e,t)=>{if("UNION_ADMIN"!==e.role)throw new s.lY("Only union administrators can create districts");if(!await i.t.findById(t.unionId))throw new s.dR("Union not found");return await r.e.create({data:{unionId:t.unionId,name:t.name,location:t.location},include:o})},l=async(e,t)=>{let n=await r.e.findById(t,{include:o});if(!n)throw new s.dR("District not found");if("UNION_ADMIN"===e.role){if(e.unionId&&n.unionId!==e.unionId)throw new s.lY("District does not belong to your union");return n}if("DISTRICT_ADMIN"===e.role){if(!e.districtId||e.districtId!==t)throw new s.lY("Not allowed to view this district");return n}throw new s.lY("Not allowed to view districts")},u=async(e,t,n)=>{if("UNION_ADMIN"!==e.role)throw new s.lY("Only union administrators can update districts");let a=await r.e.findById(t,{include:o});if(!a)throw new s.dR("District not found");if(e.unionId&&a.unionId!==e.unionId)throw new s.lY("District does not belong to your union");let d=a.unionId;if(void 0!==n.unionId){if(e.unionId&&n.unionId!==e.unionId)throw new s.lY("Cannot move district outside your union");let t=await i.t.findById(n.unionId);if(!t)throw new s.dR("Union not found");d=t.id}return await r.e.update({where:{id:t},data:{unionId:d,name:n.name,location:n.location},include:o})},c=async(e,t)=>{if("UNION_ADMIN"!==e.role)throw new s.lY("Only union administrators can delete districts");let n=await r.e.findById(t);if(!n)throw new s.dR("District not found");if(e.unionId&&n.unionId!==e.unionId)throw new s.lY("District does not belong to your union");await r.e.delete({where:{id:t}})};var w=n(6974);let I=async e=>({districts:await a(e.user,e.queryData??{})}),h=async e=>{if(!e.body)throw Error("Missing request body");let t=await d(e.user,e.body);return await (0,w.R)({req:e.req,user:e.user,action:"district.create",details:{districtId:t.id,name:t.name,unionId:t.unionId,location:t.location}}),{district:t}},f=async e=>{if(!e.params.districtId)throw Error("District id is required");let t=e.body??{},n=await u(e.user,e.params.districtId,t),r={districtId:n.id,name:n.name,unionId:n.unionId,changes:t};return await (0,w.R)({req:e.req,user:e.user,action:"district.update",details:r}),{district:n}},p=async e=>{if(!e.params.districtId)throw Error("District id is required");return await c(e.user,e.params.districtId),await (0,w.R)({req:e.req,user:e.user,action:"district.delete",details:{districtId:e.params.districtId}}),{success:!0}},y=async e=>{if(!e.params.districtId)throw Error("District id is required");return{district:await l(e.user,e.params.districtId)}}},37848:(e,t,n)=>{n.d(t,{O:()=>o});let r=e=>{let t=process.env[e];if(!t)throw Error(`Missing required environment variable: ${e}`);return t},i="http://localhost:3000",s=(process.env.CORS_ORIGIN??i).split(",").map(e=>e.trim()).filter(Boolean),o={DATABASE_URL:r("DATABASE_URL"),JWT_SECRET:r("JWT_SECRET"),SMS_API_KEY:process.env.SMS_API_KEY??"",CORS_ORIGIN:process.env.CORS_ORIGIN??i,PRIMARY_ORIGIN:s[0]??i,TWILIO_ACCOUNT_SID:process.env.TWILIO_ACCOUNT_SID??"",TWILIO_AUTH_TOKEN:process.env.TWILIO_AUTH_TOKEN??"",TWILIO_FROM_NUMBER:process.env.TWILIO_FROM_NUMBER??"",GMAIL_USER:process.env.GMAIL_USER,GMAIL_APP_PASSWORD:process.env.GMAIL_APP_PASSWORD,GMAIL_FROM_NAME:process.env.GMAIL_FROM_NAME||"Umuganda SDA",SMTP_HOST:process.env.SMTP_HOST||"smtp.gmail.com",SMTP_PORT:process.env.SMTP_PORT||"587",SMTP_SECURE:process.env.SMTP_SECURE||"false"}},47833:(e,t,n)=>{n.d(t,{AY:()=>a,HC:()=>l,dR:()=>o,gz:()=>r,lY:()=>s,p8:()=>d,yj:()=>i});class r extends Error{constructor(e,t=400,n){super(e),this.name="AppError",this.status=t,this.details=n}}class i extends r{constructor(e="Unauthorized"){super(e,401),this.name="UnauthorizedError"}}class s extends r{constructor(e="Forbidden"){super(e,403),this.name="ForbiddenError"}}class o extends r{constructor(e="Resource not found"){super(e,404),this.name="NotFoundError"}}class a extends r{constructor(e="Conflict"){super(e,409),this.name="ConflictError"}}class d extends r{constructor(e="Validation failed",t){super(e,422,t),this.name="ValidationError"}}let l=e=>e instanceof r},9293:(e,t,n)=>{n.d(t,{X:()=>d});var r=n(87070),i=n(26033),s=n(47833),o=n(37848);let a=(e,t)=>r.NextResponse.json(e,t),d=async(e,t)=>{if("OPTIONS"===e.method)return w(new r.NextResponse(null,{status:204}),e);try{let n;let i=await t();return n=i instanceof r.NextResponse?i:a({data:i}),w(n,e)}catch(n){let t;if(n instanceof i.jm){let e=new s.p8("Validation failed",n.flatten());t=r.NextResponse.json({error:e.message,details:e.details},{status:e.status})}else(0,s.HC)(n)?t=r.NextResponse.json({error:n.message,details:n.details},{status:n.status}):(n instanceof Error?console.error(n):console.error("Unknown error",n),t=r.NextResponse.json({error:"Internal Server Error"},{status:500}));return w(t,e)}},l=e=>e.replace(/^"|"$/g,"").replace(/^'|'$/g,""),u=e=>l(e).replace(/\/$/,""),c=()=>o.O.CORS_ORIGIN?o.O.CORS_ORIGIN.split(",").map(e=>e.trim()).filter(Boolean).map(e=>u(e)):[],w=(e,t)=>{let n=c();if(!n.length)return e;let r=t?.headers.get("origin")??null,i=r?u(r):null,s=null;if(i&&n.includes(i)?s=i:i&&n.includes("*")?s=i:1===n.length&&(s=n[0]),!s&&n.length&&(s=n[0]),!s)return e;e.headers.set("Access-Control-Allow-Origin",s);let o=t?.headers.get("access-control-request-headers");return e.headers.set("Access-Control-Allow-Methods","GET,POST,PUT,PATCH,DELETE,OPTIONS"),e.headers.set("Access-Control-Allow-Headers",o&&o.length?o:"Content-Type,Authorization,Accept"),e.headers.set("Access-Control-Allow-Credentials","true"),e.headers.set("Access-Control-Max-Age","600"),e.headers.set("Vary","Origin"),e}},13538:(e,t,n)=>{n.d(t,{_:()=>i});var r=n(53524);let i=globalThis.prisma??new r.PrismaClient({log:["error"]})},5754:(e,t,n)=>{n.d(t,{o:()=>i});var r=n(9293);let i=({middlewares:e=[],controller:t})=>async(n,i)=>(0,r.X)(n,async()=>{let r=new URL(n.url),s={req:n,params:i?.params??{},query:r.searchParams};for(let t of e)s=await t(s);return t({...s,params:s.params})})},9846:(e,t,n)=>{n.d(t,{k:()=>o});var r=n(47833),i=n(75145);let s=e=>{let t=e.headers.get("authorization")??e.headers.get("Authorization");if(!t)throw new r.yj("Missing Authorization header");let n=t.split(" ");if(2!==n.length||"Bearer"!==n[0])throw new r.yj("Malformed Authorization header");return n[1]},o=e=>async t=>{let n=s(t.req),o=await (0,i.Sk)(n);if(e&&!e.includes(o.role))throw new r.yj("Insufficient permissions");return{...t,user:o}}},38553:(e,t,n)=>{n.d(t,{m:()=>s});var r=n(26033),i=n(47833);let s=e=>async t=>{let n;try{n=await t.req.json()}catch(t){if(e.isOptional())n=void 0;else throw new i.p8("Invalid JSON body")}try{let r=e.parse(n);return{...t,body:r}}catch(e){if(e instanceof r.jm)throw new i.p8("Validation failed",e.flatten());throw e}}},65655:(e,t,n)=>{n.d(t,{e:()=>i});var r=n(13538);let i={findById:(e,t)=>r._.district.findUnique({where:{id:e},...t}),findMany:e=>r._.district.findMany(e),create:e=>r._.district.create(e),update:e=>r._.district.update(e),delete:e=>r._.district.delete(e),count:e=>r._.district.count(e)}},15242:(e,t,n)=>{n.d(t,{t:()=>i});var r=n(13538);let i={findById:(e,t)=>r._.union.findUnique({where:{id:e},...t??{}}),findMany:e=>r._.union.findMany(e),create:e=>r._.union.create(e)}},54164:(e,t,n)=>{n.d(t,{T:()=>i});var r=n(13538);let i={findById:(e,t)=>r._.user.findUnique({where:{id:e},...t??{}}),findByUsername:(e,t)=>r._.user.findUnique({where:{username:e},...t??{}}),findByEmail:(e,t)=>r._.user.findUnique({where:{email:e},...t??{}}),findByPhoneNumber:(e,t)=>r._.user.findUnique({where:{phoneNumber:e},...t??{}}),findByNationalId:(e,t)=>r._.user.findUnique({where:{nationalId:e},...t??{}}),findMany:e=>r._.user.findMany(e),count:e=>r._.user.count(e),create:e=>r._.user.create(e),update:e=>r._.user.update(e),delete:e=>r._.user.delete(e)}},6974:(e,t,n)=>{n.d(t,{B:()=>l,R:()=>a});var r=n(13538),i=n(47833);let s=e=>{let t=e.headers.get("x-forwarded-for")??e.headers.get("X-Forwarded-For");return t?t.split(",").map(e=>e.trim()).find(Boolean)??null:(e.headers.get("x-real-ip")??e.headers.get("X-Real-Ip")??e.headers.get("cf-connecting-ip")??e.headers.get("CF-Connecting-Ip"))||null},o=e=>e?`${e.firstName??""} ${e.lastName??""}`.trim()||(e.username??"Unknown"):"Unknown",a=async({req:e,user:t,action:n,details:i})=>{try{let a=s(e),d=e.headers.get("user-agent")??e.headers.get("User-Agent")??null;await r._.auditLog.create({data:{action:n,userName:o(t),userRole:t?.role??null,userId:t?.id??null,unionId:t?.unionId??null,districtId:t?.districtId??null,churchId:t?.churchId??null,ipAddress:a,userAgent:d,details:i??void 0}})}catch(e){console.error("Failed to record audit log",e)}},d=e=>{if(e)return{OR:[{userName:{contains:e,mode:"insensitive"}},{action:{contains:e,mode:"insensitive"}},{ipAddress:{contains:e,mode:"insensitive"}},{userAgent:{contains:e,mode:"insensitive"}}]}},l=async(e,{action:t,role:n,search:s,cursor:o,limit:a=25})=>{if("UNION_ADMIN"!==e.role)throw new i.lY("Only union admins can view audit logs");if(!e.unionId)throw new i.lY("Union context is required to view audit logs");let l={unionId:e.unionId,...t?{action:t}:{},...n?{userRole:n}:{}},u=d(s);u&&(l.AND=[...l.AND??[],u]);let c=Math.min(Math.max(a,1),100),w=await r._.auditLog.findMany({where:l,orderBy:{createdAt:"desc"},take:c+1,cursor:o?{id:o}:void 0,skip:o?1:0}),I=r._.auditLog.count({where:l}),h=r._.auditLog.groupBy({where:l,by:["action"],_count:{action:!0}}),f=r._.auditLog.groupBy({where:l,by:["userRole"],_count:{userRole:!0}}),[p,y,m]=await Promise.all([I,h,f]),_=null;if(w.length>c){let e=w.pop();_=e?e.id:null}return{logs:w,total:p,countsByAction:y.map(e=>({action:e.action,count:e._count.action})),countsByRole:m.map(e=>({role:e.userRole??null,count:e._count.userRole})),nextCursor:_}}},75145:(e,t,n)=>{n.d(t,{$N:()=>p,Cp:()=>y,Sk:()=>f,c_:()=>w});var r=n(42023),i=n.n(r),s=n(41482),o=n.n(s),a=n(53524),d=n(13538),l=n(37848),u=n(47833),c=n(54164);let w=async e=>{let t=await i().genSalt(10);return i().hash(e,t)},I=async(e,t)=>i().compare(e,t),h=e=>{let t={sub:e.id,role:e.role,unionId:e.unionId,districtId:e.districtId,churchId:e.churchId};return o().sign(t,l.O.JWT_SECRET,{expiresIn:43200})},f=async e=>{try{let t=o().verify(e,l.O.JWT_SECRET),n=await d._.user.findUnique({where:{id:t.sub}});if(!n)throw new u.yj("User not found");if(!n.isActive)throw new u.yj("Account disabled");return n}catch(e){if(e instanceof u.yj)throw e;throw new u.yj("Invalid token")}},p=async({email:e,phoneNumber:t,password:n})=>{let r=null;if(t){if(!(r=await c.T.findByPhoneNumber(t))||!r.isActive)throw new u.yj("Invalid credentials");if(r.role!==a.Role.MEMBER)throw new u.yj("Phone number login is restricted to members")}else if(e){if(!(r=await c.T.findByEmail(e))||!r.isActive)throw new u.yj("Invalid credentials");if(r.role===a.Role.MEMBER)throw new u.yj("Members must sign in with their phone number")}else throw new u.yj("Email or phone number is required");if(!await I(n,r.passwordHash))throw new u.yj("Invalid credentials");let i=h({id:r.id,role:r.role,unionId:r.unionId,districtId:r.districtId,churchId:r.churchId}),{passwordHash:s,...o}=r;return{token:i,user:o}},y=async(e,t)=>{if(!await I(t.currentPassword,e.passwordHash))throw new u.yj("Invalid current password");let n=await w(t.newPassword),{passwordHash:r,...i}=await d._.user.update({where:{id:e.id},data:{passwordHash:n}});return{user:i}}}};