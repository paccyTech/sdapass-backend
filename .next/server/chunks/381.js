"use strict";exports.id=381,exports.ids=[381],exports.modules={20471:(e,t,r)=>{r.d(t,{LS:()=>h,Rl:()=>v,yp:()=>f});var o=r(53524),a=r(92048),i=r(55245),s=r(55315),n=r.n(s),l=r(6271),d=r(37848);console.log("Email Config:",{hasUser:!!d.O.GMAIL_USER,hasPass:!!d.O.GMAIL_APP_PASSWORD,smtpHost:d.O.SMTP_HOST,smtpPort:d.O.SMTP_PORT,smtpSecure:d.O.SMTP_SECURE});let c=[],p=d.O.GMAIL_USER&&d.O.GMAIL_APP_PASSWORD?i.createTransport({host:d.O.SMTP_HOST||"smtp.gmail.com",port:d.O.SMTP_PORT?parseInt(d.O.SMTP_PORT):587,secure:"true"===d.O.SMTP_SECURE,auth:{user:d.O.GMAIL_USER,pass:d.O.GMAIL_APP_PASSWORD},tls:{rejectUnauthorized:!1}}):null;p?p.verify(function(e){e?console.error("SMTP connection error:",e):console.log("SMTP server is ready to take our messages")}):(console.log("Running in development mode without email configuration"),console.log("Emails will be logged to the console instead of being sent"));let u=async({to:e,subject:t,text:r,html:o,attachments:a})=>{if(!p)return console.warn("Email not sent - no email configuration. Storing in dev email store."),c.push({to:e,subject:t,text:r,attachments:a}),console.log("Dev Email Store:",c),{success:!0,devMode:!0,stored:!0};let i=`"${d.O.GMAIL_FROM_NAME||"Umuganda SDA"}" <${d.O.GMAIL_USER}>`;try{let s=await p.sendMail({from:i,to:e,subject:t,text:r,html:o||r,attachments:a});return console.log("Email sent:",s.messageId),{success:!0,messageId:s.messageId}}catch(e){throw console.error("Error sending email:",e),Error("Failed to send email")}},h=async(e,t,r)=>{let o=`${d.O.PRIMARY_ORIGIN||"http://localhost:3000"}/reset-password/confirm?token=${encodeURIComponent(t)}`;return u({to:e,subject:"Password Reset Request",text:`
    You have requested to reset your password for the Umuganda SDA platform.
    
    Please click the following link to reset your password (valid for ${r} minutes):
    ${o}
    
    If you did not request this, please ignore this email.
  `,html:`
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
      <h2>Password Reset Request</h2>
      <p>You have requested to reset your password for the Umuganda SDA platform.</p>
      <p>Please click the button below to reset your password (valid for ${r} minutes):</p>
      <div style="margin: 25px 0;">
        <a href="${o}" 
           style="display: inline-block; padding: 10px 20px; background-color: #2d3748; color: white; 
                  text-decoration: none; border-radius: 5px; font-weight: bold;">
          Reset Password
        </a>
      </div>
      <p>Or copy and paste this link into your browser:</p>
      <p style="word-break: break-all; color: #3182ce;">${o}</p>
      <p>If you did not request this, please ignore this email.</p>
      <hr style="border: none; border-top: 1px solid #e2e8f0; margin: 20px 0;">
      <p style="font-size: 0.875rem; color: #718096;">
        This is an automated message, please do not reply directly to this email.
      </p>
    </div>
  `})},m=e=>{switch(e){case o.Role.UNION_ADMIN:return"Union Administrator";case o.Role.DISTRICT_ADMIN:return"District Pastor";case o.Role.CHURCH_ADMIN:return"Church Administrator";default:return"Umuganda SDA account"}},g=e=>(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),f=async({to:e,role:t,firstName:r,username:o,password:a})=>{let i=`${d.O.PRIMARY_ORIGIN||"http://localhost:3000"}/login`,s=m(t),n=r?.trim()||"there";return u({to:e,subject:`Your ${s} credentials`,text:`Hello ${n},

An Umuganda SDA ${s.toLowerCase()} account has been created for you.
Visit ${i} and sign in with:
Username: ${o}
Temporary password: ${a}

For security, please sign in and change this password immediately.

If you did not expect this email, contact your administrator.`,html:`
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
      <p style="font-size: 1rem;">Hello ${n},</p>
      <p>An Umuganda SDA ${s.toLowerCase()} account has been created for you.</p>
      <p style="margin-bottom: 12px;">Use the credentials below to sign in:</p>
      <div style="background: #f7fafc; padding: 16px; border-radius: 8px; line-height: 1.6;">
        <div><strong>Username:</strong> ${o}</div>
        <div><strong>Temporary password:</strong> ${a}</div>
      </div>
      <p style="margin: 16px 0;">Visit <a href="${i}" style="color: #2b6cb0;">${i}</a> to sign in and please change this password immediately after logging in.</p>
      <p style="color: #4a5568; font-size: 0.95rem;">If you did not expect this email, contact your administrator.</p>
    </div>
  `})},y=n().resolve(process.cwd(),"src/assets/sda-logo.png"),w=null,x=async()=>{if(w)return w;try{w=await a.promises.readFile(y)}catch(e){console.error("Could not load SDA logo for PDF",e),w=null}return w},b=e=>{let t=parseInt(e.replace("#",""),16);return(0,l.rgb)((t>>16&255)/255,(t>>8&255)/255,(255&t)/255)},I=async({firstName:e,lastName:t,phoneNumber:r,nationalId:o,churchName:a,qrPayload:i,passToken:s})=>{let n=await l.PDFDocument.create(),d=b("#020617"),c=b("#0f172a"),p=b("#1e293b"),u=b("#f8fafc"),h=b("#1e293b"),m=b("#94a3b8"),g=b("#475569"),f=b("#64748b"),y=b("#1e3a8a"),w=b("#101c3a"),I=b("#12274f"),v=(0,l.rgb)(1,1,1),A=await n.embedFont(l.StandardFonts.HelveticaBold),R=await n.embedFont(l.StandardFonts.Helvetica),S=null;try{let e=await x();e&&(S=await n.embedPng(e))}catch(e){console.error("Could not embed SDA logo",e)}let T=(e,t,{x:r,y:o,maxWidth:a,lineHeight:i,font:s,size:n,color:l})=>{let d=t.split(/\s+/),c=[],p="";return d.forEach(e=>{let t=p?`${p} ${e}`:e;s.widthOfTextAtSize(t,n)<=a?p=t:(p&&c.push(p),p=e)}),p&&c.push(p),c.forEach((t,a)=>{e.drawText(t,{x:r,y:o-a*i,size:n,font:s,color:l})}),o-(c.length-1)*i},O=`${(e?.[0]??"").toUpperCase()}${(t?.[0]??"").toUpperCase()}`.trim()||"RM",_=`${e??""} ${t??""}`.trim()||"Umuganda Member",P=a??"Church assignment pending",U=r||"Not provided",M=i.startsWith("data:image")?i.split(",")[1]:null,E=async e=>{e.drawRectangle({x:0,y:0,width:672,height:432,color:d}),e.drawRectangle({x:48,y:48,width:576,height:336,color:u,borderColor:p,borderWidth:1.2,opacity:.98}),e.drawRectangle({x:48,y:304,width:576,height:80,color:c});let t=84;if(S){let r=S.width/S.height*44;e.drawImage(S,{x:80,y:330,width:r,height:44}),t+=r+24}e.drawText("RWANDA UNION MISSION",{x:t,y:366,size:20,font:A,color:v}),e.drawText("OFFICIAL UMUGANDA PASS",{x:t,y:342,size:12,font:R,color:m});e.drawCircle({x:128,y:230,size:40,color:y});let r=A.widthOfTextAtSize(O,22);e.drawText(O,{x:128-r/2,y:222,size:22,font:A,color:v});let a=192;e.drawText(_,{x:a,y:258,size:20,font:A,color:h}),e.drawText("Community Service Member",{x:a,y:236,size:12,font:R,color:f});let i=204;[{label:"Church",value:P},{label:"National ID",value:o||"Not provided"},{label:"Phone number",value:U},{label:"Member pass",value:s}].forEach(({label:t,value:r},o)=>{let a=i-30*o;e.drawText(t.toUpperCase(),{x:88,y:a,size:10,font:A,color:f}),e.drawText(r,{x:88,y:a-16,size:13,font:R,color:h})});if(e.drawRectangle({x:386,y:116,width:190,height:190,color:v,borderColor:m,borderWidth:1,opacity:.92}),M)try{let t=Buffer.from(M,"base64"),r=await n.embedPng(t);e.drawImage(r,{x:410,y:152,width:142,height:142})}catch(t){console.error("Unable to embed QR code in pass PDF",t),e.drawText("QR unavailable",{x:422,y:211,size:12,font:R,color:m})}else e.drawText("QR unavailable",{x:422,y:211,size:12,font:R,color:m});e.drawText("OFFICIAL SCAN",{x:440,y:132,size:11,font:A,color:f}),T(e,"Official Rwanda Union Mission pass. Present with your national ID on Umuganda day. Non-transferable — report misuse, loss, or damage immediately.",{x:88,y:92,maxWidth:496,lineHeight:12,font:R,size:10,color:g})},C=n.addPage([672,432]);await E(C),(e=>{e.drawRectangle({x:0,y:0,width:672,height:432,color:d}),e.drawRectangle({x:48,y:48,width:576,height:336,color:w,borderColor:p,borderWidth:1.2}),e.drawRectangle({x:48,y:312,width:576,height:72,color:c});let t=84;if(S){let r=S.width/S.height*40;e.drawImage(S,{x:80,y:332,width:r,height:40}),t+=r+24}e.drawText("RWANDA UNION MISSION",{x:t,y:360,size:18,font:A,color:v}),e.drawText("Community Service Identification",{x:88,y:288,size:14,font:A,color:v}),e.drawText("Member Obligations & Verification",{x:88,y:268,size:11,font:R,color:f});e.drawRectangle({x:88,y:76,width:228,height:140,color:I}),e.drawRectangle({x:356,y:76,width:228,height:140,color:I}),e.drawText("Usage Guidelines",{x:96,y:192,size:12,font:A,color:v}),T(e,"Carry this pass with your national ID during Umuganda activities. Provide both documents when verification is requested. Keep the pass clean and legible. Damaged credentials must be returned to your church administrator for replacement.",{x:96,y:172,maxWidth:208,lineHeight:12,font:R,size:10,color:m});e.drawText("Compliance Notice",{x:364,y:192,size:12,font:A,color:v}),T(e,"Property of the Seventh-day Adventist Church – Rwanda Union Mission. Any alteration, duplication, lending, or misuse voids this pass and may result in disciplinary or legal action. Update your contact details with your church administrator within 48 hours of any change.",{x:364,y:172,maxWidth:208,lineHeight:12,font:R,size:10,color:m});e.drawRectangle({x:88,y:112,width:496,height:96,color:I}),e.drawText("Union Contact",{x:100,y:182,size:12,font:A,color:v}),e.drawText("KN 123 St, Kigali \xb7 Tel +250 788 000 000",{x:100,y:158,size:11,font:R,color:m}),e.drawText("support@umuganda.rw \xb7 Report lost or stolen passes immediately.",{x:100,y:138,size:11,font:R,color:m}),e.drawText("Keep this credential with your national ID. Return the pass within 7 days if you transfer to another church.",{x:100,y:128,size:10,font:R,color:m})})(n.addPage([672,432]));let N=await n.save();return Buffer.from(N)},v=async({to:e,firstName:t,lastName:r,phoneNumber:o,password:a,nationalId:i,churchName:s,loginUrl:n,passUrl:l,qrPayload:d,passToken:c})=>{let p;let h=t?.trim()?t.trim():"there",m=[`Hello ${h},`,"","Welcome to the Umuganda SDA community service platform.","","Log in using the member portal:",`Phone number: ${o}`,`Password: ${a}`,`Link: ${n}`,"",`National ID: ${i}`,"","You can always access your digital pass here:",l,"","A PDF copy of your official Umuganda pass is attached for printing.","","Keep this information secure and change the password after your first sign-in."].join("\n");try{let e=await I({firstName:t,lastName:r,phoneNumber:o,nationalId:i,churchName:s,qrPayload:d,passToken:c});p=[{filename:`Umuganda-pass-${c}.pdf`,content:e,contentType:"application/pdf"}]}catch(e){console.error("Failed to generate member pass PDF",e)}return u({to:e,subject:"Your Umuganda SDA member credentials",text:m,html:`
    <div style="font-family:'Segoe UI',Arial,sans-serif;background:#0f172a;padding:32px;color:#e2e8f0;">
      <div style="max-width:720px;margin:0 auto;background:#0f172a;border-radius:28px;padding:32px;">
        <p style="margin:0 0 12px 0;font-size:18px;font-weight:600;">Hello ${g(h)},</p>
        <p style="margin:0 0 18px 0;font-size:15px;line-height:1.6;color:#cbd5f5;">
          Your Umuganda SDA member account has been created by your church administrator. Use the credentials below to sign in
          and download your digital pass ahead of the next community service day.
        </p>
        <div style="background:rgba(15,23,42,0.65);border:1px solid rgba(148,163,184,0.35);border-radius:20px;padding:20px 24px;margin-bottom:24px;">
          <div style="font-size:13px;letter-spacing:0.18em;text-transform:uppercase;color:#94a3b8;font-weight:600;margin-bottom:12px;">Member credentials</div>
          <div style="display:flex;flex-wrap:wrap;gap:16px;color:#f8fafc;font-size:15px;">
            <div style="flex:1 1 220px;">
              <div style="color:#94a3b8;font-size:13px;letter-spacing:0.08em;text-transform:uppercase;margin-bottom:4px;">Phone number</div>
              <div style="font-weight:600;">${g(o)}</div>
            </div>
            <div style="flex:1 1 220px;">
              <div style="color:#94a3b8;font-size:13px;letter-spacing:0.08em;text-transform:uppercase;margin-bottom:4px;">Password</div>
              <div style="font-weight:600;">${g(a)}</div>
            </div>
            <div style="flex:1 1 220px;">
              <div style="color:#94a3b8;font-size:13px;letter-spacing:0.18em;text-transform:uppercase;margin-bottom:4px;">Login link</div>
              <a href="${n}" style="color:#38bdf8;font-weight:600;text-decoration:none;">${g(n)}</a>
            </div>
          </div>
          <div style="margin-top:18px;font-size:13px;color:#cbd5f5;">National ID: <strong>${g(i)}</strong></div>
          <div style="margin-top:4px;font-size:12px;color:#94a3b8;">A printable PDF with front and back card layouts is attached.</div>
        </div>
        <div style="background:rgba(15,23,42,0.45);border-radius:18px;padding:20px 24px;color:#e2e8f0;">
          <p style="margin:0 0 10px 0;font-size:14px;line-height:1.6;">
            Print the attached card on both sides and carry it together with your national ID on Umuganda day. Present both documents
            when verification is requested.
          </p>
          <p style="margin:0;font-size:13px;color:#94a3b8;">
            If you did not expect this email, contact your church administrator immediately.
          </p>
        </div>
      </div>
    </div>
  `,attachments:p})}},37848:(e,t,r)=>{r.d(t,{O:()=>s});let o=e=>{let t=process.env[e];if(!t)throw Error(`Missing required environment variable: ${e}`);return t},a="http://localhost:3000",i=(process.env.CORS_ORIGIN??a).split(",").map(e=>e.trim()).filter(Boolean),s={DATABASE_URL:o("DATABASE_URL"),JWT_SECRET:o("JWT_SECRET"),SMS_API_KEY:process.env.SMS_API_KEY??"",CORS_ORIGIN:process.env.CORS_ORIGIN??a,PRIMARY_ORIGIN:i[0]??a,TWILIO_ACCOUNT_SID:process.env.TWILIO_ACCOUNT_SID??"",TWILIO_AUTH_TOKEN:process.env.TWILIO_AUTH_TOKEN??"",TWILIO_FROM_NUMBER:process.env.TWILIO_FROM_NUMBER??"",GMAIL_USER:process.env.GMAIL_USER,GMAIL_APP_PASSWORD:process.env.GMAIL_APP_PASSWORD,GMAIL_FROM_NAME:process.env.GMAIL_FROM_NAME||"Umuganda SDA",SMTP_HOST:process.env.SMTP_HOST||"smtp.gmail.com",SMTP_PORT:process.env.SMTP_PORT||"587",SMTP_SECURE:process.env.SMTP_SECURE||"false"}},47833:(e,t,r)=>{r.d(t,{AY:()=>n,HC:()=>d,dR:()=>s,gz:()=>o,lY:()=>i,p8:()=>l,yj:()=>a});class o extends Error{constructor(e,t=400,r){super(e),this.name="AppError",this.status=t,this.details=r}}class a extends o{constructor(e="Unauthorized"){super(e,401),this.name="UnauthorizedError"}}class i extends o{constructor(e="Forbidden"){super(e,403),this.name="ForbiddenError"}}class s extends o{constructor(e="Resource not found"){super(e,404),this.name="NotFoundError"}}class n extends o{constructor(e="Conflict"){super(e,409),this.name="ConflictError"}}class l extends o{constructor(e="Validation failed",t){super(e,422,t),this.name="ValidationError"}}let d=e=>e instanceof o},9293:(e,t,r)=>{r.d(t,{X:()=>l});var o=r(87070),a=r(26033),i=r(47833),s=r(37848);let n=(e,t)=>o.NextResponse.json(e,t),l=async(e,t)=>{if("OPTIONS"===e.method)return u(new o.NextResponse(null,{status:204}),e);try{let r;let a=await t();return r=a instanceof o.NextResponse?a:n({data:a}),u(r,e)}catch(r){let t;if(r instanceof a.jm){let e=new i.p8("Validation failed",r.flatten());t=o.NextResponse.json({error:e.message,details:e.details},{status:e.status})}else(0,i.HC)(r)?t=o.NextResponse.json({error:r.message,details:r.details},{status:r.status}):(r instanceof Error?console.error(r):console.error("Unknown error",r),t=o.NextResponse.json({error:"Internal Server Error"},{status:500}));return u(t,e)}},d=e=>e.replace(/^"|"$/g,"").replace(/^'|'$/g,""),c=e=>d(e).replace(/\/$/,""),p=()=>s.O.CORS_ORIGIN?s.O.CORS_ORIGIN.split(",").map(e=>e.trim()).filter(Boolean).map(e=>c(e)):[],u=(e,t)=>{let r=p();if(!r.length)return e;let o=t?.headers.get("origin")??null,a=o?c(o):null,i=null;if(a&&r.includes(a)?i=a:a&&r.includes("*")?i=a:1===r.length&&(i=r[0]),!i&&r.length&&(i=r[0]),!i)return e;e.headers.set("Access-Control-Allow-Origin",i);let s=t?.headers.get("access-control-request-headers");return e.headers.set("Access-Control-Allow-Methods","GET,POST,PUT,PATCH,DELETE,OPTIONS"),e.headers.set("Access-Control-Allow-Headers",s&&s.length?s:"Content-Type,Authorization,Accept"),e.headers.set("Access-Control-Allow-Credentials","true"),e.headers.set("Access-Control-Max-Age","600"),e.headers.set("Vary","Origin"),e}},13538:(e,t,r)=>{r.d(t,{_:()=>a});var o=r(53524);let a=globalThis.prisma??new o.PrismaClient({log:["error"]})},5754:(e,t,r)=>{r.d(t,{o:()=>a});var o=r(9293);let a=({middlewares:e=[],controller:t})=>async(r,a)=>(0,o.X)(r,async()=>{let o=new URL(r.url),i={req:r,params:a?.params??{},query:o.searchParams};for(let t of e)i=await t(i);return t({...i,params:i.params})})},54164:(e,t,r)=>{r.d(t,{T:()=>a});var o=r(13538);let a={findById:(e,t)=>o._.user.findUnique({where:{id:e},...t??{}}),findByUsername:(e,t)=>o._.user.findUnique({where:{username:e},...t??{}}),findByEmail:(e,t)=>o._.user.findUnique({where:{email:e},...t??{}}),findByPhoneNumber:(e,t)=>o._.user.findUnique({where:{phoneNumber:e},...t??{}}),findByNationalId:(e,t)=>o._.user.findUnique({where:{nationalId:e},...t??{}}),findMany:e=>o._.user.findMany(e),count:e=>o._.user.count(e),create:e=>o._.user.create(e),update:e=>o._.user.update(e),delete:e=>o._.user.delete(e)}},75145:(e,t,r)=>{r.d(t,{$N:()=>f,Cp:()=>y,Sk:()=>g,c_:()=>u});var o=r(42023),a=r.n(o),i=r(41482),s=r.n(i),n=r(53524),l=r(13538),d=r(37848),c=r(47833),p=r(54164);let u=async e=>{let t=await a().genSalt(10);return a().hash(e,t)},h=async(e,t)=>a().compare(e,t),m=e=>{let t={sub:e.id,role:e.role,unionId:e.unionId,districtId:e.districtId,churchId:e.churchId};return s().sign(t,d.O.JWT_SECRET,{expiresIn:43200})},g=async e=>{try{let t=s().verify(e,d.O.JWT_SECRET),r=await l._.user.findUnique({where:{id:t.sub}});if(!r)throw new c.yj("User not found");if(!r.isActive)throw new c.yj("Account disabled");return r}catch(e){if(e instanceof c.yj)throw e;throw new c.yj("Invalid token")}},f=async({email:e,phoneNumber:t,password:r})=>{let o=null;if(t){if(!(o=await p.T.findByPhoneNumber(t))||!o.isActive)throw new c.yj("Invalid credentials");if(o.role!==n.Role.MEMBER)throw new c.yj("Phone number login is restricted to members")}else if(e){if(!(o=await p.T.findByEmail(e))||!o.isActive)throw new c.yj("Invalid credentials");if(o.role===n.Role.MEMBER)throw new c.yj("Members must sign in with their phone number")}else throw new c.yj("Email or phone number is required");if(!await h(r,o.passwordHash))throw new c.yj("Invalid credentials");let a=m({id:o.id,role:o.role,unionId:o.unionId,districtId:o.districtId,churchId:o.churchId}),{passwordHash:i,...s}=o;return{token:a,user:s}},y=async(e,t)=>{if(!await h(t.currentPassword,e.passwordHash))throw new c.yj("Invalid current password");let r=await u(t.newPassword),{passwordHash:o,...a}=await l._.user.update({where:{id:e.id},data:{passwordHash:r}});return{user:a}}}};