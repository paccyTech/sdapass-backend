"use strict";exports.id=239,exports.ids=[239],exports.modules={31030:(e,t,r)=>{r.d(t,{Yx:()=>T,l9:()=>E,Er:()=>v,vk:()=>S,sQ:()=>D});var i=r(53524),a=r(84770),n=r.n(a),s=r(54164),d=r(92891),o=r(93456),l=r(47833),c=r(75145),u=r(3502),m=r(20471),h=r(67816),I=r(37848),w=r(13538);let f={id:!0,nationalId:!0,firstName:!0,lastName:!0,phoneNumber:!0,email:!0,church:{select:{id:!0,name:!0,districtId:!0}},createdAt:!0},b=(e,t)=>({id:e.id,nationalId:e.nationalId,firstName:e.firstName,lastName:e.lastName,phoneNumber:e.phoneNumber,email:e.email,createdAt:e.createdAt.toISOString(),church:e.church?{id:e.church.id,name:e.church.name,districtId:e.church.districtId}:null,memberPass:t?{token:t.token,smsSentAt:t.smsSentAt?t.smsSentAt.toISOString():null,expiresAt:t.expiresAt?t.expiresAt.toISOString():null}:null}),N=I.O.CORS_ORIGIN||"http://localhost:3000",p=(e,t)=>{if("UNION_ADMIN"!==e.role){if("DISTRICT_ADMIN"===e.role){if(!e.districtId)throw new l.lY("No district assigned to this account");if(t.districtId&&t.districtId!==e.districtId)throw new l.lY("Cannot view members outside your district");return}if("CHURCH_ADMIN"===e.role){if(!e.churchId)throw new l.lY("No church assigned to this account");if(t.churchId&&t.churchId!==e.churchId)throw new l.lY("Cannot view members outside your church");return}throw new l.lY("Not allowed to view members")}},y=(e,t)=>{if("UNION_ADMIN"===e.role){if(e.unionId&&t.unionId&&e.unionId!==t.unionId)throw new l.lY("Member belongs to another union");return}if("DISTRICT_ADMIN"===e.role){if(!e.districtId||e.districtId!==t.districtId)throw new l.lY("Member belongs to another district");return}if("CHURCH_ADMIN"===e.role){if(!e.churchId||e.churchId!==t.churchId)throw new l.lY("Member belongs to another church");return}throw new l.lY("Not allowed to manage members")},A=async(e,t,r)=>{let a=await s.T.findById(t,{select:{id:!0,role:!0,unionId:!0,districtId:!0,churchId:!0}});if(!a||"MEMBER"!==a.role)throw new l.dR("Member not found");y(e,a);let n={};if(void 0!==r.firstName&&(n.firstName=r.firstName),void 0!==r.lastName&&(n.lastName=r.lastName),void 0!==r.phoneNumber&&(n.phoneNumber=r.phoneNumber),void 0!==r.email&&(n.email=r.email),0===Object.keys(n).length)return{member:await s.T.findById(t,{select:f})};try{return{member:await s.T.update({where:{id:t},data:n,select:f})}}catch(e){if(e instanceof i.Prisma.PrismaClientKnownRequestError&&"P2002"===e.code&&e.meta?.target&&Array.isArray(e.meta.target)&&e.meta.target.includes("email"))throw new l.AY("Email already in use");throw e}},g=async(e,t)=>{let r=await s.T.findById(t,{select:{id:!0,role:!0,unionId:!0,districtId:!0,churchId:!0}});if(!r||"MEMBER"!==r.role)throw new l.dR("Member not found");return y(e,r),await w._.memberPass.deleteMany({where:{memberId:t}}),await s.T.delete({where:{id:t}}),{success:!0}},_=async(e,t={})=>{p(e,t);let r={role:"MEMBER"};t.districtId&&(r.districtId=t.districtId),t.churchId&&(r.churchId=t.churchId),"DISTRICT_ADMIN"!==e.role||t.districtId||(r.districtId=e.districtId??void 0),"CHURCH_ADMIN"!==e.role||t.churchId||(r.churchId=e.churchId??void 0);let i=await w._.user.findMany({where:r,select:f,orderBy:{lastName:"asc"}});if(0===i.length)return[];let a=i.map(e=>e.id),n=await w._.memberPass.findMany({where:{memberId:{in:a}},select:{memberId:!0,token:!0,smsSentAt:!0,expiresAt:!0}}),s=new Map;return n.forEach(e=>{s.set(e.memberId,{token:e.token,smsSentAt:e.smsSentAt,expiresAt:e.expiresAt})}),i.map(e=>b(e,s.get(e.id)??null))},M=async(e,t)=>{let r=await w._.user.findUnique({where:{id:t},select:{id:!0,role:!0,unionId:!0,districtId:!0,churchId:!0,firstName:!0,lastName:!0,nationalId:!0,phoneNumber:!0,email:!0,church:{select:{id:!0,name:!0,districtId:!0}},createdAt:!0}});if(!r||"MEMBER"!==r.role)throw new l.dR("Member not found");if("MEMBER"===e.role){if(e.id!==r.id)throw new l.lY("Not allowed to view other member passes")}else y(e,r);let i=await w._.memberPass.findUnique({where:{memberId:t},select:{id:!0,token:!0,qrPayload:!0,expiresAt:!0,smsSentAt:!0}});if(!i)throw new l.dR("Member pass not found");return{member:{id:r.id,firstName:r.firstName,lastName:r.lastName,nationalId:r.nationalId,phoneNumber:r.phoneNumber,email:r.email,createdAt:r.createdAt.toISOString(),church:r.church?{id:r.church.id,name:r.church.name,districtId:r.church.districtId}:null},pass:{...i,smsSentAt:i.smsSentAt?i.smsSentAt.toISOString():null,expiresAt:i.expiresAt?i.expiresAt.toISOString():null}}},R=async(e,t)=>{if("CHURCH_ADMIN"!==e.role)throw new l.lY("Only church admins can create members");if(!e.churchId)throw new l.lY("No church assigned to this account");let r=await d.d.findById(e.churchId,{where:{id:e.churchId},include:{district:{include:{union:!0}}}});if(!r)throw new l.dR("Church not found");if(t.email&&await s.T.findByEmail(t.email))throw new l.AY("A user with this email already exists");if(await s.T.findByPhoneNumber(t.phoneNumber))throw new l.AY("A user with this phone number already exists");let a=await (0,c.c_)(t.password);try{let e=await s.T.create({data:{username:t.nationalId,nationalId:t.nationalId,firstName:t.firstName,lastName:t.lastName,phoneNumber:t.phoneNumber,email:t.email,passwordHash:a,role:"MEMBER",unionId:r.district.unionId,districtId:r.districtId,churchId:r.id},select:f}),i=n().randomUUID(),d=await (0,u.J)(i),l=await w._.memberPass.create({data:{memberId:e.id,token:i,qrPayload:d}});await o.P.upsert({where:{memberId:e.id},update:{token:i,qrPayload:d,sessionDate:new Date,churchId:e.church?.id??null},create:{memberId:e.id,churchId:e.church?.id??null,token:i,qrPayload:d,sessionDate:new Date}});let c=`${N}/login`,I=`${N}/member/pass`,p=null;if(e.phoneNumber){let r=`Murakaza neza mu Umuganda SDA, ${e.firstName}. Injira kuri ${c} ukoresheje iri nambara y'indangamuntu: ${e.nationalId}. Ijambo ry'ibanga wahawe: ${t.password}. Ikarita yawe ya QR iri hano: ${I}.`;try{await (0,h.Q)({to:e.phoneNumber,message:r}),p=new Date,l=await w._.memberPass.update({where:{id:l.id},data:{smsSentAt:p}})}catch(e){console.error("Failed to send member onboarding SMS",e)}}if(e.email)try{await (0,m.Rl)({to:e.email,firstName:e.firstName,lastName:e.lastName,phoneNumber:e.phoneNumber,password:t.password,nationalId:e.nationalId,churchName:e.church?.name??null,loginUrl:c,passUrl:I,qrPayload:d,passToken:i})}catch(e){console.error("Failed to send member welcome email",e)}return{member:b(e,{token:l.token,smsSentAt:l.smsSentAt,expiresAt:l.expiresAt}),memberPass:{id:l.id,token:i,qrPayload:d,smsSentAt:p}}}catch(e){if(e instanceof i.Prisma.PrismaClientKnownRequestError&&"P2002"===e.code){let t=Array.isArray(e.meta?.target)?e.meta?.target:[];if(t.includes("nationalId")||t.includes("username"))throw new l.AY("A member with this national ID already exists");if(t.includes("email"))throw new l.AY("A user with this email already exists");throw new l.AY("Member already exists")}throw e}};var O=r(6974);let S=async e=>({members:await _(e.user,e.queryData??{})}),T=async e=>{if(!e.body)throw Error("Missing request body");let t=await R(e.user,e.body);return await (0,O.R)({req:e.req,user:e.user,action:"member.create",details:{memberId:t.member.id,churchId:t.member.church?.id??null,firstName:t.member.firstName,lastName:t.member.lastName}}),t},D=async e=>{let t=e.paramsData?.memberId;if(!t)throw Error("Member id is required");let r=e.body??{},i=await A(e.user,t,r);if(!i.member)throw Error("Member not found");return await (0,O.R)({req:e.req,user:e.user,action:"member.update",details:{memberId:t,churchId:i.member.churchId??null,changes:r}}),i},E=async e=>{let t=e.paramsData?.memberId;if(!t)throw Error("Member id is required");let r=await g(e.user,t);return await (0,O.R)({req:e.req,user:e.user,action:"member.delete",details:{memberId:t}}),r},v=async e=>{let t=e.paramsData?.memberId;if(!t)throw Error("Member id is required");return await M(e.user,t)}},67816:(e,t,r)=>{r.d(t,{Q:()=>o});var i=r(5558),a=r.n(i),n=r(37848);let s=null,d=()=>{if(!s){if(!n.O.TWILIO_ACCOUNT_SID||!n.O.TWILIO_AUTH_TOKEN)throw Error("Twilio credentials are not configured");s=a()(n.O.TWILIO_ACCOUNT_SID,n.O.TWILIO_AUTH_TOKEN)}return s},o=async({to:e,message:t})=>{if(!e)throw Error("Missing receiver phone number");let r=n.O.TWILIO_FROM_NUMBER;if(!n.O.TWILIO_ACCOUNT_SID||!n.O.TWILIO_AUTH_TOKEN||!r)throw Error("Twilio configuration missing");let i=d();await i.messages.create({to:e,from:r,body:t})}},9846:(e,t,r)=>{r.d(t,{k:()=>s});var i=r(47833),a=r(75145);let n=e=>{let t=e.headers.get("authorization")??e.headers.get("Authorization");if(!t)throw new i.yj("Missing Authorization header");let r=t.split(" ");if(2!==r.length||"Bearer"!==r[0])throw new i.yj("Malformed Authorization header");return r[1]},s=e=>async t=>{let r=n(t.req),s=await (0,a.Sk)(r);if(e&&!e.includes(s.role))throw new i.yj("Insufficient permissions");return{...t,user:s}}},92891:(e,t,r)=>{r.d(t,{d:()=>a});var i=r(13538);let a={findById:(e,t)=>i._.church.findUnique({...t??{},where:{id:e}}),findMany:e=>i._.church.findMany(e),create:e=>i._.church.create(e),update:e=>i._.church.update(e),delete:e=>i._.church.delete(e),count:e=>i._.church.count(e)}},93456:(e,t,r)=>{r.d(t,{P:()=>a});var i=r(13538);let a={findById:(e,t)=>i._.pass.findUnique({where:{id:e},...t}),findByToken:(e,t)=>i._.pass.findUnique({where:{token:e},...t}),findMany:e=>i._.pass.findMany(e),create:e=>i._.pass.create(e),update:e=>i._.pass.update(e),upsert:e=>i._.pass.upsert(e),delete:e=>i._.pass.delete({where:{id:e}})}},6974:(e,t,r)=>{r.d(t,{B:()=>l,R:()=>d});var i=r(13538),a=r(47833);let n=e=>{let t=e.headers.get("x-forwarded-for")??e.headers.get("X-Forwarded-For");return t?t.split(",").map(e=>e.trim()).find(Boolean)??null:(e.headers.get("x-real-ip")??e.headers.get("X-Real-Ip")??e.headers.get("cf-connecting-ip")??e.headers.get("CF-Connecting-Ip"))||null},s=e=>e?`${e.firstName??""} ${e.lastName??""}`.trim()||(e.username??"Unknown"):"Unknown",d=async({req:e,user:t,action:r,details:a})=>{try{let d=n(e),o=e.headers.get("user-agent")??e.headers.get("User-Agent")??null;await i._.auditLog.create({data:{action:r,userName:s(t),userRole:t?.role??null,userId:t?.id??null,unionId:t?.unionId??null,districtId:t?.districtId??null,churchId:t?.churchId??null,ipAddress:d,userAgent:o,details:a??void 0}})}catch(e){console.error("Failed to record audit log",e)}},o=e=>{if(e)return{OR:[{userName:{contains:e,mode:"insensitive"}},{action:{contains:e,mode:"insensitive"}},{ipAddress:{contains:e,mode:"insensitive"}},{userAgent:{contains:e,mode:"insensitive"}}]}},l=async(e,{action:t,role:r,search:n,cursor:s,limit:d=25})=>{if("UNION_ADMIN"!==e.role)throw new a.lY("Only union admins can view audit logs");if(!e.unionId)throw new a.lY("Union context is required to view audit logs");let l={unionId:e.unionId,...t?{action:t}:{},...r?{userRole:r}:{}},c=o(n);c&&(l.AND=[...l.AND??[],c]);let u=Math.min(Math.max(d,1),100),m=await i._.auditLog.findMany({where:l,orderBy:{createdAt:"desc"},take:u+1,cursor:s?{id:s}:void 0,skip:s?1:0}),h=i._.auditLog.count({where:l}),I=i._.auditLog.groupBy({where:l,by:["action"],_count:{action:!0}}),w=i._.auditLog.groupBy({where:l,by:["userRole"],_count:{userRole:!0}}),[f,b,N]=await Promise.all([h,I,w]),p=null;if(m.length>u){let e=m.pop();p=e?e.id:null}return{logs:m,total:f,countsByAction:b.map(e=>({action:e.action,count:e._count.action})),countsByRole:N.map(e=>({role:e.userRole??null,count:e._count.userRole})),nextCursor:p}}},3502:(e,t,r)=>{r.d(t,{J:()=>a});var i=r(28362);let a=async e=>i.toDataURL(JSON.stringify({token:e}))}};