"use strict";exports.id=144,exports.ids=[144],exports.modules={28633:(e,r,t)=>{function n(e,r){!function(e,r){if(r.length<1)throw TypeError("1 argument required, but only "+r.length+" present")}(1,arguments);var t,n,h,f=function(e){if(null===e||!0===e||!1===e)return NaN;var r=Number(e);return isNaN(r)?r:r<0?Math.ceil(r):Math.floor(r)}(null!==(t=null==r?void 0:r.additionalDigits)&&void 0!==t?t:2);if(2!==f&&1!==f&&0!==f)throw RangeError("additionalDigits must be 0, 1 or 2");if(!("string"==typeof e||"[object String]"===Object.prototype.toString.call(e)))return new Date(NaN);var w=function(e){var r,t={},n=e.split(s.dateTimeDelimiter);if(n.length>2)return t;if(/:/.test(n[0])?r=n[0]:(t.date=n[0],r=n[1],s.timeZoneDelimiter.test(t.date)&&(t.date=e.split(s.timeZoneDelimiter)[0],r=e.substr(t.date.length,e.length))),r){var a=s.timezone.exec(r);a?(t.time=r.replace(a[1],""),t.timezone=a[1]):t.time=r}return t}(e);if(w.date){var p=function(e,r){var t=RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+r)+"})|(\\d{2}|[+-]\\d{"+(2+r)+"})$)"),n=e.match(t);if(!n)return{year:NaN,restDateString:""};var s=n[1]?parseInt(n[1]):null,a=n[2]?parseInt(n[2]):null;return{year:null===a?s:100*a,restDateString:e.slice((n[1]||n[2]).length)}}(w.date,f);n=function(e,r){if(null===r)return new Date(NaN);var t,n,s=e.match(a);if(!s)return new Date(NaN);var i=!!s[4],o=l(s[1]),d=l(s[2])-1,h=l(s[3]),f=l(s[4]),w=l(s[5])-1;if(i)return f>=1&&f<=53&&w>=0&&w<=6?((t=new Date(0)).setUTCFullYear(r,0,4),n=t.getUTCDay()||7,t.setUTCDate(t.getUTCDate()+((f-1)*7+w+1-n)),t):new Date(NaN);var p=new Date(0);return d>=0&&d<=11&&h>=1&&h<=(u[d]||(c(r)?29:28))&&o>=1&&o<=(c(r)?366:365)?(p.setUTCFullYear(r,d,Math.max(o,h)),p):new Date(NaN)}(p.restDateString,p.year)}if(!n||isNaN(n.getTime()))return new Date(NaN);var m=n.getTime(),I=0;if(w.time&&isNaN(I=function(e){var r=e.match(i);if(!r)return NaN;var t=d(r[1]),n=d(r[2]),s=d(r[3]);return(24===t?0===n&&0===s:s>=0&&s<60&&n>=0&&n<60&&t>=0&&t<25)?36e5*t+6e4*n+1e3*s:NaN}(w.time)))return new Date(NaN);if(w.timezone){if(isNaN(h=function(e){if("Z"===e)return 0;var r=e.match(o);if(!r)return 0;var t="+"===r[1]?-1:1,n=parseInt(r[2]),s=r[3]&&parseInt(r[3])||0;return s>=0&&s<=59?t*(36e5*n+6e4*s):NaN}(w.timezone)))return new Date(NaN)}else{var N=new Date(m+I),T=new Date(0);return T.setFullYear(N.getUTCFullYear(),N.getUTCMonth(),N.getUTCDate()),T.setHours(N.getUTCHours(),N.getUTCMinutes(),N.getUTCSeconds(),N.getUTCMilliseconds()),T}return new Date(m+I+h)}t.d(r,{Z:()=>n});var s={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},a=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,i=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,o=/^([+-])(\d{2})(?::?(\d{2}))?$/;function l(e){return e?parseInt(e):1}function d(e){return e&&parseFloat(e.replace(",","."))||0}var u=[31,null,31,30,31,30,31,31,30,31,30,31];function c(e){return e%400==0||e%4==0&&e%100!=0}},37848:(e,r,t)=>{t.d(r,{O:()=>i});let n=e=>{let r=process.env[e];if(!r)throw Error(`Missing required environment variable: ${e}`);return r},s="http://localhost:3000",a=(process.env.CORS_ORIGIN??s).split(",").map(e=>e.trim()).filter(Boolean),i={DATABASE_URL:n("DATABASE_URL"),JWT_SECRET:n("JWT_SECRET"),SMS_API_KEY:process.env.SMS_API_KEY??"",CORS_ORIGIN:process.env.CORS_ORIGIN??s,PRIMARY_ORIGIN:a[0]??s,TWILIO_ACCOUNT_SID:process.env.TWILIO_ACCOUNT_SID??"",TWILIO_AUTH_TOKEN:process.env.TWILIO_AUTH_TOKEN??"",TWILIO_FROM_NUMBER:process.env.TWILIO_FROM_NUMBER??"",GMAIL_USER:process.env.GMAIL_USER,GMAIL_APP_PASSWORD:process.env.GMAIL_APP_PASSWORD,GMAIL_FROM_NAME:process.env.GMAIL_FROM_NAME||"Umuganda SDA",SMTP_HOST:process.env.SMTP_HOST||"smtp.gmail.com",SMTP_PORT:process.env.SMTP_PORT||"587",SMTP_SECURE:process.env.SMTP_SECURE||"false"}},47833:(e,r,t)=>{t.d(r,{AY:()=>o,HC:()=>d,dR:()=>i,gz:()=>n,lY:()=>a,p8:()=>l,yj:()=>s});class n extends Error{constructor(e,r=400,t){super(e),this.name="AppError",this.status=r,this.details=t}}class s extends n{constructor(e="Unauthorized"){super(e,401),this.name="UnauthorizedError"}}class a extends n{constructor(e="Forbidden"){super(e,403),this.name="ForbiddenError"}}class i extends n{constructor(e="Resource not found"){super(e,404),this.name="NotFoundError"}}class o extends n{constructor(e="Conflict"){super(e,409),this.name="ConflictError"}}class l extends n{constructor(e="Validation failed",r){super(e,422,r),this.name="ValidationError"}}let d=e=>e instanceof n},9293:(e,r,t)=>{t.d(r,{X:()=>l});var n=t(87070),s=t(26033),a=t(47833),i=t(37848);let o=(e,r)=>n.NextResponse.json(e,r),l=async(e,r)=>{if("OPTIONS"===e.method)return h(new n.NextResponse(null,{status:204}),e);try{let t;let s=await r();return t=s instanceof n.NextResponse?s:o({data:s}),h(t,e)}catch(t){let r;if(t instanceof s.jm){let e=new a.p8("Validation failed",t.flatten());r=n.NextResponse.json({error:e.message,details:e.details},{status:e.status})}else(0,a.HC)(t)?r=n.NextResponse.json({error:t.message,details:t.details},{status:t.status}):(t instanceof Error?console.error(t):console.error("Unknown error",t),r=n.NextResponse.json({error:"Internal Server Error"},{status:500}));return h(r,e)}},d=e=>e.replace(/^"|"$/g,"").replace(/^'|'$/g,""),u=e=>d(e).replace(/\/$/,""),c=()=>i.O.CORS_ORIGIN?i.O.CORS_ORIGIN.split(",").map(e=>e.trim()).filter(Boolean).map(e=>u(e)):[],h=(e,r)=>{let t=c();if(!t.length)return e;let n=r?.headers.get("origin")??null,s=n?u(n):null,a=null;if(s&&t.includes(s)?a=s:s&&t.includes("*")?a=s:1===t.length&&(a=t[0]),!a&&t.length&&(a=t[0]),!a)return e;e.headers.set("Access-Control-Allow-Origin",a);let i=r?.headers.get("access-control-request-headers");return e.headers.set("Access-Control-Allow-Methods","GET,POST,PUT,PATCH,DELETE,OPTIONS"),e.headers.set("Access-Control-Allow-Headers",i&&i.length?i:"Content-Type,Authorization,Accept"),e.headers.set("Access-Control-Allow-Credentials","true"),e.headers.set("Access-Control-Max-Age","600"),e.headers.set("Vary","Origin"),e}},13538:(e,r,t)=>{t.d(r,{_:()=>s});var n=t(53524);let s=globalThis.prisma??new n.PrismaClient({log:["error"]})},5754:(e,r,t)=>{t.d(r,{o:()=>s});var n=t(9293);let s=({middlewares:e=[],controller:r})=>async(t,s)=>(0,n.X)(t,async()=>{let n=new URL(t.url),a={req:t,params:s?.params??{},query:n.searchParams};for(let r of e)a=await r(a);return r({...a,params:a.params})})},9846:(e,r,t)=>{t.d(r,{k:()=>i});var n=t(47833),s=t(75145);let a=e=>{let r=e.headers.get("authorization")??e.headers.get("Authorization");if(!r)throw new n.yj("Missing Authorization header");let t=r.split(" ");if(2!==t.length||"Bearer"!==t[0])throw new n.yj("Malformed Authorization header");return t[1]},i=e=>async r=>{let t=a(r.req),i=await (0,s.Sk)(t);if(e&&!e.includes(i.role))throw new n.yj("Insufficient permissions");return{...r,user:i}}},38553:(e,r,t)=>{t.d(r,{m:()=>a});var n=t(26033),s=t(47833);let a=e=>async r=>{let t;try{t=await r.req.json()}catch(r){if(e.isOptional())t=void 0;else throw new s.p8("Invalid JSON body")}try{let n=e.parse(t);return{...r,body:n}}catch(e){if(e instanceof n.jm)throw new s.p8("Validation failed",e.flatten());throw e}}},54164:(e,r,t)=>{t.d(r,{T:()=>s});var n=t(13538);let s={findById:(e,r)=>n._.user.findUnique({where:{id:e},...r??{}}),findByUsername:(e,r)=>n._.user.findUnique({where:{username:e},...r??{}}),findByEmail:(e,r)=>n._.user.findUnique({where:{email:e},...r??{}}),findByPhoneNumber:(e,r)=>n._.user.findUnique({where:{phoneNumber:e},...r??{}}),findByNationalId:(e,r)=>n._.user.findUnique({where:{nationalId:e},...r??{}}),findMany:e=>n._.user.findMany(e),count:e=>n._.user.count(e),create:e=>n._.user.create(e),update:e=>n._.user.update(e),delete:e=>n._.user.delete(e)}},75145:(e,r,t)=>{t.d(r,{$N:()=>m,Cp:()=>I,Sk:()=>p,c_:()=>h});var n=t(42023),s=t.n(n),a=t(41482),i=t.n(a),o=t(53524),l=t(13538),d=t(37848),u=t(47833),c=t(54164);let h=async e=>{let r=await s().genSalt(10);return s().hash(e,r)},f=async(e,r)=>s().compare(e,r),w=e=>{let r={sub:e.id,role:e.role,unionId:e.unionId,districtId:e.districtId,churchId:e.churchId};return i().sign(r,d.O.JWT_SECRET,{expiresIn:43200})},p=async e=>{try{let r=i().verify(e,d.O.JWT_SECRET),t=await l._.user.findUnique({where:{id:r.sub}});if(!t)throw new u.yj("User not found");if(!t.isActive)throw new u.yj("Account disabled");return t}catch(e){if(e instanceof u.yj)throw e;throw new u.yj("Invalid token")}},m=async({email:e,phoneNumber:r,password:t})=>{let n=null;if(r){if(!(n=await c.T.findByPhoneNumber(r))||!n.isActive)throw new u.yj("Invalid credentials");if(n.role!==o.Role.MEMBER)throw new u.yj("Phone number login is restricted to members")}else if(e){if(!(n=await c.T.findByEmail(e))||!n.isActive)throw new u.yj("Invalid credentials");if(n.role===o.Role.MEMBER)throw new u.yj("Members must sign in with their phone number")}else throw new u.yj("Email or phone number is required");if(!await f(t,n.passwordHash))throw new u.yj("Invalid credentials");let s=w({id:n.id,role:n.role,unionId:n.unionId,districtId:n.districtId,churchId:n.churchId}),{passwordHash:a,...i}=n;return{token:s,user:i}},I=async(e,r)=>{if(!await f(r.currentPassword,e.passwordHash))throw new u.yj("Invalid current password");let t=await h(r.newPassword),{passwordHash:n,...s}=await l._.user.update({where:{id:e.id},data:{passwordHash:t}});return{user:s}}}};