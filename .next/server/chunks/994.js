"use strict";exports.id=994,exports.ids=[994],exports.modules={37848:(e,t,r)=>{r.d(t,{O:()=>i});let n=e=>{let t=process.env[e];if(!t)throw Error(`Missing required environment variable: ${e}`);return t},s="http://localhost:3000",a=(process.env.CORS_ORIGIN??s).split(",").map(e=>e.trim()).filter(Boolean),i={DATABASE_URL:n("DATABASE_URL"),JWT_SECRET:n("JWT_SECRET"),SMS_API_KEY:process.env.SMS_API_KEY??"",CORS_ORIGIN:process.env.CORS_ORIGIN??s,PRIMARY_ORIGIN:a[0]??s,TWILIO_ACCOUNT_SID:process.env.TWILIO_ACCOUNT_SID??"",TWILIO_AUTH_TOKEN:process.env.TWILIO_AUTH_TOKEN??"",TWILIO_FROM_NUMBER:process.env.TWILIO_FROM_NUMBER??"",GMAIL_USER:process.env.GMAIL_USER,GMAIL_APP_PASSWORD:process.env.GMAIL_APP_PASSWORD,GMAIL_FROM_NAME:process.env.GMAIL_FROM_NAME||"Umuganda SDA",SMTP_HOST:process.env.SMTP_HOST||"smtp.gmail.com",SMTP_PORT:process.env.SMTP_PORT||"587",SMTP_SECURE:process.env.SMTP_SECURE||"false"}},47833:(e,t,r)=>{r.d(t,{AY:()=>d,HC:()=>l,dR:()=>i,gz:()=>n,lY:()=>a,p8:()=>o,yj:()=>s});class n extends Error{constructor(e,t=400,r){super(e),this.name="AppError",this.status=t,this.details=r}}class s extends n{constructor(e="Unauthorized"){super(e,401),this.name="UnauthorizedError"}}class a extends n{constructor(e="Forbidden"){super(e,403),this.name="ForbiddenError"}}class i extends n{constructor(e="Resource not found"){super(e,404),this.name="NotFoundError"}}class d extends n{constructor(e="Conflict"){super(e,409),this.name="ConflictError"}}class o extends n{constructor(e="Validation failed",t){super(e,422,t),this.name="ValidationError"}}let l=e=>e instanceof n},9293:(e,t,r)=>{r.d(t,{X:()=>o});var n=r(87070),s=r(26033),a=r(47833),i=r(37848);let d=(e,t)=>n.NextResponse.json(e,t),o=async(e,t)=>{if("OPTIONS"===e.method)return h(new n.NextResponse(null,{status:204}),e);try{let r;let s=await t();return r=s instanceof n.NextResponse?s:d({data:s}),h(r,e)}catch(r){let t;if(r instanceof s.jm){let e=new a.p8("Validation failed",r.flatten());t=n.NextResponse.json({error:e.message,details:e.details},{status:e.status})}else(0,a.HC)(r)?t=n.NextResponse.json({error:r.message,details:r.details},{status:r.status}):(r instanceof Error?console.error(r):console.error("Unknown error",r),t=n.NextResponse.json({error:"Internal Server Error"},{status:500}));return h(t,e)}},l=e=>e.replace(/^"|"$/g,"").replace(/^'|'$/g,""),c=e=>l(e).replace(/\/$/,""),u=()=>i.O.CORS_ORIGIN?i.O.CORS_ORIGIN.split(",").map(e=>e.trim()).filter(Boolean).map(e=>c(e)):[],h=(e,t)=>{let r=u();if(!r.length)return e;let n=t?.headers.get("origin")??null,s=n?c(n):null,a=null;if(s&&r.includes(s)?a=s:s&&r.includes("*")?a=s:1===r.length&&(a=r[0]),!a&&r.length&&(a=r[0]),!a)return e;e.headers.set("Access-Control-Allow-Origin",a);let i=t?.headers.get("access-control-request-headers");return e.headers.set("Access-Control-Allow-Methods","GET,POST,PUT,PATCH,DELETE,OPTIONS"),e.headers.set("Access-Control-Allow-Headers",i&&i.length?i:"Content-Type,Authorization,Accept"),e.headers.set("Access-Control-Allow-Credentials","true"),e.headers.set("Access-Control-Max-Age","600"),e.headers.set("Vary","Origin"),e}},13538:(e,t,r)=>{r.d(t,{_:()=>s});var n=r(53524);let s=globalThis.prisma??new n.PrismaClient({log:["error"]})},5754:(e,t,r)=>{r.d(t,{o:()=>s});var n=r(9293);let s=({middlewares:e=[],controller:t})=>async(r,s)=>(0,n.X)(r,async()=>{let n=new URL(r.url),a={req:r,params:s?.params??{},query:n.searchParams};for(let t of e)a=await t(a);return t({...a,params:a.params})})},67816:(e,t,r)=>{r.d(t,{Q:()=>o});var n=r(5558),s=r.n(n),a=r(37848);let i=null,d=()=>{if(!i){if(!a.O.TWILIO_ACCOUNT_SID||!a.O.TWILIO_AUTH_TOKEN)throw Error("Twilio credentials are not configured");i=s()(a.O.TWILIO_ACCOUNT_SID,a.O.TWILIO_AUTH_TOKEN)}return i},o=async({to:e,message:t})=>{if(!e)throw Error("Missing receiver phone number");let r=a.O.TWILIO_FROM_NUMBER;if(!a.O.TWILIO_ACCOUNT_SID||!a.O.TWILIO_AUTH_TOKEN||!r)throw Error("Twilio configuration missing");let n=d();await n.messages.create({to:e,from:r,body:t})}},9846:(e,t,r)=>{r.d(t,{k:()=>i});var n=r(47833),s=r(75145);let a=e=>{let t=e.headers.get("authorization")??e.headers.get("Authorization");if(!t)throw new n.yj("Missing Authorization header");let r=t.split(" ");if(2!==r.length||"Bearer"!==r[0])throw new n.yj("Malformed Authorization header");return r[1]},i=e=>async t=>{let r=a(t.req),i=await (0,s.Sk)(r);if(e&&!e.includes(i.role))throw new n.yj("Insufficient permissions");return{...t,user:i}}},57243:(e,t,r)=>{r.d(t,{v:()=>s});var n=r(13538);let s={findById:(e,t)=>n._.attendanceRecord.findUnique({...t??{},where:{id:e}}),findMany:e=>n._.attendanceRecord.findMany(e),create:e=>n._.attendanceRecord.create(e),update:e=>n._.attendanceRecord.update(e),delete:e=>n._.attendanceRecord.delete({where:{id:e}}),aggregate:e=>n._.attendanceRecord.aggregate(e),groupBy:n._.attendanceRecord.groupBy.bind(n._.attendanceRecord),count:e=>n._.attendanceRecord.count(e)}},93456:(e,t,r)=>{r.d(t,{P:()=>s});var n=r(13538);let s={findById:(e,t)=>n._.pass.findUnique({where:{id:e},...t}),findByToken:(e,t)=>n._.pass.findUnique({where:{token:e},...t}),findMany:e=>n._.pass.findMany(e),create:e=>n._.pass.create(e),update:e=>n._.pass.update(e),upsert:e=>n._.pass.upsert(e),delete:e=>n._.pass.delete({where:{id:e}})}},54164:(e,t,r)=>{r.d(t,{T:()=>s});var n=r(13538);let s={findById:(e,t)=>n._.user.findUnique({where:{id:e},...t??{}}),findByUsername:(e,t)=>n._.user.findUnique({where:{username:e},...t??{}}),findByEmail:(e,t)=>n._.user.findUnique({where:{email:e},...t??{}}),findByPhoneNumber:(e,t)=>n._.user.findUnique({where:{phoneNumber:e},...t??{}}),findByNationalId:(e,t)=>n._.user.findUnique({where:{nationalId:e},...t??{}}),findMany:e=>n._.user.findMany(e),count:e=>n._.user.count(e),create:e=>n._.user.create(e),update:e=>n._.user.update(e),delete:e=>n._.user.delete(e)}},75145:(e,t,r)=>{r.d(t,{$N:()=>p,Sk:()=>f,c_:()=>h});var n=r(42023),s=r.n(n),a=r(41482),i=r.n(a),d=r(53524),o=r(13538),l=r(37848),c=r(47833),u=r(54164);let h=async e=>{let t=await s().genSalt(10);return s().hash(e,t)},m=async(e,t)=>s().compare(e,t),I=e=>{let t={sub:e.id,role:e.role,unionId:e.unionId,districtId:e.districtId,churchId:e.churchId};return i().sign(t,l.O.JWT_SECRET,{expiresIn:43200})},f=async e=>{try{let t=i().verify(e,l.O.JWT_SECRET),r=await o._.user.findUnique({where:{id:t.sub}});if(!r)throw new c.yj("User not found");if(!r.isActive)throw new c.yj("Account disabled");return r}catch(e){if(e instanceof c.yj)throw e;throw new c.yj("Invalid token")}},p=async({email:e,phoneNumber:t,password:r})=>{let n=null;if(t){if(!(n=await u.T.findByPhoneNumber(t))||!n.isActive)throw new c.yj("Invalid credentials");if(n.role!==d.Role.MEMBER)throw new c.yj("Phone number login is restricted to members")}else if(e){if(!(n=await u.T.findByEmail(e))||!n.isActive)throw new c.yj("Invalid credentials");if(n.role===d.Role.MEMBER)throw new c.yj("Members must sign in with their phone number")}else throw new c.yj("Email or phone number is required");if(!await m(r,n.passwordHash))throw new c.yj("Invalid credentials");let s=I({id:n.id,role:n.role,unionId:n.unionId,districtId:n.districtId,churchId:n.churchId}),{passwordHash:a,...i}=n;return{token:s,user:i}}},57303:(e,t,r)=>{r.d(t,{IN:()=>f,QE:()=>I,qc:()=>p});var n=r(84770),s=r.n(n),a=r(93456),i=r(57243),d=r(3502),o=r(67816),l=r(37848),c=r(47833),u=r(13538);let h={member:!0,session:{include:{church:{include:{district:{include:{union:!0}}}}}},pass:!0},m={attendance:{include:{session:{include:{church:{select:{id:!0,name:!0}}}}}},member:{select:{id:!0,firstName:!0,lastName:!0,nationalId:!0,church:{select:{id:!0,name:!0}}}},church:{select:{id:!0,name:!0}}},I=async e=>{let t=await i.v.findById(e,{include:h});if(!t)throw new c.dR("Attendance record not found");if("APPROVED"!==t.status)throw new c.gz("Attendance must be approved before issuing a pass",400);if(t.pass)return t.pass;let r=s().randomUUID(),n=await (0,d.J)(r),u=await a.P.create({data:{attendanceId:t.id,memberId:t.member.id,churchId:t.session.church?.id??null,token:r,qrPayload:n,sessionDate:t.session.date}}),m=`Umuganda pass: ${t.member.firstName} ${t.member.lastName} (${t.session.date.toISOString().slice(0,10)})`;return l.O.SMS_API_KEY&&t.member.phoneNumber&&(await (0,o.Q)({to:t.member.phoneNumber,message:m}),await a.P.update({where:{id:u.id},data:{smsSentAt:new Date}})),u},f=async e=>{let t=await a.P.findByToken(e,{include:m});if(!t){let r=await u._.memberPass.findUnique({where:{token:e},include:{member:{select:{id:!0,churchId:!0,church:{select:{id:!0,name:!0}}}}}});if(!r)return{valid:!1};let n=r.member?.church?.id??r.member?.churchId??null,s=r.updatedAt??new Date;if(await a.P.upsert({where:{memberId:r.memberId},update:{token:r.token,qrPayload:r.qrPayload,churchId:n,sessionDate:s,expiresAt:r.expiresAt??null,smsSentAt:r.smsSentAt??null},create:{memberId:r.memberId,churchId:n,token:r.token,qrPayload:r.qrPayload,sessionDate:s,expiresAt:r.expiresAt??null,smsSentAt:r.smsSentAt??null}}),!(t=await a.P.findByToken(e,{include:m})))return{valid:!1}}if(t.expiresAt&&t.expiresAt.getTime()<Date.now())return{valid:!1,reason:"expired"};let r=t,n=r.attendance?.session.church??r.church??r.member?.church??null,s=r.attendance?.session.date??r.sessionDate??r.createdAt,i=null;if(r.member)i={firstName:r.member.firstName,lastName:r.member.lastName,nationalId:r.member.nationalId};else{let e=await u._.user.findUnique({where:{id:r.memberId},select:{firstName:!0,lastName:!0,nationalId:!0}});e&&(i={firstName:e.firstName,lastName:e.lastName,nationalId:e.nationalId})}return{valid:!0,passId:r.id,issuedAt:r.createdAt,sessionDate:s,church:n,member:i}},p=async e=>{let t=await a.P.findMany({where:{attendanceId:e},take:1});if(!t.length)throw new c.gz("No pass associated with this attendance",400);await a.P.delete(t[0].id)}},3502:(e,t,r)=>{r.d(t,{J:()=>s});var n=r(28362);let s=async e=>n.toDataURL(JSON.stringify({token:e}))}};