"use strict";(()=>{var e={};e.id=772,e.ids=[772],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},28769:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>H,patchFetch:()=>B,requestAsyncStorage:()=>P,routeModule:()=>q,serverHooks:()=>x,staticGenerationAsyncStorage:()=>j});var n={};r.r(n),r.d(n,{GET:()=>E,POST:()=>b});var i=r(49303),a=r(88716),s=r(60670),o=r(91585),d=r(5754),u=r(9846),c=r(38553),l=r(91941),h=r(46526),f={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},p=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,I=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,w=/^([+-])(\d{2})(?::?(\d{2}))?$/;function m(e){return e?parseInt(e):1}function y(e){return e&&parseFloat(e.replace(",","."))||0}var N=[31,null,31,30,31,30,31,31,30,31,30,31];function _(e){return e%400==0||e%4==0&&e%100!=0}var g=r(90542),v=r(92891),T=r(47833);let D={church:{select:{id:!0,name:!0,districtId:!0}},_count:{select:{attendance:!0}}},A=(e,t)=>{if("UNION_ADMIN"!==e.role){if("DISTRICT_ADMIN"===e.role){if(!e.districtId)throw new T.lY("No district assigned to this account");if(t.districtId&&t.districtId!==e.districtId)throw new T.lY("Cannot view sessions outside your district");return}if("CHURCH_ADMIN"===e.role){if(!e.churchId)throw new T.lY("No church assigned to this account");if(t.churchId&&t.churchId!==e.churchId)throw new T.lY("Cannot view sessions outside your church");return}throw new T.lY("Not allowed to view sessions")}},R=async(e,t={})=>{A(e,t);let r={};return t.districtId&&(r.church={districtId:t.districtId}),t.churchId&&(r.churchId=t.churchId),"DISTRICT_ADMIN"!==e.role||t.districtId||(r.church={districtId:e.districtId??void 0}),"CHURCH_ADMIN"!==e.role||t.churchId||(r.churchId=e.churchId??void 0),g.g.findMany({where:r,include:D,orderBy:{date:"desc"}})},M=async(e,t)=>{if("CHURCH_ADMIN"!==e.role)throw new T.lY("Only church admins can create sessions");if(!e.churchId)throw new T.lY("No church assigned to this account");let r=await v.d.findById(e.churchId,{where:{id:e.churchId},select:{id:!0}});if(!r)throw new T.dR("Church not found");return g.g.create({data:{churchId:r.id,date:t.date,theme:t.theme,createdById:e.id},include:D})},C=async e=>({sessions:await R(e.user,e.queryData??{})}),S=async e=>{if(!e.body)throw new T.p8("Missing request body");let t=function(e,t){!function(e,t){if(t.length<1)throw TypeError("1 argument required, but only "+t.length+" present")}(1,arguments);var r,n,i,a=function(e){if(null===e||!0===e||!1===e)return NaN;var t=Number(e);return isNaN(t)?t:t<0?Math.ceil(t):Math.floor(t)}(null!==(r=null==t?void 0:t.additionalDigits)&&void 0!==r?r:2);if(2!==a&&1!==a&&0!==a)throw RangeError("additionalDigits must be 0, 1 or 2");if(!("string"==typeof e||"[object String]"===Object.prototype.toString.call(e)))return new Date(NaN);var s=function(e){var t,r={},n=e.split(f.dateTimeDelimiter);if(n.length>2)return r;if(/:/.test(n[0])?t=n[0]:(r.date=n[0],t=n[1],f.timeZoneDelimiter.test(r.date)&&(r.date=e.split(f.timeZoneDelimiter)[0],t=e.substr(r.date.length,e.length))),t){var i=f.timezone.exec(t);i?(r.time=t.replace(i[1],""),r.timezone=i[1]):r.time=t}return r}(e);if(s.date){var o=function(e,t){var r=RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+t)+"})|(\\d{2}|[+-]\\d{"+(2+t)+"})$)"),n=e.match(r);if(!n)return{year:NaN,restDateString:""};var i=n[1]?parseInt(n[1]):null,a=n[2]?parseInt(n[2]):null;return{year:null===a?i:100*a,restDateString:e.slice((n[1]||n[2]).length)}}(s.date,a);n=function(e,t){if(null===t)return new Date(NaN);var r,n,i=e.match(p);if(!i)return new Date(NaN);var a=!!i[4],s=m(i[1]),o=m(i[2])-1,d=m(i[3]),u=m(i[4]),c=m(i[5])-1;if(a)return u>=1&&u<=53&&c>=0&&c<=6?((r=new Date(0)).setUTCFullYear(t,0,4),n=r.getUTCDay()||7,r.setUTCDate(r.getUTCDate()+((u-1)*7+c+1-n)),r):new Date(NaN);var l=new Date(0);return o>=0&&o<=11&&d>=1&&d<=(N[o]||(_(t)?29:28))&&s>=1&&s<=(_(t)?366:365)?(l.setUTCFullYear(t,o,Math.max(s,d)),l):new Date(NaN)}(o.restDateString,o.year)}if(!n||isNaN(n.getTime()))return new Date(NaN);var d=n.getTime(),u=0;if(s.time&&isNaN(u=function(e){var t=e.match(I);if(!t)return NaN;var r=y(t[1]),n=y(t[2]),i=y(t[3]);return(24===r?0===n&&0===i:i>=0&&i<60&&n>=0&&n<60&&r>=0&&r<25)?36e5*r+6e4*n+1e3*i:NaN}(s.time)))return new Date(NaN);if(s.timezone){if(isNaN(i=function(e){if("Z"===e)return 0;var t=e.match(w);if(!t)return 0;var r="+"===t[1]?-1:1,n=parseInt(t[2]),i=t[3]&&parseInt(t[3])||0;return i>=0&&i<=59?r*(36e5*n+6e4*i):NaN}(s.timezone)))return new Date(NaN)}else{var c=new Date(d+u),l=new Date(0);return l.setFullYear(c.getUTCFullYear(),c.getUTCMonth(),c.getUTCDate()),l.setHours(c.getUTCHours(),c.getUTCMinutes(),c.getUTCSeconds(),c.getUTCMilliseconds()),l}return new Date(d+u+i)}(e.body.date);if(Number.isNaN(t.getTime()))throw new T.p8("Invalid session date");let r={date:t,theme:e.body.theme};return{session:await M(e.user,r)}},O=o.Ry({districtId:o.Z_().optional(),churchId:o.Z_().optional()}),U=o.Ry({date:o.Z_().min(1,"Date is required"),theme:o.Z_().optional().nullable()}),E=(0,d.o)({middlewares:[(0,u.k)(["UNION_ADMIN","DISTRICT_ADMIN","CHURCH_ADMIN"]),(0,l.i)(O),(0,h.J$)({optional:!0}),(0,h.Dy)({optional:!0})],controller:C}),b=(0,d.o)({middlewares:[(0,u.k)(["CHURCH_ADMIN"]),(0,c.m)(U),(0,h.Dy)({key:"churchId",optional:!0})],controller:S}),q=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/sessions/route",pathname:"/api/sessions",filename:"route",bundlePath:"app/api/sessions/route"},resolvedPagePath:"/Volumes/Macintosh HD - Data/sda/sda-backend/app/api/sessions/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:P,staticGenerationAsyncStorage:j,serverHooks:x}=q,H="/api/sessions/route";function B(){return(0,s.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:j})}},37848:(e,t,r)=>{r.d(t,{O:()=>s});let n=e=>{let t=process.env[e];if(!t)throw Error(`Missing required environment variable: ${e}`);return t},i="http://localhost:3000",a=(process.env.CORS_ORIGIN??i).split(",").map(e=>e.trim()).filter(Boolean),s={DATABASE_URL:n("DATABASE_URL"),JWT_SECRET:n("JWT_SECRET"),SMS_API_KEY:process.env.SMS_API_KEY??"",CORS_ORIGIN:process.env.CORS_ORIGIN??i,PRIMARY_ORIGIN:a[0]??i,TWILIO_ACCOUNT_SID:process.env.TWILIO_ACCOUNT_SID??"",TWILIO_AUTH_TOKEN:process.env.TWILIO_AUTH_TOKEN??"",TWILIO_FROM_NUMBER:process.env.TWILIO_FROM_NUMBER??"",GMAIL_USER:process.env.GMAIL_USER,GMAIL_APP_PASSWORD:process.env.GMAIL_APP_PASSWORD,GMAIL_FROM_NAME:process.env.GMAIL_FROM_NAME||"Umuganda SDA",SMTP_HOST:process.env.SMTP_HOST||"smtp.gmail.com",SMTP_PORT:process.env.SMTP_PORT||"587",SMTP_SECURE:process.env.SMTP_SECURE||"false"}},47833:(e,t,r)=>{r.d(t,{AY:()=>o,HC:()=>u,dR:()=>s,gz:()=>n,lY:()=>a,p8:()=>d,yj:()=>i});class n extends Error{constructor(e,t=400,r){super(e),this.name="AppError",this.status=t,this.details=r}}class i extends n{constructor(e="Unauthorized"){super(e,401),this.name="UnauthorizedError"}}class a extends n{constructor(e="Forbidden"){super(e,403),this.name="ForbiddenError"}}class s extends n{constructor(e="Resource not found"){super(e,404),this.name="NotFoundError"}}class o extends n{constructor(e="Conflict"){super(e,409),this.name="ConflictError"}}class d extends n{constructor(e="Validation failed",t){super(e,422,t),this.name="ValidationError"}}let u=e=>e instanceof n},9293:(e,t,r)=>{r.d(t,{X:()=>d});var n=r(87070),i=r(26033),a=r(47833),s=r(37848);let o=(e,t)=>n.NextResponse.json(e,t),d=async(e,t)=>{if("OPTIONS"===e.method)return h(new n.NextResponse(null,{status:204}),e);try{let r;let i=await t();return r=i instanceof n.NextResponse?i:o({data:i}),h(r,e)}catch(r){let t;if(r instanceof i.jm){let e=new a.p8("Validation failed",r.flatten());t=n.NextResponse.json({error:e.message,details:e.details},{status:e.status})}else(0,a.HC)(r)?t=n.NextResponse.json({error:r.message,details:r.details},{status:r.status}):(r instanceof Error?console.error(r):console.error("Unknown error",r),t=n.NextResponse.json({error:"Internal Server Error"},{status:500}));return h(t,e)}},u=e=>e.replace(/^"|"$/g,"").replace(/^'|'$/g,""),c=e=>u(e).replace(/\/$/,""),l=()=>s.O.CORS_ORIGIN?s.O.CORS_ORIGIN.split(",").map(e=>e.trim()).filter(Boolean).map(e=>c(e)):[],h=(e,t)=>{let r=l();if(!r.length)return e;let n=t?.headers.get("origin")??null,i=n?c(n):null,a=null;if(i&&r.includes(i)?a=i:i&&r.includes("*")?a=i:1===r.length&&(a=r[0]),!a&&r.length&&(a=r[0]),!a)return e;e.headers.set("Access-Control-Allow-Origin",a);let s=t?.headers.get("access-control-request-headers");return e.headers.set("Access-Control-Allow-Methods","GET,POST,PUT,PATCH,DELETE,OPTIONS"),e.headers.set("Access-Control-Allow-Headers",s&&s.length?s:"Content-Type,Authorization,Accept"),e.headers.set("Access-Control-Allow-Credentials","true"),e.headers.set("Access-Control-Max-Age","600"),e.headers.set("Vary","Origin"),e}},13538:(e,t,r)=>{r.d(t,{_:()=>i});var n=r(53524);let i=globalThis.prisma??new n.PrismaClient({log:["error"]})},5754:(e,t,r)=>{r.d(t,{o:()=>i});var n=r(9293);let i=({middlewares:e=[],controller:t})=>async(r,i)=>(0,n.X)(r,async()=>{let n=new URL(r.url),a={req:r,params:i?.params??{},query:n.searchParams};for(let t of e)a=await t(a);return t({...a,params:a.params})})},46526:(e,t,r)=>{r.d(t,{Dy:()=>c,J$:()=>u});var n=r(13538),i=r(47833);let a=async(e,t)=>{let r=await n._.district.findUnique({where:{id:t},include:{union:!0}});if(!r)throw new i.dR("District not found");if("UNION_ADMIN"===e.role||"DISTRICT_ADMIN"===e.role&&e.districtId===t)return r;throw new i.lY("Not allowed to access this district")},s=async(e,t)=>{let r=await n._.church.findUnique({where:{id:t},include:{district:{include:{union:!0}}}});if(!r)throw new i.dR("Church not found");if("UNION_ADMIN"===e.role||"DISTRICT_ADMIN"===e.role&&e.districtId===r.districtId||"CHURCH_ADMIN"===e.role&&e.churchId===t)return r;throw new i.lY("Not allowed to access this church")},o=(e,t)=>{let r="paramsData"in e&&e.paramsData&&"object"==typeof e.paramsData?e.paramsData[t]:void 0,n=e.params?.[t],i="queryData"in e&&e.queryData&&"object"==typeof e.queryData?e.queryData[t]:void 0,a="body"in e&&e.body&&"object"==typeof e.body?e.body[t]:void 0,s=r??n??i??a;return"string"==typeof s&&s.trim().length>0?s:void 0},d=(e,t,{optional:r}={})=>{let n=o(e,t);if(!n&&!r)throw new i.p8(`Missing or invalid identifier for ${t}`);return n},u=(e={})=>{let t=e.key??"districtId",r=e.optional??!1;return async e=>{if(!e.user)throw new i.yj("Authentication required");let n=d(e,t,{optional:r});if(!n)return{...e,district:e.district};let s=await a(e.user,n);return{...e,district:s}}},c=(e={})=>{let t=e.key??"churchId",r=e.optional??!1;return async e=>{if(!e.user)throw new i.yj("Authentication required");let n=d(e,t,{optional:r});if(!n)return{...e,church:e.church};let a=await s(e.user,n);return{...e,church:a}}}},9846:(e,t,r)=>{r.d(t,{k:()=>s});var n=r(47833),i=r(75145);let a=e=>{let t=e.headers.get("authorization")??e.headers.get("Authorization");if(!t)throw new n.yj("Missing Authorization header");let r=t.split(" ");if(2!==r.length||"Bearer"!==r[0])throw new n.yj("Malformed Authorization header");return r[1]},s=e=>async t=>{let r=a(t.req),s=await (0,i.Sk)(r);if(e&&!e.includes(s.role))throw new n.yj("Insufficient permissions");return{...t,user:s}}},38553:(e,t,r)=>{r.d(t,{m:()=>a});var n=r(26033),i=r(47833);let a=e=>async t=>{let r;try{r=await t.req.json()}catch(t){if(e.isOptional())r=void 0;else throw new i.p8("Invalid JSON body")}try{let n=e.parse(r);return{...t,body:n}}catch(e){if(e instanceof n.jm)throw new i.p8("Validation failed",e.flatten());throw e}}},91941:(e,t,r)=>{r.d(t,{i:()=>a});var n=r(26033),i=r(47833);let a=e=>async t=>{let r=Object.fromEntries(t.query.entries());try{let n=e.parse(r);return{...t,queryData:n}}catch(e){if(e instanceof n.jm)throw new i.p8("Invalid query parameters",e.flatten());throw e}}},92891:(e,t,r)=>{r.d(t,{d:()=>i});var n=r(13538);let i={findById:(e,t)=>n._.church.findUnique({...t??{},where:{id:e}}),findMany:e=>n._.church.findMany(e),create:e=>n._.church.create(e),update:e=>n._.church.update(e),delete:e=>n._.church.delete(e),count:e=>n._.church.count(e)}},90542:(e,t,r)=>{r.d(t,{g:()=>i});var n=r(13538);let i={findById:(e,t)=>n._.umugandaSession.findUnique({where:{id:e},...t??{}}),findMany:e=>n._.umugandaSession.findMany(e),create:e=>n._.umugandaSession.create(e),update:e=>n._.umugandaSession.update(e),delete:e=>n._.umugandaSession.delete(e)}},54164:(e,t,r)=>{r.d(t,{T:()=>i});var n=r(13538);let i={findById:(e,t)=>n._.user.findUnique({where:{id:e},...t??{}}),findByUsername:(e,t)=>n._.user.findUnique({where:{username:e},...t??{}}),findByEmail:(e,t)=>n._.user.findUnique({where:{email:e},...t??{}}),findByPhoneNumber:(e,t)=>n._.user.findUnique({where:{phoneNumber:e},...t??{}}),findByNationalId:(e,t)=>n._.user.findUnique({where:{nationalId:e},...t??{}}),findMany:e=>n._.user.findMany(e),count:e=>n._.user.count(e),create:e=>n._.user.create(e),update:e=>n._.user.update(e),delete:e=>n._.user.delete(e)}},75145:(e,t,r)=>{r.d(t,{$N:()=>w,Sk:()=>I,c_:()=>h});var n=r(42023),i=r.n(n),a=r(41482),s=r.n(a),o=r(53524),d=r(13538),u=r(37848),c=r(47833),l=r(54164);let h=async e=>{let t=await i().genSalt(10);return i().hash(e,t)},f=async(e,t)=>i().compare(e,t),p=e=>{let t={sub:e.id,role:e.role,unionId:e.unionId,districtId:e.districtId,churchId:e.churchId};return s().sign(t,u.O.JWT_SECRET,{expiresIn:43200})},I=async e=>{try{let t=s().verify(e,u.O.JWT_SECRET),r=await d._.user.findUnique({where:{id:t.sub}});if(!r)throw new c.yj("User not found");if(!r.isActive)throw new c.yj("Account disabled");return r}catch(e){if(e instanceof c.yj)throw e;throw new c.yj("Invalid token")}},w=async({email:e,phoneNumber:t,password:r})=>{let n=null;if(t){if(!(n=await l.T.findByPhoneNumber(t))||!n.isActive)throw new c.yj("Invalid credentials");if(n.role!==o.Role.MEMBER)throw new c.yj("Phone number login is restricted to members")}else if(e){if(!(n=await l.T.findByEmail(e))||!n.isActive)throw new c.yj("Invalid credentials");if(n.role===o.Role.MEMBER)throw new c.yj("Members must sign in with their phone number")}else throw new c.yj("Email or phone number is required");if(!await f(r,n.passwordHash))throw new c.yj("Invalid credentials");let i=p({id:n.id,role:n.role,unionId:n.unionId,districtId:n.districtId,churchId:n.churchId}),{passwordHash:a,...s}=n;return{token:i,user:s}}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[416,585],()=>r(28769));module.exports=n})();