"use strict";(()=>{var e={};e.id=694,e.ids=[694],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},32694:e=>{e.exports=require("http2")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},57877:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>v,requestAsyncStorage:()=>m,routeModule:()=>f,serverHooks:()=>q,staticGenerationAsyncStorage:()=>y});var a={};r.r(a),r.d(a,{PATCH:()=>w});var n=r(49303),s=r(88716),i=r(60670),d=r(91585),c=r(5754),o=r(9846),u=r(81423),h=r(38553),l=r(16178);let p=d.Ry({status:d.Km(["PENDING","APPROVED"]),issuePass:d.O7().optional()}),I=d.Ry({attendanceId:d.Z_().min(1,"Attendance ID is required")}),w=(0,c.o)({middlewares:[(0,o.k)(["CHURCH_ADMIN"]),(0,u.r)(I),(0,h.m)(p)],controller:l.cQ}),f=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/attendance/[attendanceId]/route",pathname:"/api/attendance/[attendanceId]",filename:"route",bundlePath:"app/api/attendance/[attendanceId]/route"},resolvedPagePath:"/Volumes/Macintosh HD - Data/sda/sda-backend/app/api/attendance/[attendanceId]/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:y,serverHooks:q}=f,x="/api/attendance/[attendanceId]/route";function v(){return(0,i.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:y})}},16178:(e,t,r)=>{r.d(t,{Us:()=>n,cQ:()=>i,qf:()=>s});var a=r(17913);let n=async e=>({attendance:await (0,a.yG)(e.user,e.queryData??{})}),s=async e=>{if(!e.body)throw Error("Missing request body");return{attendance:await (0,a.Ld)(e.user,e.body)}},i=async e=>{if(!e.body)throw Error("Missing request body");let{attendance:t,pass:r}=await (0,a.$c)(e.user,e.paramsData.attendanceId,e.body);return r?{attendance:t,pass:r}:{attendance:t}}},38553:(e,t,r)=>{r.d(t,{m:()=>s});var a=r(26033),n=r(47833);let s=e=>async t=>{let r;try{r=await t.req.json()}catch(t){if(e.isOptional())r=void 0;else throw new n.p8("Invalid JSON body")}try{let a=e.parse(r);return{...t,body:a}}catch(e){if(e instanceof a.jm)throw new n.p8("Validation failed",e.flatten());throw e}}},81423:(e,t,r)=>{r.d(t,{r:()=>s});var a=r(26033),n=r(47833);let s=e=>async t=>{try{let r=e.parse(t.params);return{...t,paramsData:r}}catch(e){if(e instanceof a.jm)throw new n.p8("Invalid route parameters",e.flatten());throw e}}},90542:(e,t,r)=>{r.d(t,{g:()=>n});var a=r(13538);let n={findById:(e,t)=>a._.umugandaSession.findUnique({where:{id:e},...t??{}}),findMany:e=>a._.umugandaSession.findMany(e),create:e=>a._.umugandaSession.create(e),update:e=>a._.umugandaSession.update(e),delete:e=>a._.umugandaSession.delete(e)}},17913:(e,t,r)=>{r.d(t,{$c:()=>I,Ld:()=>p,qN:()=>h,yG:()=>l});var a=r(53524),n=r(57243),s=r(90542),i=r(54164),d=r(47833),c=r(57303);let o={member:{select:{id:!0,firstName:!0,lastName:!0,nationalId:!0,phoneNumber:!0}},session:{select:{id:!0,date:!0,church:{select:{id:!0,name:!0,districtId:!0}}}},pass:{select:{id:!0,token:!0,smsSentAt:!0}},approvedBy:{select:{id:!0,firstName:!0,lastName:!0}}},u={session:{select:{id:!0,churchId:!0}},pass:!0},h=(e,t={})=>{let r={},a={};if(t.status&&(r.status=t.status),t.sessionId&&(r.sessionId=t.sessionId),"UNION_ADMIN"===e.role){if(!e.unionId)throw new d.lY("No union assigned to this account");a.church={is:{district:{is:{unionId:e.unionId}},...t.districtId?{districtId:t.districtId}:{},...t.churchId?{id:t.churchId}:{}}}}else if("DISTRICT_ADMIN"===e.role){if(!e.districtId)throw new d.lY("No district assigned to this account");if(t.districtId&&t.districtId!==e.districtId)throw new d.lY("Cannot view attendance outside your district");a.church={is:{districtId:e.districtId,...t.churchId?{id:t.churchId}:{}}}}else if("CHURCH_ADMIN"===e.role){if(!e.churchId)throw new d.lY("No church assigned to this account");if(t.churchId&&t.churchId!==e.churchId)throw new d.lY("Cannot view attendance outside your church");a.churchId=e.churchId}else throw new d.lY("Not allowed to view attendance");return Object.keys(a).length>0&&(r.session={is:a}),r},l=async(e,t={})=>{let r=h(e,t);return n.v.findMany({where:r,include:o,orderBy:{createdAt:"desc"}})},p=async(e,t)=>{if("CHURCH_ADMIN"!==e.role)throw new d.lY("Only church admins can record attendance");if(!e.churchId)throw new d.lY("No church assigned to this account");let r=await s.g.findById(t.sessionId,{include:{church:{select:{id:!0}}}});if(!r)throw new d.dR("Session not found");if(r.churchId!==e.churchId)throw new d.lY("Cannot record attendance for another church");let c=await i.T.findById(t.memberId,{select:{id:!0,role:!0,churchId:!0}});if(!c||"MEMBER"!==c.role)throw new d.dR("Member not found");if(c.churchId!==e.churchId)throw new d.lY("Member belongs to another church");try{return await n.v.create({data:{sessionId:t.sessionId,memberId:t.memberId},include:o})}catch(e){if(e instanceof a.Prisma.PrismaClientKnownRequestError&&"P2002"===e.code)throw new d.AY("Attendance already recorded for this member");throw e}},I=async(e,t,r)=>{if("CHURCH_ADMIN"!==e.role)throw new d.lY("Only church admins can update attendance");if(!e.churchId)throw new d.lY("No church assigned to this account");let s=await n.v.findById(t,{include:u});if(!s)throw new d.dR("Attendance record not found");if(s.session.churchId!==e.churchId)throw new d.lY("Cannot modify attendance outside your church");let i=await n.v.update({where:{id:t},data:{status:r.status,approvedById:r.status===a.AttendanceStatus.APPROVED?e.id:null},include:o});return r.status===a.AttendanceStatus.APPROVED&&(r.issuePass??!0)?{attendance:i,pass:await (0,c.QE)(t)}:(r.status===a.AttendanceStatus.PENDING&&i.pass&&await (0,c.qc)(t),{attendance:i})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[416,585,558,362,994],()=>r(57877));module.exports=a})();