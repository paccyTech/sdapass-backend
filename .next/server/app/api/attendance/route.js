"use strict";(()=>{var e={};e.id=996,e.ids=[996],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},32694:e=>{e.exports=require("http2")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},57812:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>A,patchFetch:()=>x,requestAsyncStorage:()=>D,routeModule:()=>N,serverHooks:()=>v,staticGenerationAsyncStorage:()=>b});var i={};r.r(i),r.d(i,{GET:()=>y,OPTIONS:()=>q,POST:()=>m});var n=r(49303),a=r(88716),s=r(60670),d=r(87070),o=r(91585),c=r(5754),u=r(9846),h=r(38553),l=r(91941),p=r(46526),I=r(16178);let w=o.Ry({districtId:o.Z_().optional(),churchId:o.Z_().optional(),sessionId:o.Z_().optional(),status:o.Km(["PENDING","APPROVED"]).optional()}),f=o.Ry({sessionId:o.Z_().min(1,"Session is required"),memberId:o.Z_().min(1,"Member is required")}),y=(0,c.o)({middlewares:[(0,u.k)(["UNION_ADMIN","DISTRICT_ADMIN","CHURCH_ADMIN"]),(0,l.i)(w)],controller:I.Us}),m=(0,c.o)({middlewares:[(0,u.k)(["CHURCH_ADMIN"]),(0,h.m)(f),(0,p.Dy)({key:"sessionId",optional:!0})],controller:I.qf}),q=(0,c.o)({controller:async()=>new d.NextResponse(null,{status:204})}),N=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/attendance/route",pathname:"/api/attendance",filename:"route",bundlePath:"app/api/attendance/route"},resolvedPagePath:"/Volumes/Macintosh HD - Data/sda/sda-backend/app/api/attendance/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:D,staticGenerationAsyncStorage:b,serverHooks:v}=N,A="/api/attendance/route";function x(){return(0,s.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:b})}},16178:(e,t,r)=>{r.d(t,{Us:()=>n,cQ:()=>s,qf:()=>a});var i=r(17913);let n=async e=>({attendance:await (0,i.yG)(e.user,e.queryData??{})}),a=async e=>{if(!e.body)throw Error("Missing request body");return{attendance:await (0,i.Ld)(e.user,e.body)}},s=async e=>{if(!e.body)throw Error("Missing request body");let{attendance:t,pass:r}=await (0,i.$c)(e.user,e.paramsData.attendanceId,e.body);return r?{attendance:t,pass:r}:{attendance:t}}},46526:(e,t,r)=>{r.d(t,{Dy:()=>u,J$:()=>c});var i=r(13538),n=r(47833);let a=async(e,t)=>{let r=await i._.district.findUnique({where:{id:t},include:{union:!0}});if(!r)throw new n.dR("District not found");if("UNION_ADMIN"===e.role||"DISTRICT_ADMIN"===e.role&&e.districtId===t)return r;throw new n.lY("Not allowed to access this district")},s=async(e,t)=>{let r=await i._.church.findUnique({where:{id:t},include:{district:{include:{union:!0}}}});if(!r)throw new n.dR("Church not found");if("UNION_ADMIN"===e.role||"DISTRICT_ADMIN"===e.role&&e.districtId===r.districtId||"CHURCH_ADMIN"===e.role&&e.churchId===t)return r;throw new n.lY("Not allowed to access this church")},d=(e,t)=>{let r="paramsData"in e&&e.paramsData&&"object"==typeof e.paramsData?e.paramsData[t]:void 0,i=e.params?.[t],n="queryData"in e&&e.queryData&&"object"==typeof e.queryData?e.queryData[t]:void 0,a="body"in e&&e.body&&"object"==typeof e.body?e.body[t]:void 0,s=r??i??n??a;return"string"==typeof s&&s.trim().length>0?s:void 0},o=(e,t,{optional:r}={})=>{let i=d(e,t);if(!i&&!r)throw new n.p8(`Missing or invalid identifier for ${t}`);return i},c=(e={})=>{let t=e.key??"districtId",r=e.optional??!1;return async e=>{if(!e.user)throw new n.yj("Authentication required");let i=o(e,t,{optional:r});if(!i)return{...e,district:e.district};let s=await a(e.user,i);return{...e,district:s}}},u=(e={})=>{let t=e.key??"churchId",r=e.optional??!1;return async e=>{if(!e.user)throw new n.yj("Authentication required");let i=o(e,t,{optional:r});if(!i)return{...e,church:e.church};let a=await s(e.user,i);return{...e,church:a}}}},38553:(e,t,r)=>{r.d(t,{m:()=>a});var i=r(26033),n=r(47833);let a=e=>async t=>{let r;try{r=await t.req.json()}catch(t){if(e.isOptional())r=void 0;else throw new n.p8("Invalid JSON body")}try{let i=e.parse(r);return{...t,body:i}}catch(e){if(e instanceof i.jm)throw new n.p8("Validation failed",e.flatten());throw e}}},91941:(e,t,r)=>{r.d(t,{i:()=>a});var i=r(26033),n=r(47833);let a=e=>async t=>{let r=Object.fromEntries(t.query.entries());try{let i=e.parse(r);return{...t,queryData:i}}catch(e){if(e instanceof i.jm)throw new n.p8("Invalid query parameters",e.flatten());throw e}}},90542:(e,t,r)=>{r.d(t,{g:()=>n});var i=r(13538);let n={findById:(e,t)=>i._.umugandaSession.findUnique({where:{id:e},...t??{}}),findMany:e=>i._.umugandaSession.findMany(e),create:e=>i._.umugandaSession.create(e),update:e=>i._.umugandaSession.update(e),delete:e=>i._.umugandaSession.delete(e)}},17913:(e,t,r)=>{r.d(t,{$c:()=>I,Ld:()=>p,qN:()=>h,yG:()=>l});var i=r(53524),n=r(57243),a=r(90542),s=r(54164),d=r(47833),o=r(57303);let c={member:{select:{id:!0,firstName:!0,lastName:!0,nationalId:!0,phoneNumber:!0}},session:{select:{id:!0,date:!0,church:{select:{id:!0,name:!0,districtId:!0}}}},pass:{select:{id:!0,token:!0,smsSentAt:!0}},approvedBy:{select:{id:!0,firstName:!0,lastName:!0}}},u={session:{select:{id:!0,churchId:!0}},pass:!0},h=(e,t={})=>{let r={},i={};if(t.status&&(r.status=t.status),t.sessionId&&(r.sessionId=t.sessionId),"UNION_ADMIN"===e.role){if(!e.unionId)throw new d.lY("No union assigned to this account");i.church={is:{district:{is:{unionId:e.unionId}},...t.districtId?{districtId:t.districtId}:{},...t.churchId?{id:t.churchId}:{}}}}else if("DISTRICT_ADMIN"===e.role){if(!e.districtId)throw new d.lY("No district assigned to this account");if(t.districtId&&t.districtId!==e.districtId)throw new d.lY("Cannot view attendance outside your district");i.church={is:{districtId:e.districtId,...t.churchId?{id:t.churchId}:{}}}}else if("CHURCH_ADMIN"===e.role){if(!e.churchId)throw new d.lY("No church assigned to this account");if(t.churchId&&t.churchId!==e.churchId)throw new d.lY("Cannot view attendance outside your church");i.churchId=e.churchId}else throw new d.lY("Not allowed to view attendance");return Object.keys(i).length>0&&(r.session={is:i}),r},l=async(e,t={})=>{let r=h(e,t);return n.v.findMany({where:r,include:c,orderBy:{createdAt:"desc"}})},p=async(e,t)=>{if("CHURCH_ADMIN"!==e.role)throw new d.lY("Only church admins can record attendance");if(!e.churchId)throw new d.lY("No church assigned to this account");let r=await a.g.findById(t.sessionId,{include:{church:{select:{id:!0}}}});if(!r)throw new d.dR("Session not found");if(r.churchId!==e.churchId)throw new d.lY("Cannot record attendance for another church");let o=await s.T.findById(t.memberId,{select:{id:!0,role:!0,churchId:!0}});if(!o||"MEMBER"!==o.role)throw new d.dR("Member not found");if(o.churchId!==e.churchId)throw new d.lY("Member belongs to another church");try{return await n.v.create({data:{sessionId:t.sessionId,memberId:t.memberId},include:c})}catch(e){if(e instanceof i.Prisma.PrismaClientKnownRequestError&&"P2002"===e.code)throw new d.AY("Attendance already recorded for this member");throw e}},I=async(e,t,r)=>{if("CHURCH_ADMIN"!==e.role)throw new d.lY("Only church admins can update attendance");if(!e.churchId)throw new d.lY("No church assigned to this account");let a=await n.v.findById(t,{include:u});if(!a)throw new d.dR("Attendance record not found");if(a.session.churchId!==e.churchId)throw new d.lY("Cannot modify attendance outside your church");let s=await n.v.update({where:{id:t},data:{status:r.status,approvedById:r.status===i.AttendanceStatus.APPROVED?e.id:null},include:c});return r.status===i.AttendanceStatus.APPROVED&&(r.issuePass??!0)?{attendance:s,pass:await (0,o.QE)(t)}:(r.status===i.AttendanceStatus.PENDING&&s.pass&&await (0,o.qc)(t),{attendance:s})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[416,585,558,362,994],()=>r(57812));module.exports=i})();