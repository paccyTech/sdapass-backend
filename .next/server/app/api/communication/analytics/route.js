"use strict";(()=>{var e={};e.id=220,e.ids=[220],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},69021:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>R,requestAsyncStorage:()=>_,routeModule:()=>E,serverHooks:()=>S,staticGenerationAsyncStorage:()=>I});var s={};r.r(s),r.d(s,{GET:()=>A});var a=r(49303),n=r(88716),i=r(60670),o=r(5754),d=r(9846),l=r(53524),c=r(13538),u=r(47833);let m=e=>{if(!e)return;let t=new Date(e);return Number.isNaN(t.getTime())?void 0:t},h=async(e,t={})=>{if("CHURCH_ADMIN"!==e.role||!e.churchId)throw new u.lY("Only church admins can view communication analytics");let r=m(t.fromDate),s=m(t.toDate),a=await c._.memberPass.aggregate({where:{member:{churchId:e.churchId},...r||s?{createdAt:{...r?{gte:r}:{},...s?{lte:s}:{}}}:{},smsSentAt:{not:null}},_count:{_all:!0}}),n=await c._.passwordResetToken.aggregate({where:{user:{churchId:e.churchId},...r||s?{createdAt:{...r?{gte:r}:{},...s?{lte:s}:{}}}:{}},_count:{_all:!0}}),i=s?new Date(s):new Date,o=r?new Date(r):new Date;o.setDate(i.getDate()-13);let d=(await c._.$queryRaw`
    SELECT 
      DATE_TRUNC('day', date_series)::date as date,
      COALESCE(sms.count, 0) as "smsCount",
      COALESCE(reset.count, 0) as "resetCount"
    FROM 
      generate_series(${o}::timestamp, ${i}::timestamp, '1 day'::interval) as date_series
    LEFT JOIN (
      SELECT 
        DATE_TRUNC('day', "createdAt") as day,
        COUNT(*) as count
      FROM "MemberPass"
      WHERE "memberId" IN (
        SELECT id FROM "User" WHERE "churchId" = ${e.churchId}
      )
      ${r||s?l.Prisma.sql`AND "createdAt" BETWEEN ${r||new Date(0)} AND ${s||new Date}`:l.Prisma.empty}
      GROUP BY day
    ) sms ON DATE_TRUNC('day', date_series) = sms.day
    LEFT JOIN (
      SELECT 
        DATE_TRUNC('day', "createdAt") as day,
        COUNT(*) as count
      FROM "PasswordResetToken"
      WHERE "userId" IN (
        SELECT id FROM "User" WHERE "churchId" = ${e.churchId}
      )
      ${r||s?l.Prisma.sql`AND "createdAt" BETWEEN ${r||new Date(0)} AND ${s||new Date}`:l.Prisma.empty}
      GROUP BY day
    ) reset ON DATE_TRUNC('day', date_series) = reset.day
    ORDER BY date
  `).map(e=>({date:e.date,smsSent:Number(e.smsCount),emailSent:Number(e.resetCount)}));return{sms:{totalSent:a._count._all,delivered:a._count._all,failed:0,queued:0,lastSentAt:await c._.memberPass.findFirst({where:{member:{churchId:e.churchId},smsSentAt:{not:null}},orderBy:{smsSentAt:"desc"},select:{smsSentAt:!0}}).then(e=>e?.smsSentAt?.toISOString()||null)},email:{totalSent:n._count._all,delivered:n._count._all,failed:0,queued:0,lastSentAt:await c._.passwordResetToken.findFirst({where:{user:{churchId:e.churchId}},orderBy:{createdAt:"desc"},select:{createdAt:!0}}).then(e=>e?.createdAt.toISOString()||null)},timeline:d,recent:await p(e.churchId,5)}};async function p(e,t){let r=await c._.memberPass.findMany({where:{member:{churchId:e},smsSentAt:{not:null}},orderBy:{smsSentAt:"desc"},take:t,select:{id:!0,smsSentAt:!0,member:{select:{firstName:!0,lastName:!0,phoneNumber:!0}}}}),s=await c._.passwordResetToken.findMany({where:{user:{churchId:e}},orderBy:{createdAt:"desc"},take:t,select:{id:!0,createdAt:!0,user:{select:{firstName:!0,lastName:!0,email:!0}}}});return[...r.map(e=>({id:`sms-${e.id}`,channel:"SMS",recipient:e.member.phoneNumber,status:"DELIVERED",sentAt:e.smsSentAt?.toISOString()||new Date().toISOString(),snippet:`Welcome ${e.member.firstName}, your Umuganda pass is ready.`})),...s.map(e=>({id:`email-${e.id}`,channel:"Email",recipient:e.user.email||"No email",status:"DELIVERED",sentAt:e.createdAt.toISOString(),snippet:"Password reset instructions"}))].sort((e,t)=>new Date(t.sentAt).getTime()-new Date(e.sentAt).getTime()).slice(0,t)}let w=async e=>{let{fromDate:t,toDate:r}=e.queryData||{};return await h(e.user,{fromDate:t,toDate:r})},A=(0,o.o)({middlewares:[(0,d.k)()],controller:w}),E=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/communication/analytics/route",pathname:"/api/communication/analytics",filename:"route",bundlePath:"app/api/communication/analytics/route"},resolvedPagePath:"/Volumes/Macintosh HD - Data/sda/sda-backend/app/api/communication/analytics/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:_,staticGenerationAsyncStorage:I,serverHooks:S}=E,y="/api/communication/analytics/route";function R(){return(0,i.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:I})}},37848:(e,t,r)=>{r.d(t,{O:()=>i});let s=e=>{let t=process.env[e];if(!t)throw Error(`Missing required environment variable: ${e}`);return t},a="http://localhost:3000",n=(process.env.CORS_ORIGIN??a).split(",").map(e=>e.trim()).filter(Boolean),i={DATABASE_URL:s("DATABASE_URL"),JWT_SECRET:s("JWT_SECRET"),SMS_API_KEY:process.env.SMS_API_KEY??"",CORS_ORIGIN:process.env.CORS_ORIGIN??a,PRIMARY_ORIGIN:n[0]??a,TWILIO_ACCOUNT_SID:process.env.TWILIO_ACCOUNT_SID??"",TWILIO_AUTH_TOKEN:process.env.TWILIO_AUTH_TOKEN??"",TWILIO_FROM_NUMBER:process.env.TWILIO_FROM_NUMBER??"",GMAIL_USER:process.env.GMAIL_USER,GMAIL_APP_PASSWORD:process.env.GMAIL_APP_PASSWORD,GMAIL_FROM_NAME:process.env.GMAIL_FROM_NAME||"Umuganda SDA",SMTP_HOST:process.env.SMTP_HOST||"smtp.gmail.com",SMTP_PORT:process.env.SMTP_PORT||"587",SMTP_SECURE:process.env.SMTP_SECURE||"false"}},47833:(e,t,r)=>{r.d(t,{AY:()=>o,HC:()=>l,dR:()=>i,gz:()=>s,lY:()=>n,p8:()=>d,yj:()=>a});class s extends Error{constructor(e,t=400,r){super(e),this.name="AppError",this.status=t,this.details=r}}class a extends s{constructor(e="Unauthorized"){super(e,401),this.name="UnauthorizedError"}}class n extends s{constructor(e="Forbidden"){super(e,403),this.name="ForbiddenError"}}class i extends s{constructor(e="Resource not found"){super(e,404),this.name="NotFoundError"}}class o extends s{constructor(e="Conflict"){super(e,409),this.name="ConflictError"}}class d extends s{constructor(e="Validation failed",t){super(e,422,t),this.name="ValidationError"}}let l=e=>e instanceof s},9293:(e,t,r)=>{r.d(t,{X:()=>d});var s=r(87070),a=r(26033),n=r(47833),i=r(37848);let o=(e,t)=>s.NextResponse.json(e,t),d=async(e,t)=>{if("OPTIONS"===e.method)return m(new s.NextResponse(null,{status:204}),e);try{let r;let a=await t();return r=a instanceof s.NextResponse?a:o({data:a}),m(r,e)}catch(r){let t;if(r instanceof a.jm){let e=new n.p8("Validation failed",r.flatten());t=s.NextResponse.json({error:e.message,details:e.details},{status:e.status})}else(0,n.HC)(r)?t=s.NextResponse.json({error:r.message,details:r.details},{status:r.status}):(r instanceof Error?console.error(r):console.error("Unknown error",r),t=s.NextResponse.json({error:"Internal Server Error"},{status:500}));return m(t,e)}},l=e=>e.replace(/^"|"$/g,"").replace(/^'|'$/g,""),c=e=>l(e).replace(/\/$/,""),u=()=>i.O.CORS_ORIGIN?i.O.CORS_ORIGIN.split(",").map(e=>e.trim()).filter(Boolean).map(e=>c(e)):[],m=(e,t)=>{let r=u();if(!r.length)return e;let s=t?.headers.get("origin")??null,a=s?c(s):null,n=null;if(a&&r.includes(a)?n=a:a&&r.includes("*")?n=a:1===r.length&&(n=r[0]),!n&&r.length&&(n=r[0]),!n)return e;e.headers.set("Access-Control-Allow-Origin",n);let i=t?.headers.get("access-control-request-headers");return e.headers.set("Access-Control-Allow-Methods","GET,POST,PUT,PATCH,DELETE,OPTIONS"),e.headers.set("Access-Control-Allow-Headers",i&&i.length?i:"Content-Type,Authorization,Accept"),e.headers.set("Access-Control-Allow-Credentials","true"),e.headers.set("Access-Control-Max-Age","600"),e.headers.set("Vary","Origin"),e}},13538:(e,t,r)=>{r.d(t,{_:()=>a});var s=r(53524);let a=globalThis.prisma??new s.PrismaClient({log:["error"]})},5754:(e,t,r)=>{r.d(t,{o:()=>a});var s=r(9293);let a=({middlewares:e=[],controller:t})=>async(r,a)=>(0,s.X)(r,async()=>{let s=new URL(r.url),n={req:r,params:a?.params??{},query:s.searchParams};for(let t of e)n=await t(n);return t({...n,params:n.params})})},9846:(e,t,r)=>{r.d(t,{k:()=>i});var s=r(47833),a=r(75145);let n=e=>{let t=e.headers.get("authorization")??e.headers.get("Authorization");if(!t)throw new s.yj("Missing Authorization header");let r=t.split(" ");if(2!==r.length||"Bearer"!==r[0])throw new s.yj("Malformed Authorization header");return r[1]},i=e=>async t=>{let r=n(t.req),i=await (0,a.Sk)(r);if(e&&!e.includes(i.role))throw new s.yj("Insufficient permissions");return{...t,user:i}}},54164:(e,t,r)=>{r.d(t,{T:()=>a});var s=r(13538);let a={findById:(e,t)=>s._.user.findUnique({where:{id:e},...t??{}}),findByUsername:(e,t)=>s._.user.findUnique({where:{username:e},...t??{}}),findByEmail:(e,t)=>s._.user.findUnique({where:{email:e},...t??{}}),findByPhoneNumber:(e,t)=>s._.user.findUnique({where:{phoneNumber:e},...t??{}}),findByNationalId:(e,t)=>s._.user.findUnique({where:{nationalId:e},...t??{}}),findMany:e=>s._.user.findMany(e),count:e=>s._.user.count(e),create:e=>s._.user.create(e),update:e=>s._.user.update(e),delete:e=>s._.user.delete(e)}},75145:(e,t,r)=>{r.d(t,{$N:()=>A,Cp:()=>E,Sk:()=>w,c_:()=>m});var s=r(42023),a=r.n(s),n=r(41482),i=r.n(n),o=r(53524),d=r(13538),l=r(37848),c=r(47833),u=r(54164);let m=async e=>{let t=await a().genSalt(10);return a().hash(e,t)},h=async(e,t)=>a().compare(e,t),p=e=>{let t={sub:e.id,role:e.role,unionId:e.unionId,districtId:e.districtId,churchId:e.churchId};return i().sign(t,l.O.JWT_SECRET,{expiresIn:43200})},w=async e=>{try{let t=i().verify(e,l.O.JWT_SECRET),r=await d._.user.findUnique({where:{id:t.sub}});if(!r)throw new c.yj("User not found");if(!r.isActive)throw new c.yj("Account disabled");return r}catch(e){if(e instanceof c.yj)throw e;throw new c.yj("Invalid token")}},A=async({email:e,phoneNumber:t,password:r})=>{let s=null;if(t){if(!(s=await u.T.findByPhoneNumber(t))||!s.isActive)throw new c.yj("Invalid credentials");if(s.role!==o.Role.MEMBER)throw new c.yj("Phone number login is restricted to members")}else if(e){if(!(s=await u.T.findByEmail(e))||!s.isActive)throw new c.yj("Invalid credentials");if(s.role===o.Role.MEMBER)throw new c.yj("Members must sign in with their phone number")}else throw new c.yj("Email or phone number is required");if(!await h(r,s.passwordHash))throw new c.yj("Invalid credentials");let a=p({id:s.id,role:s.role,unionId:s.unionId,districtId:s.districtId,churchId:s.churchId}),{passwordHash:n,...i}=s;return{token:a,user:i}},E=async(e,t)=>{if(!await h(t.currentPassword,e.passwordHash))throw new c.yj("Invalid current password");let r=await m(t.newPassword),{passwordHash:s,...a}=await d._.user.update({where:{id:e.id},data:{passwordHash:r}});return{user:a}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[416],()=>r(69021));module.exports=s})();