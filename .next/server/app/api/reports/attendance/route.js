"use strict";(()=>{var e={};e.id=309,e.ids=[309],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},32694:e=>{e.exports=require("http2")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},4683:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>P,patchFetch:()=>b,requestAsyncStorage:()=>C,routeModule:()=>x,serverHooks:()=>R,staticGenerationAsyncStorage:()=>M});var i={};r.r(i),r.d(i,{GET:()=>A});var n=r(49303),s=r(88716),a=r(60670),d=r(5754),c=r(13538),o=r(17913),u=r(47833);let h=e=>{if(!e)return;let t=new Date(e);if(Number.isNaN(t.getTime()))throw new u.lY(`Invalid date value: ${e}`);return t},l=(e,t)=>{if("UNION_ADMIN"===e.role)return t;if("DISTRICT_ADMIN"===e.role){if(!e.districtId)throw new u.lY("No district assigned to this account");if(t.districtId&&t.districtId!==e.districtId)throw new u.lY("Cannot view reports outside your district");return{...t,districtId:e.districtId}}if("CHURCH_ADMIN"===e.role){if(!e.churchId)throw new u.lY("No church assigned to this account");if(t.churchId&&t.churchId!==e.churchId)throw new u.lY("Cannot view reports outside your church");return{...t,churchId:e.churchId,districtId:e.districtId??t.districtId}}throw new u.lY("Not allowed to view reports")},I=(e,t)=>{let r=(0,o.qN)(e,t),i=h(t.fromDate),n=h(t.toDate);if(i||n){let e={...i?{gte:i}:{},...n?{lte:n}:{}};r.createdAt=e}return r},p=async(e,t={})=>{let r=l(e,t),i=I(e,r),[n,s]=await Promise.all([c._.attendanceRecord.count({where:i}),c._.attendanceRecord.count({where:{...i,status:"APPROVED"}})]);return{total:n,approved:s,pending:n-s}},w=async(e,t={})=>{let r=l(e,t),i=I(e,r),n=await c._.attendanceRecord.groupBy({where:i,by:["sessionId"],_count:{_all:!0}});if(!n.length)return[];let s=n.map(e=>e.sessionId),a=new Map((await c._.umugandaSession.findMany({where:{id:{in:s}},select:{id:!0,church:{select:{id:!0,name:!0,districtId:!0}}}})).map(e=>[e.id,e.church])),d=new Map;for(let e of n){let t=a.get(e.sessionId),r=t?.id??"unknown",i=d.get(r),n=e._count._all;i?i.attendanceCount+=n:d.set(r,{churchId:r,churchName:t?.name??"Unknown Church",districtId:t?.districtId??null,attendanceCount:n})}return Array.from(d.values())},f=async(e,t={})=>{let r=l(e,t),i=I(e,r),n=await c._.attendanceRecord.groupBy({where:i,by:["sessionId"],_count:{_all:!0}});if(!n.length)return[];let s=n.map(e=>e.sessionId),a=new Map((await c._.umugandaSession.findMany({where:{id:{in:s}},select:{id:!0,church:{select:{district:{select:{id:!0,name:!0}}}}}})).map(e=>[e.id,e.church?.district])),d=new Map;for(let e of n){let t=a.get(e.sessionId),r=t?.id??"unknown",i=d.get(r),n=e._count._all;i?i.attendanceCount+=n:d.set(r,{districtId:r,districtName:t?.name??"Unknown District",attendanceCount:n})}return Array.from(d.values())},m=e=>{let t={};return e.districtId&&(t.districtId=e.districtId),e.churchId&&(t.churchId=e.churchId),e.sessionId&&(t.sessionId=e.sessionId),e.status&&(t.status=e.status),e.fromDate&&(t.fromDate=e.fromDate),e.toDate&&(t.toDate=e.toDate),t},y=async e=>{let t=e.queryData??{},r=m(t),i=await p(e.user,r);return"church"===t.groupBy?{summary:i,breakdown:{groupBy:"church",data:await w(e.user,r)}}:"district"===t.groupBy?{summary:i,breakdown:{groupBy:"district",data:await f(e.user,r)}}:{summary:i}};var g=r(91585),N=r(91941),_=r(9846);let D=g.Ry({districtId:g.Z_().optional(),churchId:g.Z_().optional(),sessionId:g.Z_().optional(),status:g.Km(["PENDING","APPROVED"]).optional(),fromDate:g.Z_().optional(),toDate:g.Z_().optional(),groupBy:g.Km(["church","district"]).optional()}),q=(0,N.i)(D),v=(0,_.k)(["UNION_ADMIN","DISTRICT_ADMIN","CHURCH_ADMIN","POLICE_VERIFIER"]),A=(0,d.o)({middlewares:[v,q],controller:y}),x=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/reports/attendance/route",pathname:"/api/reports/attendance",filename:"route",bundlePath:"app/api/reports/attendance/route"},resolvedPagePath:"/Volumes/Macintosh HD - Data/sda/sda-backend/app/api/reports/attendance/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:C,staticGenerationAsyncStorage:M,serverHooks:R}=x,P="/api/reports/attendance/route";function b(){return(0,a.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:M})}},91941:(e,t,r)=>{r.d(t,{i:()=>s});var i=r(26033),n=r(47833);let s=e=>async t=>{let r=Object.fromEntries(t.query.entries());try{let i=e.parse(r);return{...t,queryData:i}}catch(e){if(e instanceof i.jm)throw new n.p8("Invalid query parameters",e.flatten());throw e}}},90542:(e,t,r)=>{r.d(t,{g:()=>n});var i=r(13538);let n={findById:(e,t)=>i._.umugandaSession.findUnique({where:{id:e},...t??{}}),findMany:e=>i._.umugandaSession.findMany(e),create:e=>i._.umugandaSession.create(e),update:e=>i._.umugandaSession.update(e),delete:e=>i._.umugandaSession.delete(e)}},17913:(e,t,r)=>{r.d(t,{$c:()=>p,Ld:()=>I,qN:()=>h,yG:()=>l});var i=r(53524),n=r(57243),s=r(90542),a=r(54164),d=r(47833),c=r(57303);let o={member:{select:{id:!0,firstName:!0,lastName:!0,nationalId:!0,phoneNumber:!0}},session:{select:{id:!0,date:!0,church:{select:{id:!0,name:!0,districtId:!0}}}},pass:{select:{id:!0,token:!0,smsSentAt:!0}},approvedBy:{select:{id:!0,firstName:!0,lastName:!0}}},u={session:{select:{id:!0,churchId:!0}},pass:!0},h=(e,t={})=>{let r={},i={};if(t.status&&(r.status=t.status),t.sessionId&&(r.sessionId=t.sessionId),"UNION_ADMIN"===e.role){if(!e.unionId)throw new d.lY("No union assigned to this account");i.church={is:{district:{is:{unionId:e.unionId}},...t.districtId?{districtId:t.districtId}:{},...t.churchId?{id:t.churchId}:{}}}}else if("DISTRICT_ADMIN"===e.role){if(!e.districtId)throw new d.lY("No district assigned to this account");if(t.districtId&&t.districtId!==e.districtId)throw new d.lY("Cannot view attendance outside your district");i.church={is:{districtId:e.districtId,...t.churchId?{id:t.churchId}:{}}}}else if("CHURCH_ADMIN"===e.role){if(!e.churchId)throw new d.lY("No church assigned to this account");if(t.churchId&&t.churchId!==e.churchId)throw new d.lY("Cannot view attendance outside your church");i.churchId=e.churchId}else throw new d.lY("Not allowed to view attendance");return Object.keys(i).length>0&&(r.session={is:i}),r},l=async(e,t={})=>{let r=h(e,t);return n.v.findMany({where:r,include:o,orderBy:{createdAt:"desc"}})},I=async(e,t)=>{if("CHURCH_ADMIN"!==e.role)throw new d.lY("Only church admins can record attendance");if(!e.churchId)throw new d.lY("No church assigned to this account");let r=await s.g.findById(t.sessionId,{include:{church:{select:{id:!0}}}});if(!r)throw new d.dR("Session not found");if(r.churchId!==e.churchId)throw new d.lY("Cannot record attendance for another church");let c=await a.T.findById(t.memberId,{select:{id:!0,role:!0,churchId:!0}});if(!c||"MEMBER"!==c.role)throw new d.dR("Member not found");if(c.churchId!==e.churchId)throw new d.lY("Member belongs to another church");try{return await n.v.create({data:{sessionId:t.sessionId,memberId:t.memberId},include:o})}catch(e){if(e instanceof i.Prisma.PrismaClientKnownRequestError&&"P2002"===e.code)throw new d.AY("Attendance already recorded for this member");throw e}},p=async(e,t,r)=>{if("CHURCH_ADMIN"!==e.role)throw new d.lY("Only church admins can update attendance");if(!e.churchId)throw new d.lY("No church assigned to this account");let s=await n.v.findById(t,{include:u});if(!s)throw new d.dR("Attendance record not found");if(s.session.churchId!==e.churchId)throw new d.lY("Cannot modify attendance outside your church");let a=await n.v.update({where:{id:t},data:{status:r.status,approvedById:r.status===i.AttendanceStatus.APPROVED?e.id:null},include:o});return r.status===i.AttendanceStatus.APPROVED&&(r.issuePass??!0)?{attendance:a,pass:await (0,c.QE)(t)}:(r.status===i.AttendanceStatus.PENDING&&a.pass&&await (0,c.qc)(t),{attendance:a})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[416,585,558,362,994],()=>r(4683));module.exports=i})();