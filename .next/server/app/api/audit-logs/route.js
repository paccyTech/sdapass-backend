"use strict";(()=>{var e={};e.id=108,e.ids=[108],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},96115:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>A,patchFetch:()=>g,requestAsyncStorage:()=>w,routeModule:()=>f,serverHooks:()=>R,staticGenerationAsyncStorage:()=>y});var n={};t.r(n),t.d(n,{GET:()=>I,OPTIONS:()=>_});var s=t(49303),o=t(88716),i=t(60670),a=t(87070),l=t(91585),u=t(5754),d=t(9846),c=t(91941),p=t(6974);let h=async e=>{let r={action:e.queryData?.action,role:e.queryData?.role,search:e.queryData?.search,cursor:e.queryData?.cursor,limit:e.queryData?.limit?Number(e.queryData.limit):void 0};return await (0,p.B)(e.user,r)},m=l.Ry({action:l.Z_().optional(),role:l.Km(["UNION_ADMIN","DISTRICT_ADMIN","CHURCH_ADMIN","MEMBER","POLICE_VERIFIER"]).optional(),search:l.Z_().optional(),cursor:l.Z_().optional(),limit:l.oQ.number().min(1).max(100).optional()}),I=(0,u.o)({middlewares:[(0,d.k)(["UNION_ADMIN"]),(0,c.i)(m)],controller:h}),_=(0,u.o)({controller:async()=>new a.NextResponse(null,{status:204})}),f=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/audit-logs/route",pathname:"/api/audit-logs",filename:"route",bundlePath:"app/api/audit-logs/route"},resolvedPagePath:"/Volumes/Macintosh HD - Data/sda/sda-backend/app/api/audit-logs/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:w,staticGenerationAsyncStorage:y,serverHooks:R}=f,A="/api/audit-logs/route";function g(){return(0,i.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:y})}},37848:(e,r,t)=>{t.d(r,{O:()=>i});let n=e=>{let r=process.env[e];if(!r)throw Error(`Missing required environment variable: ${e}`);return r},s="http://localhost:3000",o=(process.env.CORS_ORIGIN??s).split(",").map(e=>e.trim()).filter(Boolean),i={DATABASE_URL:n("DATABASE_URL"),JWT_SECRET:n("JWT_SECRET"),SMS_API_KEY:process.env.SMS_API_KEY??"",CORS_ORIGIN:process.env.CORS_ORIGIN??s,PRIMARY_ORIGIN:o[0]??s,TWILIO_ACCOUNT_SID:process.env.TWILIO_ACCOUNT_SID??"",TWILIO_AUTH_TOKEN:process.env.TWILIO_AUTH_TOKEN??"",TWILIO_FROM_NUMBER:process.env.TWILIO_FROM_NUMBER??"",GMAIL_USER:process.env.GMAIL_USER,GMAIL_APP_PASSWORD:process.env.GMAIL_APP_PASSWORD,GMAIL_FROM_NAME:process.env.GMAIL_FROM_NAME||"Umuganda SDA",SMTP_HOST:process.env.SMTP_HOST||"smtp.gmail.com",SMTP_PORT:process.env.SMTP_PORT||"587",SMTP_SECURE:process.env.SMTP_SECURE||"false"}},47833:(e,r,t)=>{t.d(r,{AY:()=>a,HC:()=>u,dR:()=>i,gz:()=>n,lY:()=>o,p8:()=>l,yj:()=>s});class n extends Error{constructor(e,r=400,t){super(e),this.name="AppError",this.status=r,this.details=t}}class s extends n{constructor(e="Unauthorized"){super(e,401),this.name="UnauthorizedError"}}class o extends n{constructor(e="Forbidden"){super(e,403),this.name="ForbiddenError"}}class i extends n{constructor(e="Resource not found"){super(e,404),this.name="NotFoundError"}}class a extends n{constructor(e="Conflict"){super(e,409),this.name="ConflictError"}}class l extends n{constructor(e="Validation failed",r){super(e,422,r),this.name="ValidationError"}}let u=e=>e instanceof n},9293:(e,r,t)=>{t.d(r,{X:()=>l});var n=t(87070),s=t(26033),o=t(47833),i=t(37848);let a=(e,r)=>n.NextResponse.json(e,r),l=async(e,r)=>{if("OPTIONS"===e.method)return p(new n.NextResponse(null,{status:204}),e);try{let t;let s=await r();return t=s instanceof n.NextResponse?s:a({data:s}),p(t,e)}catch(t){let r;if(t instanceof s.jm){let e=new o.p8("Validation failed",t.flatten());r=n.NextResponse.json({error:e.message,details:e.details},{status:e.status})}else(0,o.HC)(t)?r=n.NextResponse.json({error:t.message,details:t.details},{status:t.status}):(t instanceof Error?console.error(t):console.error("Unknown error",t),r=n.NextResponse.json({error:"Internal Server Error"},{status:500}));return p(r,e)}},u=e=>e.replace(/^"|"$/g,"").replace(/^'|'$/g,""),d=e=>u(e).replace(/\/$/,""),c=()=>i.O.CORS_ORIGIN?i.O.CORS_ORIGIN.split(",").map(e=>e.trim()).filter(Boolean).map(e=>d(e)):[],p=(e,r)=>{let t=c();if(!t.length)return e;let n=r?.headers.get("origin")??null,s=n?d(n):null,o=null;if(s&&t.includes(s)?o=s:s&&t.includes("*")?o=s:1===t.length&&(o=t[0]),!o&&t.length&&(o=t[0]),!o)return e;e.headers.set("Access-Control-Allow-Origin",o);let i=r?.headers.get("access-control-request-headers");return e.headers.set("Access-Control-Allow-Methods","GET,POST,PUT,PATCH,DELETE,OPTIONS"),e.headers.set("Access-Control-Allow-Headers",i&&i.length?i:"Content-Type,Authorization,Accept"),e.headers.set("Access-Control-Allow-Credentials","true"),e.headers.set("Access-Control-Max-Age","600"),e.headers.set("Vary","Origin"),e}},13538:(e,r,t)=>{t.d(r,{_:()=>s});var n=t(53524);let s=globalThis.prisma??new n.PrismaClient({log:["error"]})},5754:(e,r,t)=>{t.d(r,{o:()=>s});var n=t(9293);let s=({middlewares:e=[],controller:r})=>async(t,s)=>(0,n.X)(t,async()=>{let n=new URL(t.url),o={req:t,params:s?.params??{},query:n.searchParams};for(let r of e)o=await r(o);return r({...o,params:o.params})})},9846:(e,r,t)=>{t.d(r,{k:()=>i});var n=t(47833),s=t(75145);let o=e=>{let r=e.headers.get("authorization")??e.headers.get("Authorization");if(!r)throw new n.yj("Missing Authorization header");let t=r.split(" ");if(2!==t.length||"Bearer"!==t[0])throw new n.yj("Malformed Authorization header");return t[1]},i=e=>async r=>{let t=o(r.req),i=await (0,s.Sk)(t);if(e&&!e.includes(i.role))throw new n.yj("Insufficient permissions");return{...r,user:i}}},91941:(e,r,t)=>{t.d(r,{i:()=>o});var n=t(26033),s=t(47833);let o=e=>async r=>{let t=Object.fromEntries(r.query.entries());try{let n=e.parse(t);return{...r,queryData:n}}catch(e){if(e instanceof n.jm)throw new s.p8("Invalid query parameters",e.flatten());throw e}}},54164:(e,r,t)=>{t.d(r,{T:()=>s});var n=t(13538);let s={findById:(e,r)=>n._.user.findUnique({where:{id:e},...r??{}}),findByUsername:(e,r)=>n._.user.findUnique({where:{username:e},...r??{}}),findByEmail:(e,r)=>n._.user.findUnique({where:{email:e},...r??{}}),findByPhoneNumber:(e,r)=>n._.user.findUnique({where:{phoneNumber:e},...r??{}}),findByNationalId:(e,r)=>n._.user.findUnique({where:{nationalId:e},...r??{}}),findMany:e=>n._.user.findMany(e),count:e=>n._.user.count(e),create:e=>n._.user.create(e),update:e=>n._.user.update(e),delete:e=>n._.user.delete(e)}},6974:(e,r,t)=>{t.d(r,{B:()=>u,R:()=>a});var n=t(13538),s=t(47833);let o=e=>{let r=e.headers.get("x-forwarded-for")??e.headers.get("X-Forwarded-For");return r?r.split(",").map(e=>e.trim()).find(Boolean)??null:(e.headers.get("x-real-ip")??e.headers.get("X-Real-Ip")??e.headers.get("cf-connecting-ip")??e.headers.get("CF-Connecting-Ip"))||null},i=e=>e?`${e.firstName??""} ${e.lastName??""}`.trim()||(e.username??"Unknown"):"Unknown",a=async({req:e,user:r,action:t,details:s})=>{try{let a=o(e),l=e.headers.get("user-agent")??e.headers.get("User-Agent")??null;await n._.auditLog.create({data:{action:t,userName:i(r),userRole:r?.role??null,userId:r?.id??null,unionId:r?.unionId??null,districtId:r?.districtId??null,churchId:r?.churchId??null,ipAddress:a,userAgent:l,details:s??void 0}})}catch(e){console.error("Failed to record audit log",e)}},l=e=>{if(e)return{OR:[{userName:{contains:e,mode:"insensitive"}},{action:{contains:e,mode:"insensitive"}},{ipAddress:{contains:e,mode:"insensitive"}},{userAgent:{contains:e,mode:"insensitive"}}]}},u=async(e,{action:r,role:t,search:o,cursor:i,limit:a=25})=>{if("UNION_ADMIN"!==e.role)throw new s.lY("Only union admins can view audit logs");if(!e.unionId)throw new s.lY("Union context is required to view audit logs");let u={unionId:e.unionId,...r?{action:r}:{},...t?{userRole:t}:{}},d=l(o);d&&(u.AND=u.AND??[],u.AND.push(d));let c=Math.min(Math.max(a,1),100),p=await n._.auditLog.findMany({where:u,orderBy:{createdAt:"desc"},take:c+1,cursor:i?{id:i}:void 0,skip:i?1:0}),h=n._.auditLog.count({where:u}),m=n._.auditLog.groupBy({where:u,by:["action"],_count:{action:!0}}),I=n._.auditLog.groupBy({where:u,by:["userRole"],_count:{userRole:!0}}),[_,f,w]=await Promise.all([h,m,I]),y=null;if(p.length>c){let e=p.pop();y=e?e.id:null}return{logs:p,total:_,countsByAction:f.map(e=>({action:e.action,count:e._count.action})),countsByRole:w.map(e=>({role:e.userRole??null,count:e._count.userRole})),nextCursor:y}}},75145:(e,r,t)=>{t.d(r,{$N:()=>_,Sk:()=>I,c_:()=>p});var n=t(42023),s=t.n(n),o=t(41482),i=t.n(o),a=t(53524),l=t(13538),u=t(37848),d=t(47833),c=t(54164);let p=async e=>{let r=await s().genSalt(10);return s().hash(e,r)},h=async(e,r)=>s().compare(e,r),m=e=>{let r={sub:e.id,role:e.role,unionId:e.unionId,districtId:e.districtId,churchId:e.churchId};return i().sign(r,u.O.JWT_SECRET,{expiresIn:43200})},I=async e=>{try{let r=i().verify(e,u.O.JWT_SECRET),t=await l._.user.findUnique({where:{id:r.sub}});if(!t)throw new d.yj("User not found");if(!t.isActive)throw new d.yj("Account disabled");return t}catch(e){if(e instanceof d.yj)throw e;throw new d.yj("Invalid token")}},_=async({email:e,phoneNumber:r,password:t})=>{let n=null;if(r){if(!(n=await c.T.findByPhoneNumber(r))||!n.isActive)throw new d.yj("Invalid credentials");if(n.role!==a.Role.MEMBER)throw new d.yj("Phone number login is restricted to members")}else if(e){if(!(n=await c.T.findByEmail(e))||!n.isActive)throw new d.yj("Invalid credentials");if(n.role===a.Role.MEMBER)throw new d.yj("Members must sign in with their phone number")}else throw new d.yj("Email or phone number is required");if(!await h(t,n.passwordHash))throw new d.yj("Invalid credentials");let s=m({id:n.id,role:n.role,unionId:n.unionId,districtId:n.districtId,churchId:n.churchId}),{passwordHash:o,...i}=n;return{token:s,user:i}}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[416,585],()=>t(96115));module.exports=n})();