"use strict";(()=>{var e={};e.id=873,e.ids=[873],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},19854:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>y,patchFetch:()=>A,requestAsyncStorage:()=>_,routeModule:()=>w,serverHooks:()=>R,staticGenerationAsyncStorage:()=>g});var n={};t.r(n),t.d(n,{OPTIONS:()=>f,POST:()=>I});var s=t(49303),i=t(88716),o=t(60670),a=t(91585),l=t(87070),u=t(5754),d=t(38553),c=t(75145),p=t(6974);let h=async e=>{if(!e.body)throw Error("Missing request body");let{email:r,phoneNumber:t,password:n}=e.body,{token:s,user:i}=await (0,c.$N)({email:r,phoneNumber:t,password:n});return await (0,p.R)({req:e.req,user:i,action:"auth.login",details:{via:r?"email":"phoneNumber"}}),{token:s,user:i}},m=a.Ry({email:a.Z_().email("Valid email is required").optional(),phoneNumber:a.Z_().min(1,"Phone number is required").optional(),password:a.Z_().min(1,"Password is required")}).refine(e=>!!(e.email||e.phoneNumber),{message:"Email or phone number is required",path:["email"]}).refine(e=>!(e.email&&e.phoneNumber),{message:"Provide either email or phone number, not both",path:["email"]}),I=(0,u.o)({middlewares:[(0,d.m)(m)],controller:h}),f=(0,u.o)({controller:async()=>new l.NextResponse(null,{status:204})}),w=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:"app/api/auth/login/route"},resolvedPagePath:"/Volumes/Macintosh HD - Data/sda/sda-backend/app/api/auth/login/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:_,staticGenerationAsyncStorage:g,serverHooks:R}=w,y="/api/auth/login/route";function A(){return(0,o.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:g})}},37848:(e,r,t)=>{t.d(r,{O:()=>o});let n=e=>{let r=process.env[e];if(!r)throw Error(`Missing required environment variable: ${e}`);return r},s="http://localhost:3000",i=(process.env.CORS_ORIGIN??s).split(",").map(e=>e.trim()).filter(Boolean),o={DATABASE_URL:n("DATABASE_URL"),JWT_SECRET:n("JWT_SECRET"),SMS_API_KEY:process.env.SMS_API_KEY??"",CORS_ORIGIN:process.env.CORS_ORIGIN??s,PRIMARY_ORIGIN:i[0]??s,TWILIO_ACCOUNT_SID:process.env.TWILIO_ACCOUNT_SID??"",TWILIO_AUTH_TOKEN:process.env.TWILIO_AUTH_TOKEN??"",TWILIO_FROM_NUMBER:process.env.TWILIO_FROM_NUMBER??"",GMAIL_USER:process.env.GMAIL_USER,GMAIL_APP_PASSWORD:process.env.GMAIL_APP_PASSWORD,GMAIL_FROM_NAME:process.env.GMAIL_FROM_NAME||"Umuganda SDA",SMTP_HOST:process.env.SMTP_HOST||"smtp.gmail.com",SMTP_PORT:process.env.SMTP_PORT||"587",SMTP_SECURE:process.env.SMTP_SECURE||"false"}},47833:(e,r,t)=>{t.d(r,{AY:()=>a,HC:()=>u,dR:()=>o,gz:()=>n,lY:()=>i,p8:()=>l,yj:()=>s});class n extends Error{constructor(e,r=400,t){super(e),this.name="AppError",this.status=r,this.details=t}}class s extends n{constructor(e="Unauthorized"){super(e,401),this.name="UnauthorizedError"}}class i extends n{constructor(e="Forbidden"){super(e,403),this.name="ForbiddenError"}}class o extends n{constructor(e="Resource not found"){super(e,404),this.name="NotFoundError"}}class a extends n{constructor(e="Conflict"){super(e,409),this.name="ConflictError"}}class l extends n{constructor(e="Validation failed",r){super(e,422,r),this.name="ValidationError"}}let u=e=>e instanceof n},9293:(e,r,t)=>{t.d(r,{X:()=>l});var n=t(87070),s=t(26033),i=t(47833),o=t(37848);let a=(e,r)=>n.NextResponse.json(e,r),l=async(e,r)=>{if("OPTIONS"===e.method)return p(new n.NextResponse(null,{status:204}),e);try{let t;let s=await r();return t=s instanceof n.NextResponse?s:a({data:s}),p(t,e)}catch(t){let r;if(t instanceof s.jm){let e=new i.p8("Validation failed",t.flatten());r=n.NextResponse.json({error:e.message,details:e.details},{status:e.status})}else(0,i.HC)(t)?r=n.NextResponse.json({error:t.message,details:t.details},{status:t.status}):(t instanceof Error?console.error(t):console.error("Unknown error",t),r=n.NextResponse.json({error:"Internal Server Error"},{status:500}));return p(r,e)}},u=e=>e.replace(/^"|"$/g,"").replace(/^'|'$/g,""),d=e=>u(e).replace(/\/$/,""),c=()=>o.O.CORS_ORIGIN?o.O.CORS_ORIGIN.split(",").map(e=>e.trim()).filter(Boolean).map(e=>d(e)):[],p=(e,r)=>{let t=c();if(!t.length)return e;let n=r?.headers.get("origin")??null,s=n?d(n):null,i=null;if(s&&t.includes(s)?i=s:s&&t.includes("*")?i=s:1===t.length&&(i=t[0]),!i&&t.length&&(i=t[0]),!i)return e;e.headers.set("Access-Control-Allow-Origin",i);let o=r?.headers.get("access-control-request-headers");return e.headers.set("Access-Control-Allow-Methods","GET,POST,PUT,PATCH,DELETE,OPTIONS"),e.headers.set("Access-Control-Allow-Headers",o&&o.length?o:"Content-Type,Authorization,Accept"),e.headers.set("Access-Control-Allow-Credentials","true"),e.headers.set("Access-Control-Max-Age","600"),e.headers.set("Vary","Origin"),e}},13538:(e,r,t)=>{t.d(r,{_:()=>s});var n=t(53524);let s=globalThis.prisma??new n.PrismaClient({log:["error"]})},5754:(e,r,t)=>{t.d(r,{o:()=>s});var n=t(9293);let s=({middlewares:e=[],controller:r})=>async(t,s)=>(0,n.X)(t,async()=>{let n=new URL(t.url),i={req:t,params:s?.params??{},query:n.searchParams};for(let r of e)i=await r(i);return r({...i,params:i.params})})},38553:(e,r,t)=>{t.d(r,{m:()=>i});var n=t(26033),s=t(47833);let i=e=>async r=>{let t;try{t=await r.req.json()}catch(r){if(e.isOptional())t=void 0;else throw new s.p8("Invalid JSON body")}try{let n=e.parse(t);return{...r,body:n}}catch(e){if(e instanceof n.jm)throw new s.p8("Validation failed",e.flatten());throw e}}},54164:(e,r,t)=>{t.d(r,{T:()=>s});var n=t(13538);let s={findById:(e,r)=>n._.user.findUnique({where:{id:e},...r??{}}),findByUsername:(e,r)=>n._.user.findUnique({where:{username:e},...r??{}}),findByEmail:(e,r)=>n._.user.findUnique({where:{email:e},...r??{}}),findByPhoneNumber:(e,r)=>n._.user.findUnique({where:{phoneNumber:e},...r??{}}),findByNationalId:(e,r)=>n._.user.findUnique({where:{nationalId:e},...r??{}}),findMany:e=>n._.user.findMany(e),count:e=>n._.user.count(e),create:e=>n._.user.create(e),update:e=>n._.user.update(e),delete:e=>n._.user.delete(e)}},6974:(e,r,t)=>{t.d(r,{B:()=>u,R:()=>a});var n=t(13538),s=t(47833);let i=e=>{let r=e.headers.get("x-forwarded-for")??e.headers.get("X-Forwarded-For");return r?r.split(",").map(e=>e.trim()).find(Boolean)??null:(e.headers.get("x-real-ip")??e.headers.get("X-Real-Ip")??e.headers.get("cf-connecting-ip")??e.headers.get("CF-Connecting-Ip"))||null},o=e=>e?`${e.firstName??""} ${e.lastName??""}`.trim()||(e.username??"Unknown"):"Unknown",a=async({req:e,user:r,action:t,details:s})=>{try{let a=i(e),l=e.headers.get("user-agent")??e.headers.get("User-Agent")??null;await n._.auditLog.create({data:{action:t,userName:o(r),userRole:r?.role??null,userId:r?.id??null,unionId:r?.unionId??null,districtId:r?.districtId??null,churchId:r?.churchId??null,ipAddress:a,userAgent:l,details:s??void 0}})}catch(e){console.error("Failed to record audit log",e)}},l=e=>{if(e)return{OR:[{userName:{contains:e,mode:"insensitive"}},{action:{contains:e,mode:"insensitive"}},{ipAddress:{contains:e,mode:"insensitive"}},{userAgent:{contains:e,mode:"insensitive"}}]}},u=async(e,{action:r,role:t,search:i,cursor:o,limit:a=25})=>{if("UNION_ADMIN"!==e.role)throw new s.lY("Only union admins can view audit logs");if(!e.unionId)throw new s.lY("Union context is required to view audit logs");let u={unionId:e.unionId,...r?{action:r}:{},...t?{userRole:t}:{}},d=l(i);d&&(u.AND=u.AND??[],u.AND.push(d));let c=Math.min(Math.max(a,1),100),p=await n._.auditLog.findMany({where:u,orderBy:{createdAt:"desc"},take:c+1,cursor:o?{id:o}:void 0,skip:o?1:0}),h=n._.auditLog.count({where:u}),m=n._.auditLog.groupBy({where:u,by:["action"],_count:{action:!0}}),I=n._.auditLog.groupBy({where:u,by:["userRole"],_count:{userRole:!0}}),[f,w,_]=await Promise.all([h,m,I]),g=null;if(p.length>c){let e=p.pop();g=e?e.id:null}return{logs:p,total:f,countsByAction:w.map(e=>({action:e.action,count:e._count.action})),countsByRole:_.map(e=>({role:e.userRole??null,count:e._count.userRole})),nextCursor:g}}},75145:(e,r,t)=>{t.d(r,{$N:()=>f,Sk:()=>I,c_:()=>p});var n=t(42023),s=t.n(n),i=t(41482),o=t.n(i),a=t(53524),l=t(13538),u=t(37848),d=t(47833),c=t(54164);let p=async e=>{let r=await s().genSalt(10);return s().hash(e,r)},h=async(e,r)=>s().compare(e,r),m=e=>{let r={sub:e.id,role:e.role,unionId:e.unionId,districtId:e.districtId,churchId:e.churchId};return o().sign(r,u.O.JWT_SECRET,{expiresIn:43200})},I=async e=>{try{let r=o().verify(e,u.O.JWT_SECRET),t=await l._.user.findUnique({where:{id:r.sub}});if(!t)throw new d.yj("User not found");if(!t.isActive)throw new d.yj("Account disabled");return t}catch(e){if(e instanceof d.yj)throw e;throw new d.yj("Invalid token")}},f=async({email:e,phoneNumber:r,password:t})=>{let n=null;if(r){if(!(n=await c.T.findByPhoneNumber(r))||!n.isActive)throw new d.yj("Invalid credentials");if(n.role!==a.Role.MEMBER)throw new d.yj("Phone number login is restricted to members")}else if(e){if(!(n=await c.T.findByEmail(e))||!n.isActive)throw new d.yj("Invalid credentials");if(n.role===a.Role.MEMBER)throw new d.yj("Members must sign in with their phone number")}else throw new d.yj("Email or phone number is required");if(!await h(t,n.passwordHash))throw new d.yj("Invalid credentials");let s=m({id:n.id,role:n.role,unionId:n.unionId,districtId:n.districtId,churchId:n.churchId}),{passwordHash:i,...o}=n;return{token:s,user:o}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[416,585],()=>t(19854));module.exports=n})();