"use strict";(()=>{var e={};e.id=814,e.ids=[814],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},18056:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>g,patchFetch:()=>R,requestAsyncStorage:()=>I,routeModule:()=>f,serverHooks:()=>y,staticGenerationAsyncStorage:()=>_});var n={};t.r(n),t.d(n,{OPTIONS:()=>m,POST:()=>w});var s=t(49303),a=t(88716),o=t(60670),i=t(87070),l=t(91585),d=t(5754),u=t(9846),c=t(38553),h=t(3295);let p=l.Ry({currentPassword:l.Z_().min(1,"Current password is required"),newPassword:l.Z_().min(8,"New password must be at least 8 characters")}),w=(0,d.o)({middlewares:[(0,u.k)(),(0,c.m)(p)],controller:h.l}),m=(0,d.o)({controller:async()=>new i.NextResponse(null,{status:204})}),f=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/auth/change-password/route",pathname:"/api/auth/change-password",filename:"route",bundlePath:"app/api/auth/change-password/route"},resolvedPagePath:"/Volumes/Macintosh HD - Data/sda/sda-backend/app/api/auth/change-password/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:I,staticGenerationAsyncStorage:_,serverHooks:y}=f,g="/api/auth/change-password/route";function R(){return(0,o.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:_})}},3295:(e,r,t)=>{t.d(r,{l:()=>o,v:()=>a});var n=t(75145),s=t(6974);let a=async e=>{if(!e.body)throw Error("Missing request body");let{email:r,phoneNumber:t,password:a}=e.body,{token:o,user:i}=await (0,n.$N)({email:r,phoneNumber:t,password:a});return await (0,s.R)({req:e.req,user:i,action:"auth.login",details:{via:r?"email":"phoneNumber"}}),{token:o,user:i}},o=async e=>{if(!e.body)throw Error("Missing request body");return await (0,n.Cp)(e.user,e.body),await (0,s.R)({req:e.req,user:e.user,action:"auth.change_password"}),{success:!0}}},37848:(e,r,t)=>{t.d(r,{O:()=>o});let n=e=>{let r=process.env[e];if(!r)throw Error(`Missing required environment variable: ${e}`);return r},s="http://localhost:3000",a=(process.env.CORS_ORIGIN??s).split(",").map(e=>e.trim()).filter(Boolean),o={DATABASE_URL:n("DATABASE_URL"),JWT_SECRET:n("JWT_SECRET"),SMS_API_KEY:process.env.SMS_API_KEY??"",CORS_ORIGIN:process.env.CORS_ORIGIN??s,PRIMARY_ORIGIN:a[0]??s,TWILIO_ACCOUNT_SID:process.env.TWILIO_ACCOUNT_SID??"",TWILIO_AUTH_TOKEN:process.env.TWILIO_AUTH_TOKEN??"",TWILIO_FROM_NUMBER:process.env.TWILIO_FROM_NUMBER??"",GMAIL_USER:process.env.GMAIL_USER,GMAIL_APP_PASSWORD:process.env.GMAIL_APP_PASSWORD,GMAIL_FROM_NAME:process.env.GMAIL_FROM_NAME||"Umuganda SDA",SMTP_HOST:process.env.SMTP_HOST||"smtp.gmail.com",SMTP_PORT:process.env.SMTP_PORT||"587",SMTP_SECURE:process.env.SMTP_SECURE||"false"}},47833:(e,r,t)=>{t.d(r,{AY:()=>i,HC:()=>d,dR:()=>o,gz:()=>n,lY:()=>a,p8:()=>l,yj:()=>s});class n extends Error{constructor(e,r=400,t){super(e),this.name="AppError",this.status=r,this.details=t}}class s extends n{constructor(e="Unauthorized"){super(e,401),this.name="UnauthorizedError"}}class a extends n{constructor(e="Forbidden"){super(e,403),this.name="ForbiddenError"}}class o extends n{constructor(e="Resource not found"){super(e,404),this.name="NotFoundError"}}class i extends n{constructor(e="Conflict"){super(e,409),this.name="ConflictError"}}class l extends n{constructor(e="Validation failed",r){super(e,422,r),this.name="ValidationError"}}let d=e=>e instanceof n},9293:(e,r,t)=>{t.d(r,{X:()=>l});var n=t(87070),s=t(26033),a=t(47833),o=t(37848);let i=(e,r)=>n.NextResponse.json(e,r),l=async(e,r)=>{if("OPTIONS"===e.method)return h(new n.NextResponse(null,{status:204}),e);try{let t;let s=await r();return t=s instanceof n.NextResponse?s:i({data:s}),h(t,e)}catch(t){let r;if(t instanceof s.jm){let e=new a.p8("Validation failed",t.flatten());r=n.NextResponse.json({error:e.message,details:e.details},{status:e.status})}else(0,a.HC)(t)?r=n.NextResponse.json({error:t.message,details:t.details},{status:t.status}):(t instanceof Error?console.error(t):console.error("Unknown error",t),r=n.NextResponse.json({error:"Internal Server Error"},{status:500}));return h(r,e)}},d=e=>e.replace(/^"|"$/g,"").replace(/^'|'$/g,""),u=e=>d(e).replace(/\/$/,""),c=()=>o.O.CORS_ORIGIN?o.O.CORS_ORIGIN.split(",").map(e=>e.trim()).filter(Boolean).map(e=>u(e)):[],h=(e,r)=>{let t=c();if(!t.length)return e;let n=r?.headers.get("origin")??null,s=n?u(n):null,a=null;if(s&&t.includes(s)?a=s:s&&t.includes("*")?a=s:1===t.length&&(a=t[0]),!a&&t.length&&(a=t[0]),!a)return e;e.headers.set("Access-Control-Allow-Origin",a);let o=r?.headers.get("access-control-request-headers");return e.headers.set("Access-Control-Allow-Methods","GET,POST,PUT,PATCH,DELETE,OPTIONS"),e.headers.set("Access-Control-Allow-Headers",o&&o.length?o:"Content-Type,Authorization,Accept"),e.headers.set("Access-Control-Allow-Credentials","true"),e.headers.set("Access-Control-Max-Age","600"),e.headers.set("Vary","Origin"),e}},13538:(e,r,t)=>{t.d(r,{_:()=>s});var n=t(53524);let s=globalThis.prisma??new n.PrismaClient({log:["error"]})},5754:(e,r,t)=>{t.d(r,{o:()=>s});var n=t(9293);let s=({middlewares:e=[],controller:r})=>async(t,s)=>(0,n.X)(t,async()=>{let n=new URL(t.url),a={req:t,params:s?.params??{},query:n.searchParams};for(let r of e)a=await r(a);return r({...a,params:a.params})})},9846:(e,r,t)=>{t.d(r,{k:()=>o});var n=t(47833),s=t(75145);let a=e=>{let r=e.headers.get("authorization")??e.headers.get("Authorization");if(!r)throw new n.yj("Missing Authorization header");let t=r.split(" ");if(2!==t.length||"Bearer"!==t[0])throw new n.yj("Malformed Authorization header");return t[1]},o=e=>async r=>{let t=a(r.req),o=await (0,s.Sk)(t);if(e&&!e.includes(o.role))throw new n.yj("Insufficient permissions");return{...r,user:o}}},38553:(e,r,t)=>{t.d(r,{m:()=>a});var n=t(26033),s=t(47833);let a=e=>async r=>{let t;try{t=await r.req.json()}catch(r){if(e.isOptional())t=void 0;else throw new s.p8("Invalid JSON body")}try{let n=e.parse(t);return{...r,body:n}}catch(e){if(e instanceof n.jm)throw new s.p8("Validation failed",e.flatten());throw e}}},54164:(e,r,t)=>{t.d(r,{T:()=>s});var n=t(13538);let s={findById:(e,r)=>n._.user.findUnique({where:{id:e},...r??{}}),findByUsername:(e,r)=>n._.user.findUnique({where:{username:e},...r??{}}),findByEmail:(e,r)=>n._.user.findUnique({where:{email:e},...r??{}}),findByPhoneNumber:(e,r)=>n._.user.findUnique({where:{phoneNumber:e},...r??{}}),findByNationalId:(e,r)=>n._.user.findUnique({where:{nationalId:e},...r??{}}),findMany:e=>n._.user.findMany(e),count:e=>n._.user.count(e),create:e=>n._.user.create(e),update:e=>n._.user.update(e),delete:e=>n._.user.delete(e)}},6974:(e,r,t)=>{t.d(r,{B:()=>d,R:()=>i});var n=t(13538),s=t(47833);let a=e=>{let r=e.headers.get("x-forwarded-for")??e.headers.get("X-Forwarded-For");return r?r.split(",").map(e=>e.trim()).find(Boolean)??null:(e.headers.get("x-real-ip")??e.headers.get("X-Real-Ip")??e.headers.get("cf-connecting-ip")??e.headers.get("CF-Connecting-Ip"))||null},o=e=>e?`${e.firstName??""} ${e.lastName??""}`.trim()||(e.username??"Unknown"):"Unknown",i=async({req:e,user:r,action:t,details:s})=>{try{let i=a(e),l=e.headers.get("user-agent")??e.headers.get("User-Agent")??null;await n._.auditLog.create({data:{action:t,userName:o(r),userRole:r?.role??null,userId:r?.id??null,unionId:r?.unionId??null,districtId:r?.districtId??null,churchId:r?.churchId??null,ipAddress:i,userAgent:l,details:s??void 0}})}catch(e){console.error("Failed to record audit log",e)}},l=e=>{if(e)return{OR:[{userName:{contains:e,mode:"insensitive"}},{action:{contains:e,mode:"insensitive"}},{ipAddress:{contains:e,mode:"insensitive"}},{userAgent:{contains:e,mode:"insensitive"}}]}},d=async(e,{action:r,role:t,search:a,cursor:o,limit:i=25})=>{if("UNION_ADMIN"!==e.role)throw new s.lY("Only union admins can view audit logs");if(!e.unionId)throw new s.lY("Union context is required to view audit logs");let d={unionId:e.unionId,...r?{action:r}:{},...t?{userRole:t}:{}},u=l(a);u&&(d.AND=[...d.AND??[],u]);let c=Math.min(Math.max(i,1),100),h=await n._.auditLog.findMany({where:d,orderBy:{createdAt:"desc"},take:c+1,cursor:o?{id:o}:void 0,skip:o?1:0}),p=n._.auditLog.count({where:d}),w=n._.auditLog.groupBy({where:d,by:["action"],_count:{action:!0}}),m=n._.auditLog.groupBy({where:d,by:["userRole"],_count:{userRole:!0}}),[f,I,_]=await Promise.all([p,w,m]),y=null;if(h.length>c){let e=h.pop();y=e?e.id:null}return{logs:h,total:f,countsByAction:I.map(e=>({action:e.action,count:e._count.action})),countsByRole:_.map(e=>({role:e.userRole??null,count:e._count.userRole})),nextCursor:y}}},75145:(e,r,t)=>{t.d(r,{$N:()=>f,Cp:()=>I,Sk:()=>m,c_:()=>h});var n=t(42023),s=t.n(n),a=t(41482),o=t.n(a),i=t(53524),l=t(13538),d=t(37848),u=t(47833),c=t(54164);let h=async e=>{let r=await s().genSalt(10);return s().hash(e,r)},p=async(e,r)=>s().compare(e,r),w=e=>{let r={sub:e.id,role:e.role,unionId:e.unionId,districtId:e.districtId,churchId:e.churchId};return o().sign(r,d.O.JWT_SECRET,{expiresIn:43200})},m=async e=>{try{let r=o().verify(e,d.O.JWT_SECRET),t=await l._.user.findUnique({where:{id:r.sub}});if(!t)throw new u.yj("User not found");if(!t.isActive)throw new u.yj("Account disabled");return t}catch(e){if(e instanceof u.yj)throw e;throw new u.yj("Invalid token")}},f=async({email:e,phoneNumber:r,password:t})=>{let n=null;if(r){if(!(n=await c.T.findByPhoneNumber(r))||!n.isActive)throw new u.yj("Invalid credentials");if(n.role!==i.Role.MEMBER)throw new u.yj("Phone number login is restricted to members")}else if(e){if(!(n=await c.T.findByEmail(e))||!n.isActive)throw new u.yj("Invalid credentials");if(n.role===i.Role.MEMBER)throw new u.yj("Members must sign in with their phone number")}else throw new u.yj("Email or phone number is required");if(!await p(t,n.passwordHash))throw new u.yj("Invalid credentials");let s=w({id:n.id,role:n.role,unionId:n.unionId,districtId:n.districtId,churchId:n.churchId}),{passwordHash:a,...o}=n;return{token:s,user:o}},I=async(e,r)=>{if(!await p(r.currentPassword,e.passwordHash))throw new u.yj("Invalid current password");let t=await h(r.newPassword),{passwordHash:n,...s}=await l._.user.update({where:{id:e.id},data:{passwordHash:t}});return{user:s}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),n=r.X(0,[416,585],()=>t(18056));module.exports=n})();