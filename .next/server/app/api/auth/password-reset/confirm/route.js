"use strict";(()=>{var e={};e.id=679,e.ids=[679],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},32694:e=>{e.exports=require("http2")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},50133:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>_,patchFetch:()=>y,requestAsyncStorage:()=>f,routeModule:()=>m,serverHooks:()=>O,staticGenerationAsyncStorage:()=>I});var s={};t.r(s),t.d(s,{OPTIONS:()=>h,POST:()=>c});var o=t(49303),a=t(88716),i=t(60670),n=t(87070),d=t(91585),u=t(5754),w=t(38553),l=t(15903);let p=d.Ry({token:d.Z_().min(1,"Reset token is required"),newPassword:d.Z_().min(8,"Password must be at least 8 characters")}),c=(0,u.o)({middlewares:[(0,w.m)(p)],controller:l.F}),h=(0,u.o)({controller:async()=>new n.NextResponse(null,{status:204})}),m=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/auth/password-reset/confirm/route",pathname:"/api/auth/password-reset/confirm",filename:"route",bundlePath:"app/api/auth/password-reset/confirm/route"},resolvedPagePath:"/Volumes/Macintosh HD - Data/sda/sda-backend/app/api/auth/password-reset/confirm/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:I,serverHooks:O}=m,_="/api/auth/password-reset/confirm/route";function y(){return(0,i.patchFetch)({serverHooks:O,staticGenerationAsyncStorage:I})}},15903:(e,r,t)=>{t.d(r,{F:()=>g,W:()=>y});var s=t(84770),o=t.n(s),a=t(13538),i=t(37848),n=t(67816),d=t(20471),u=t(47833),w=t(54164),l=t(75145);let p=["UNION_ADMIN","DISTRICT_ADMIN","CHURCH_ADMIN"],c=["MEMBER","POLICE_VERIFIER"],h=e=>{let r=i.O.PRIMARY_ORIGIN||"http://localhost:3000";return`${r}/reset-password/confirm?token=${encodeURIComponent(e)}`},m=()=>o().randomBytes(24).toString("base64url"),f=async(e,r,t)=>{if(!i.O.SMS_API_KEY)throw new u.gz("SMS service is not configured",500);let s=h(r),o=`Umuganda SDA password reset request. Follow this link within ${t} minutes: ${s}`;try{return await (0,n.Q)({to:e,message:o}),!0}catch(e){throw console.error("Failed to send password reset SMS",e),new u.gz("Unable to send password reset SMS",500)}},I=async(e,r,t)=>{if(!i.O.GMAIL_USER||!i.O.GMAIL_APP_PASSWORD)throw new u.gz("Email service is not properly configured",500);try{return await (0,d.LS)(e,r,t),!0}catch(e){throw console.error("Failed to send password reset email",e),new u.gz("Unable to send password reset email",500)}},O=async({nationalId:e,email:r})=>{if(!e&&!r)throw new u.gz("Provide either national ID or email",400);let t=e?await w.T.findByNationalId(e):await w.T.findByEmail(r);if(!t)return{success:!0};let s=m(),o=new Date(Date.now()+36e5);await a._.passwordResetToken.create({data:{userId:t.id,token:s,expiresAt:o}});let i=p.includes(t.role),n=c.includes(t.role);try{if(i&&t.email)await I(t.email,s,60);else if(n&&t.phoneNumber)await f(t.phoneNumber,s,60);else if(i&&!t.email)throw new u.gz("No email address on record for this admin account",400);else if(n&&!t.phoneNumber)throw new u.gz("No phone number on record for this member account",400);else throw new u.gz("Unable to determine reset method for this user",400)}catch(e){throw await a._.passwordResetToken.deleteMany({where:{token:s}}),e}return{success:!0}},_=async({token:e,newPassword:r})=>{if(!e||!r)throw new u.gz("Token and new password are required",400);if(r.length<8)throw new u.gz("Password must be at least 8 characters",400);let t=await a._.passwordResetToken.findUnique({where:{token:e},include:{user:!0}});if(!t)throw new u.dR("Reset token not found");if(t.usedAt)throw new u.gz("Reset token already used",400);if(t.expiresAt.getTime()<Date.now())throw new u.gz("Reset token expired",400);let s=await a._.user.findUnique({where:{id:t.userId}});if(!s)throw new u.dR("User account not found");if(!s.isActive)throw new u.gz("This account has been deactivated",403);let o=await (0,l.c_)(r);return await a._.$transaction([a._.user.update({where:{id:t.userId},data:{passwordHash:o}}),a._.passwordResetToken.update({where:{id:t.id},data:{usedAt:new Date}})]),{success:!0}},y=async e=>{if(!e.body)throw Error("Missing request body");return await O(e.body)},g=async e=>{if(!e.body)throw Error("Missing request body");return await _(e.body)}},67816:(e,r,t)=>{t.d(r,{Q:()=>d});var s=t(5558),o=t.n(s),a=t(37848);let i=null,n=()=>{if(!i){if(!a.O.TWILIO_ACCOUNT_SID||!a.O.TWILIO_AUTH_TOKEN)throw Error("Twilio credentials are not configured");i=o()(a.O.TWILIO_ACCOUNT_SID,a.O.TWILIO_AUTH_TOKEN)}return i},d=async({to:e,message:r})=>{if(!e)throw Error("Missing receiver phone number");let t=a.O.TWILIO_FROM_NUMBER;if(!a.O.TWILIO_ACCOUNT_SID||!a.O.TWILIO_AUTH_TOKEN||!t)throw Error("Twilio configuration missing");let s=n();await s.messages.create({to:e,from:t,body:r})}},38553:(e,r,t)=>{t.d(r,{m:()=>a});var s=t(26033),o=t(47833);let a=e=>async r=>{let t;try{t=await r.req.json()}catch(r){if(e.isOptional())t=void 0;else throw new o.p8("Invalid JSON body")}try{let s=e.parse(t);return{...r,body:s}}catch(e){if(e instanceof s.jm)throw new o.p8("Validation failed",e.flatten());throw e}}}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[416,585,558,2,381],()=>t(50133));module.exports=s})();