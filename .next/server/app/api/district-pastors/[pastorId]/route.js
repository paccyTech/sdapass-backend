"use strict";(()=>{var e={};e.id=301,e.ids=[301],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},5024:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>R,patchFetch:()=>q,requestAsyncStorage:()=>g,routeModule:()=>N,serverHooks:()=>_,staticGenerationAsyncStorage:()=>A});var i={};r.r(i),r.d(i,{DELETE:()=>f,OPTIONS:()=>y,PATCH:()=>m,PUT:()=>w});var a=r(49303),n=r(88716),o=r(60670),s=r(87070),d=r(91585),u=r(5754),l=r(9846),c=r(38553),p=r(40906);let h=d.Ry({firstName:d.Z_().min(1).optional(),lastName:d.Z_().min(1).optional(),phoneNumber:d.Z_().min(6).optional(),email:d.Z_().email().optional(),districtId:d.Z_().min(1).nullable().optional(),isActive:d.O7().optional()}),I=d.Ry({churchIds:d.IX(d.Z_().min(1))}),m=(0,u.o)({middlewares:[(0,l.k)(["UNION_ADMIN"]),(0,c.m)(h.partial({}))],controller:p.tg}),w=(0,u.o)({middlewares:[(0,l.k)(["UNION_ADMIN"]),(0,c.m)(I)],controller:p.RB}),f=(0,u.o)({middlewares:[(0,l.k)(["UNION_ADMIN"])],controller:p.we}),y=(0,u.o)({controller:async()=>new s.NextResponse(null,{status:204})}),N=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/district-pastors/[pastorId]/route",pathname:"/api/district-pastors/[pastorId]",filename:"route",bundlePath:"app/api/district-pastors/[pastorId]/route"},resolvedPagePath:"/Volumes/Macintosh HD - Data/sda/sda-backend/app/api/district-pastors/[pastorId]/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:g,staticGenerationAsyncStorage:A,serverHooks:_}=N,R="/api/district-pastors/[pastorId]/route";function q(){return(0,o.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:A})}},40906:(e,t,r)=>{r.d(t,{RB:()=>_,aH:()=>g,we:()=>R,P7:()=>N,tg:()=>A});var i=r(53524),a=r(75145),n=r(54164),o=r(65655),s=r(92891),d=r(47833),u=r(13538),l=r(20471);let c={id:!0,firstName:!0,lastName:!0,email:!0,phoneNumber:!0,isActive:!0,districtId:!0,district:{select:{id:!0,name:!0,unionId:!0}},pastorChurches:{select:{id:!0,name:!0,districtId:!0}},createdAt:!0},p=e=>{if(e.role!==i.Role.UNION_ADMIN)throw new d.lY("Only union administrators can manage district pastors")},h=async(e,t={})=>{p(e);let r={role:i.Role.DISTRICT_ADMIN,unionId:e.unionId??void 0};return t.districtId&&(r.districtId=t.districtId),n.T.findMany({where:r,select:c,orderBy:[{lastName:"asc"},{firstName:"asc"}]})},I=async(e,t)=>{p(e);let r=await o.e.findById(t.districtId,{include:{union:!0}});if(!r)throw new d.dR("District not found");if(r.unionId!==e.unionId)throw new d.lY("District does not belong to your union");if(await n.T.findByEmail(t.email))throw new d.AY("Email already in use");if(await n.T.findByPhoneNumber(t.phoneNumber))throw new d.AY("Phone number already in use");let s=await (0,a.c_)(t.password);try{let e=await n.T.create({data:{firstName:t.firstName,lastName:t.lastName,phoneNumber:t.phoneNumber,email:t.email,username:t.email,nationalId:`pastor-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,passwordHash:s,role:i.Role.DISTRICT_ADMIN,unionId:r.unionId,districtId:r.id,isActive:!0},select:c});if(e.email)try{await (0,l.yp)({to:e.email,role:i.Role.DISTRICT_ADMIN,firstName:e.firstName,username:e.email,password:t.password})}catch(e){console.error("Failed to send district pastor credentials email",e)}return{pastor:e}}catch(e){if(e instanceof i.Prisma.PrismaClientKnownRequestError&&"P2002"===e.code&&e.meta?.target&&Array.isArray(e.meta.target)){if(e.meta.target.includes("email"))throw new d.AY("Email already in use");if(e.meta.target.includes("username"))throw new d.AY("Username already in use")}throw e}},m=async(e,t,r)=>{p(e);let a=await n.T.findById(t,{select:{id:!0,unionId:!0,districtId:!0,role:!0}});if(!a||a.role!==i.Role.DISTRICT_ADMIN)throw new d.dR("District pastor not found");if(a.unionId&&e.unionId&&a.unionId!==e.unionId)throw new d.lY("Cannot modify a pastor outside your union");let s=a.districtId;if(void 0!==r.districtId){if(null===r.districtId)s=null;else{let t=await o.e.findById(r.districtId);if(!t)throw new d.dR("District not found");if(e.unionId&&t.unionId!==e.unionId)throw new d.lY("District does not belong to your union");s=t.id}}return await n.T.update({where:{id:t},data:{firstName:r.firstName,lastName:r.lastName,email:r.email,phoneNumber:r.phoneNumber,districtId:s,isActive:r.isActive},select:c})},w=async(e,t,r)=>{p(e);let a=await n.T.findById(t,{select:{id:!0,unionId:!0,districtId:!0,role:!0}});if(!a||a.role!==i.Role.DISTRICT_ADMIN)throw new d.dR("District pastor not found");if(!a.districtId)throw new d.AY("Assign a district before linking churches");let o=await s.d.findMany({where:{id:{in:r}},select:{id:!0,districtId:!0}});if(o.length!==r.length)throw new d.dR("One or more churches were not found");if(o.find(e=>e.districtId!==a.districtId))throw new d.AY("All churches must belong to the pastor's district");return await u._.$transaction([u._.church.updateMany({where:{districtPastorId:t,...r.length?{id:{notIn:r}}:{}},data:{districtPastorId:null}}),...r.length?[u._.church.updateMany({where:{id:{in:r}},data:{districtPastorId:t}})]:[]]),await n.T.findById(t,{select:c})},f=async(e,t)=>{p(e);let r=await n.T.findById(t,{select:{id:!0,unionId:!0,role:!0}});if(!r||r.role!==i.Role.DISTRICT_ADMIN)throw new d.dR("District pastor not found");if(r.unionId&&e.unionId&&r.unionId!==e.unionId)throw new d.lY("Cannot delete a pastor outside your union");await n.T.delete({where:{id:t}})};var y=r(6974);let N=async e=>({pastors:await h(e.user,e.queryData??{})}),g=async e=>{if(!e.body)throw Error("Missing request body");let t=await I(e.user,e.body);return await (0,y.R)({req:e.req,user:e.user,action:"districtPastor.create",details:{pastorId:t.pastor.id,districtId:t.pastor.districtId,email:t.pastor.email,phoneNumber:t.pastor.phoneNumber}}),t},A=async e=>{if(!e.params.pastorId)throw Error("Pastor id is required");let t=e.body??{},r=await m(e.user,e.params.pastorId,t);return await (0,y.R)({req:e.req,user:e.user,action:"districtPastor.update",details:{pastorId:r.id,districtId:r.districtId,changes:t}}),{pastor:r}},_=async e=>{if(!e.body)throw Error("Missing request body");let{churchIds:t}=e.body;if(!Array.isArray(t))throw Error("churchIds must be provided");let r=await w(e.user,e.params.pastorId,t);return await (0,y.R)({req:e.req,user:e.user,action:"districtPastor.assignChurches",details:{pastorId:r.id,churchIds:t}}),{pastor:r}},R=async e=>{if(!e.params.pastorId)throw Error("Pastor id is required");return await f(e.user,e.params.pastorId),await (0,y.R)({req:e.req,user:e.user,action:"districtPastor.delete",details:{pastorId:e.params.pastorId}}),{success:!0}}},9846:(e,t,r)=>{r.d(t,{k:()=>o});var i=r(47833),a=r(75145);let n=e=>{let t=e.headers.get("authorization")??e.headers.get("Authorization");if(!t)throw new i.yj("Missing Authorization header");let r=t.split(" ");if(2!==r.length||"Bearer"!==r[0])throw new i.yj("Malformed Authorization header");return r[1]},o=e=>async t=>{let r=n(t.req),o=await (0,a.Sk)(r);if(e&&!e.includes(o.role))throw new i.yj("Insufficient permissions");return{...t,user:o}}},38553:(e,t,r)=>{r.d(t,{m:()=>n});var i=r(26033),a=r(47833);let n=e=>async t=>{let r;try{r=await t.req.json()}catch(t){if(e.isOptional())r=void 0;else throw new a.p8("Invalid JSON body")}try{let i=e.parse(r);return{...t,body:i}}catch(e){if(e instanceof i.jm)throw new a.p8("Validation failed",e.flatten());throw e}}},92891:(e,t,r)=>{r.d(t,{d:()=>a});var i=r(13538);let a={findById:(e,t)=>i._.church.findUnique({...t??{},where:{id:e}}),findMany:e=>i._.church.findMany(e),create:e=>i._.church.create(e),update:e=>i._.church.update(e),delete:e=>i._.church.delete(e),count:e=>i._.church.count(e)}},65655:(e,t,r)=>{r.d(t,{e:()=>a});var i=r(13538);let a={findById:(e,t)=>i._.district.findUnique({where:{id:e},...t}),findMany:e=>i._.district.findMany(e),create:e=>i._.district.create(e),update:e=>i._.district.update(e),delete:e=>i._.district.delete(e),count:e=>i._.district.count(e)}},6974:(e,t,r)=>{r.d(t,{B:()=>u,R:()=>s});var i=r(13538),a=r(47833);let n=e=>{let t=e.headers.get("x-forwarded-for")??e.headers.get("X-Forwarded-For");return t?t.split(",").map(e=>e.trim()).find(Boolean)??null:(e.headers.get("x-real-ip")??e.headers.get("X-Real-Ip")??e.headers.get("cf-connecting-ip")??e.headers.get("CF-Connecting-Ip"))||null},o=e=>e?`${e.firstName??""} ${e.lastName??""}`.trim()||(e.username??"Unknown"):"Unknown",s=async({req:e,user:t,action:r,details:a})=>{try{let s=n(e),d=e.headers.get("user-agent")??e.headers.get("User-Agent")??null;await i._.auditLog.create({data:{action:r,userName:o(t),userRole:t?.role??null,userId:t?.id??null,unionId:t?.unionId??null,districtId:t?.districtId??null,churchId:t?.churchId??null,ipAddress:s,userAgent:d,details:a??void 0}})}catch(e){console.error("Failed to record audit log",e)}},d=e=>{if(e)return{OR:[{userName:{contains:e,mode:"insensitive"}},{action:{contains:e,mode:"insensitive"}},{ipAddress:{contains:e,mode:"insensitive"}},{userAgent:{contains:e,mode:"insensitive"}}]}},u=async(e,{action:t,role:r,search:n,cursor:o,limit:s=25})=>{if("UNION_ADMIN"!==e.role)throw new a.lY("Only union admins can view audit logs");if(!e.unionId)throw new a.lY("Union context is required to view audit logs");let u={unionId:e.unionId,...t?{action:t}:{},...r?{userRole:r}:{}},l=d(n);l&&(u.AND=u.AND??[],u.AND.push(l));let c=Math.min(Math.max(s,1),100),p=await i._.auditLog.findMany({where:u,orderBy:{createdAt:"desc"},take:c+1,cursor:o?{id:o}:void 0,skip:o?1:0}),h=i._.auditLog.count({where:u}),I=i._.auditLog.groupBy({where:u,by:["action"],_count:{action:!0}}),m=i._.auditLog.groupBy({where:u,by:["userRole"],_count:{userRole:!0}}),[w,f,y]=await Promise.all([h,I,m]),N=null;if(p.length>c){let e=p.pop();N=e?e.id:null}return{logs:p,total:w,countsByAction:f.map(e=>({action:e.action,count:e._count.action})),countsByRole:y.map(e=>({role:e.userRole??null,count:e._count.userRole})),nextCursor:N}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[416,585,2,381],()=>r(5024));module.exports=i})();