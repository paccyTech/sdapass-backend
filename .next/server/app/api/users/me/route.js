"use strict";(()=>{var e={};e.id=847,e.ids=[847],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},24437:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>M,patchFetch:()=>P,requestAsyncStorage:()=>v,routeModule:()=>O,serverHooks:()=>N,staticGenerationAsyncStorage:()=>S});var s={};t.r(s),t.d(s,{GET:()=>R,OPTIONS:()=>T,PATCH:()=>E});var n=t(49303),i=t(88716),a=t(60670),o=t(87070),l=t(91585),d=t(5754),u=t(9846),c=t(38553),p=t(13538),h=t(47833),m=t(54164);let w=e=>{if(void 0===e)return;if(null===e)return null;let r=e.trim();return r.length?r:null},f=async(e,r)=>{let t=w(r.email),s=r.phoneNumber?.trim();if(t&&t!==e.email){let r=await m.T.findByEmail(t);if(r&&r.id!==e.id)throw new h.AY("Email already in use")}if(s&&s!==e.phoneNumber){let r=await m.T.findByPhoneNumber(s);if(r&&r.id!==e.id)throw new h.AY("Phone number already in use")}let n={...void 0!==r.firstName?{firstName:r.firstName.trim()}:{},...void 0!==r.lastName?{lastName:r.lastName.trim()}:{},...void 0!==t?{email:t}:{},...void 0!==s?{phoneNumber:s}:{}};return await p._.user.update({where:{id:e.id},data:n})},_=e=>{let{passwordHash:r,...t}=e;return t},I=async e=>({user:_(e.user)}),y=async e=>{if(!e.body)throw Error("Missing request body");return{user:_(await f(e.user,e.body))}},A=l.Ry({firstName:l.Z_().min(1).optional(),lastName:l.Z_().min(1).optional(),email:l.Z_().email().nullable().optional(),phoneNumber:l.Z_().min(1).optional()}),R=(0,d.o)({middlewares:[(0,u.k)()],controller:I}),E=(0,d.o)({middlewares:[(0,u.k)(),(0,c.m)(A)],controller:y}),T=(0,d.o)({controller:async()=>new o.NextResponse(null,{status:204})}),O=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/users/me/route",pathname:"/api/users/me",filename:"route",bundlePath:"app/api/users/me/route"},resolvedPagePath:"/Volumes/Macintosh HD - Data/sda/sda-backend/app/api/users/me/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:v,staticGenerationAsyncStorage:S,serverHooks:N}=O,M="/api/users/me/route";function P(){return(0,a.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:S})}},37848:(e,r,t)=>{t.d(r,{O:()=>a});let s=e=>{let r=process.env[e];if(!r)throw Error(`Missing required environment variable: ${e}`);return r},n="http://localhost:3000",i=(process.env.CORS_ORIGIN??n).split(",").map(e=>e.trim()).filter(Boolean),a={DATABASE_URL:s("DATABASE_URL"),JWT_SECRET:s("JWT_SECRET"),SMS_API_KEY:process.env.SMS_API_KEY??"",CORS_ORIGIN:process.env.CORS_ORIGIN??n,PRIMARY_ORIGIN:i[0]??n,TWILIO_ACCOUNT_SID:process.env.TWILIO_ACCOUNT_SID??"",TWILIO_AUTH_TOKEN:process.env.TWILIO_AUTH_TOKEN??"",TWILIO_FROM_NUMBER:process.env.TWILIO_FROM_NUMBER??"",GMAIL_USER:process.env.GMAIL_USER,GMAIL_APP_PASSWORD:process.env.GMAIL_APP_PASSWORD,GMAIL_FROM_NAME:process.env.GMAIL_FROM_NAME||"Umuganda SDA",SMTP_HOST:process.env.SMTP_HOST||"smtp.gmail.com",SMTP_PORT:process.env.SMTP_PORT||"587",SMTP_SECURE:process.env.SMTP_SECURE||"false"}},47833:(e,r,t)=>{t.d(r,{AY:()=>o,HC:()=>d,dR:()=>a,gz:()=>s,lY:()=>i,p8:()=>l,yj:()=>n});class s extends Error{constructor(e,r=400,t){super(e),this.name="AppError",this.status=r,this.details=t}}class n extends s{constructor(e="Unauthorized"){super(e,401),this.name="UnauthorizedError"}}class i extends s{constructor(e="Forbidden"){super(e,403),this.name="ForbiddenError"}}class a extends s{constructor(e="Resource not found"){super(e,404),this.name="NotFoundError"}}class o extends s{constructor(e="Conflict"){super(e,409),this.name="ConflictError"}}class l extends s{constructor(e="Validation failed",r){super(e,422,r),this.name="ValidationError"}}let d=e=>e instanceof s},9293:(e,r,t)=>{t.d(r,{X:()=>l});var s=t(87070),n=t(26033),i=t(47833),a=t(37848);let o=(e,r)=>s.NextResponse.json(e,r),l=async(e,r)=>{if("OPTIONS"===e.method)return p(new s.NextResponse(null,{status:204}),e);try{let t;let n=await r();return t=n instanceof s.NextResponse?n:o({data:n}),p(t,e)}catch(t){let r;if(t instanceof n.jm){let e=new i.p8("Validation failed",t.flatten());r=s.NextResponse.json({error:e.message,details:e.details},{status:e.status})}else(0,i.HC)(t)?r=s.NextResponse.json({error:t.message,details:t.details},{status:t.status}):(t instanceof Error?console.error(t):console.error("Unknown error",t),r=s.NextResponse.json({error:"Internal Server Error"},{status:500}));return p(r,e)}},d=e=>e.replace(/^"|"$/g,"").replace(/^'|'$/g,""),u=e=>d(e).replace(/\/$/,""),c=()=>a.O.CORS_ORIGIN?a.O.CORS_ORIGIN.split(",").map(e=>e.trim()).filter(Boolean).map(e=>u(e)):[],p=(e,r)=>{let t=c();if(!t.length)return e;let s=r?.headers.get("origin")??null,n=s?u(s):null,i=null;if(n&&t.includes(n)?i=n:n&&t.includes("*")?i=n:1===t.length&&(i=t[0]),!i&&t.length&&(i=t[0]),!i)return e;e.headers.set("Access-Control-Allow-Origin",i);let a=r?.headers.get("access-control-request-headers");return e.headers.set("Access-Control-Allow-Methods","GET,POST,PUT,PATCH,DELETE,OPTIONS"),e.headers.set("Access-Control-Allow-Headers",a&&a.length?a:"Content-Type,Authorization,Accept"),e.headers.set("Access-Control-Allow-Credentials","true"),e.headers.set("Access-Control-Max-Age","600"),e.headers.set("Vary","Origin"),e}},13538:(e,r,t)=>{t.d(r,{_:()=>n});var s=t(53524);let n=globalThis.prisma??new s.PrismaClient({log:["error"]})},5754:(e,r,t)=>{t.d(r,{o:()=>n});var s=t(9293);let n=({middlewares:e=[],controller:r})=>async(t,n)=>(0,s.X)(t,async()=>{let s=new URL(t.url),i={req:t,params:n?.params??{},query:s.searchParams};for(let r of e)i=await r(i);return r({...i,params:i.params})})},9846:(e,r,t)=>{t.d(r,{k:()=>a});var s=t(47833),n=t(75145);let i=e=>{let r=e.headers.get("authorization")??e.headers.get("Authorization");if(!r)throw new s.yj("Missing Authorization header");let t=r.split(" ");if(2!==t.length||"Bearer"!==t[0])throw new s.yj("Malformed Authorization header");return t[1]},a=e=>async r=>{let t=i(r.req),a=await (0,n.Sk)(t);if(e&&!e.includes(a.role))throw new s.yj("Insufficient permissions");return{...r,user:a}}},38553:(e,r,t)=>{t.d(r,{m:()=>i});var s=t(26033),n=t(47833);let i=e=>async r=>{let t;try{t=await r.req.json()}catch(r){if(e.isOptional())t=void 0;else throw new n.p8("Invalid JSON body")}try{let s=e.parse(t);return{...r,body:s}}catch(e){if(e instanceof s.jm)throw new n.p8("Validation failed",e.flatten());throw e}}},54164:(e,r,t)=>{t.d(r,{T:()=>n});var s=t(13538);let n={findById:(e,r)=>s._.user.findUnique({where:{id:e},...r??{}}),findByUsername:(e,r)=>s._.user.findUnique({where:{username:e},...r??{}}),findByEmail:(e,r)=>s._.user.findUnique({where:{email:e},...r??{}}),findByPhoneNumber:(e,r)=>s._.user.findUnique({where:{phoneNumber:e},...r??{}}),findByNationalId:(e,r)=>s._.user.findUnique({where:{nationalId:e},...r??{}}),findMany:e=>s._.user.findMany(e),count:e=>s._.user.count(e),create:e=>s._.user.create(e),update:e=>s._.user.update(e),delete:e=>s._.user.delete(e)}},75145:(e,r,t)=>{t.d(r,{$N:()=>f,Cp:()=>_,Sk:()=>w,c_:()=>p});var s=t(42023),n=t.n(s),i=t(41482),a=t.n(i),o=t(53524),l=t(13538),d=t(37848),u=t(47833),c=t(54164);let p=async e=>{let r=await n().genSalt(10);return n().hash(e,r)},h=async(e,r)=>n().compare(e,r),m=e=>{let r={sub:e.id,role:e.role,unionId:e.unionId,districtId:e.districtId,churchId:e.churchId};return a().sign(r,d.O.JWT_SECRET,{expiresIn:43200})},w=async e=>{try{let r=a().verify(e,d.O.JWT_SECRET),t=await l._.user.findUnique({where:{id:r.sub}});if(!t)throw new u.yj("User not found");if(!t.isActive)throw new u.yj("Account disabled");return t}catch(e){if(e instanceof u.yj)throw e;throw new u.yj("Invalid token")}},f=async({email:e,phoneNumber:r,password:t})=>{let s=null;if(r){if(!(s=await c.T.findByPhoneNumber(r))||!s.isActive)throw new u.yj("Invalid credentials");if(s.role!==o.Role.MEMBER)throw new u.yj("Phone number login is restricted to members")}else if(e){if(!(s=await c.T.findByEmail(e))||!s.isActive)throw new u.yj("Invalid credentials");if(s.role===o.Role.MEMBER)throw new u.yj("Members must sign in with their phone number")}else throw new u.yj("Email or phone number is required");if(!await h(t,s.passwordHash))throw new u.yj("Invalid credentials");let n=m({id:s.id,role:s.role,unionId:s.unionId,districtId:s.districtId,churchId:s.churchId}),{passwordHash:i,...a}=s;return{token:n,user:a}},_=async(e,r)=>{if(!await h(r.currentPassword,e.passwordHash))throw new u.yj("Invalid current password");let t=await p(r.newPassword),{passwordHash:s,...n}=await l._.user.update({where:{id:e.id},data:{passwordHash:t}});return{user:n}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[416,585],()=>t(24437));module.exports=s})();