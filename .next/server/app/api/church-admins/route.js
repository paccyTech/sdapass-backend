"use strict";(()=>{var e={};e.id=538,e.ids=[538],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},69996:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>q,patchFetch:()=>_,requestAsyncStorage:()=>A,routeModule:()=>y,serverHooks:()=>R,staticGenerationAsyncStorage:()=>g});var i={};t.r(i),t.d(i,{GET:()=>p,OPTIONS:()=>N,POST:()=>f});var a=t(49303),n=t(88716),o=t(60670),d=t(87070),s=t(91585),u=t(5754),c=t(9846),l=t(38553),h=t(91941),m=t(5651);let I=s.Ry({districtId:s.Z_().optional(),churchId:s.Z_().optional()}),w=s.Ry({churchId:s.Z_().min(1,"Church is required"),firstName:s.Z_().min(1,"First name is required"),lastName:s.Z_().min(1,"Last name is required"),phoneNumber:s.Z_().min(6,"Phone number is required"),email:s.Z_().email("Valid email is required"),password:s.Z_().min(8,"Password must be at least 8 characters")}),p=(0,u.o)({middlewares:[(0,c.k)(["UNION_ADMIN","DISTRICT_ADMIN"]),(0,h.i)(I)],controller:m.F4}),f=(0,u.o)({middlewares:[(0,c.k)(["UNION_ADMIN","DISTRICT_ADMIN"]),(0,l.m)(w)],controller:m.RP}),N=(0,u.o)({controller:async()=>new d.NextResponse(null,{status:204})}),y=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/church-admins/route",pathname:"/api/church-admins",filename:"route",bundlePath:"app/api/church-admins/route"},resolvedPagePath:"/Volumes/Macintosh HD - Data/sda/sda-backend/app/api/church-admins/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:A,staticGenerationAsyncStorage:g,serverHooks:R}=y,q="/api/church-admins/route";function _(){return(0,o.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:g})}},5651:(e,r,t)=>{t.d(r,{RP:()=>A,Uj:()=>R,F4:()=>y,RO:()=>g});var i=t(53524),a=t(84770),n=t(92891),o=t(54164),d=t(47833),s=t(20471),u=t(75145);let c={id:!0,firstName:!0,lastName:!0,email:!0,phoneNumber:!0,isActive:!0,unionId:!0,districtId:!0,churchId:!0,church:{select:{id:!0,name:!0,districtId:!0}},createdAt:!0},l=e=>{if(e.role!==i.Role.UNION_ADMIN&&e.role!==i.Role.DISTRICT_ADMIN)throw new d.lY("Not allowed to manage church administrators")},h=async(e,r)=>{let t=await n.d.findById(r,{include:{district:{select:{id:!0,unionId:!0}}}});if(!t)throw new d.dR("Church not found");let a=t.district;if(!a)throw new d.dR("Church is missing district context");if(e.role===i.Role.UNION_ADMIN){if(e.unionId&&e.unionId!==a.unionId)throw new d.lY("Church is outside your union");return t}if(e.role===i.Role.DISTRICT_ADMIN){if(!e.districtId||e.districtId!==t.districtId)throw new d.lY("Church is outside your district");return t}throw new d.lY("Not allowed to manage this church")},m=(e,r)=>{if(e.role===i.Role.UNION_ADMIN){if(e.unionId&&r.unionId&&e.unionId!==r.unionId)throw new d.lY("Administrator belongs to another union");return}if(e.role===i.Role.DISTRICT_ADMIN){if(!e.districtId||e.districtId!==r.districtId)throw new d.lY("Administrator belongs to another district");return}throw new d.lY("Not allowed to manage this administrator")},I=async(e,r={})=>{l(e);let t={role:i.Role.CHURCH_ADMIN};if(r.churchId&&(t.churchId=r.churchId),r.districtId&&(t.districtId=r.districtId),e.role===i.Role.UNION_ADMIN)e.unionId&&(t.unionId=e.unionId);else if(e.role===i.Role.DISTRICT_ADMIN){if(!e.districtId)throw new d.lY("District not assigned to this account");t.districtId=e.districtId}return o.T.findMany({where:t,select:c,orderBy:[{lastName:"asc"},{firstName:"asc"}]})},w=async(e,r)=>{l(e);let t=await h(e,r.churchId);if(await o.T.findByEmail(r.email))throw new d.AY("Email already in use");if(await o.T.findByPhoneNumber(r.phoneNumber))throw new d.AY("Phone number already in use");let n=await (0,u.c_)(r.password);try{let e=await o.T.create({data:{firstName:r.firstName,lastName:r.lastName,phoneNumber:r.phoneNumber,email:r.email,username:r.email,nationalId:`church-admin-${Date.now()}-${(0,a.randomBytes)(3).toString("hex")}`,passwordHash:n,role:i.Role.CHURCH_ADMIN,unionId:t.district.unionId,districtId:t.districtId,churchId:t.id,isActive:!0},select:c});if(e.email)try{await (0,s.yp)({to:e.email,role:i.Role.CHURCH_ADMIN,firstName:e.firstName,username:e.email,password:r.password})}catch(e){console.error("Failed to send church admin credentials email",e)}return{admin:e}}catch(e){if(e instanceof i.Prisma.PrismaClientKnownRequestError&&"P2002"===e.code&&e.meta?.target&&Array.isArray(e.meta.target)){if(e.meta.target.includes("email"))throw new d.AY("Email already in use");if(e.meta.target.includes("username"))throw new d.AY("Username already in use")}throw e}},p=async(e,r,t)=>{l(e);let a=await o.T.findById(r,{select:{id:!0,role:!0,unionId:!0,districtId:!0,churchId:!0}});if(!a||a.role!==i.Role.CHURCH_ADMIN)throw new d.dR("Church administrator not found");m(e,a);let n=a.churchId??null,s=a.districtId??null,u=a.unionId??null;if(t.churchId){let r=await h(e,t.churchId),i=r.district;n=r.id,s=r.districtId,u=i.unionId}let I={};n?I.church={connect:{id:n}}:I.church={disconnect:!0},s?I.district={connect:{id:s}}:I.district={disconnect:!0},u?I.union={connect:{id:u}}:I.union={disconnect:!0},void 0!==t.firstName&&(I.firstName=t.firstName),void 0!==t.lastName&&(I.lastName=t.lastName),void 0!==t.phoneNumber&&(I.phoneNumber=t.phoneNumber),void 0!==t.isActive&&(I.isActive=t.isActive),void 0!==t.email&&(I.email=t.email,I.username=t.email);try{return{admin:await o.T.update({where:{id:r},data:I,select:c})}}catch(e){if(e instanceof i.Prisma.PrismaClientKnownRequestError&&"P2002"===e.code&&e.meta?.target&&Array.isArray(e.meta.target)){if(e.meta.target.includes("email"))throw new d.AY("Email already in use");if(e.meta.target.includes("username"))throw new d.AY("Username already in use")}throw e}},f=async(e,r)=>{l(e);let t=await o.T.findById(r,{select:{id:!0,role:!0,unionId:!0,districtId:!0}});if(!t||t.role!==i.Role.CHURCH_ADMIN)throw new d.dR("Church administrator not found");return m(e,t),await o.T.delete({where:{id:r}}),{success:!0}};var N=t(6974);let y=async e=>({admins:await I(e.user,e.queryData??{})}),A=async e=>{if(!e.body)throw Error("Missing request body");let r=await w(e.user,e.body);return await (0,N.R)({req:e.req,user:e.user,action:"churchAdmin.create",details:{adminId:r.admin.id,churchId:r.admin.churchId,email:r.admin.email,phoneNumber:r.admin.phoneNumber}}),r},g=async e=>{if(!e.paramsData?.adminId)throw Error("Administrator id is required");let r=e.body??{},t=await p(e.user,e.paramsData.adminId,r);return await (0,N.R)({req:e.req,user:e.user,action:"churchAdmin.update",details:{adminId:t.admin.id,churchId:t.admin.churchId,changes:r}}),t},R=async e=>{if(!e.paramsData?.adminId)throw Error("Administrator id is required");let r=await f(e.user,e.paramsData.adminId);return await (0,N.R)({req:e.req,user:e.user,action:"churchAdmin.delete",details:{adminId:e.paramsData.adminId}}),r}},9846:(e,r,t)=>{t.d(r,{k:()=>o});var i=t(47833),a=t(75145);let n=e=>{let r=e.headers.get("authorization")??e.headers.get("Authorization");if(!r)throw new i.yj("Missing Authorization header");let t=r.split(" ");if(2!==t.length||"Bearer"!==t[0])throw new i.yj("Malformed Authorization header");return t[1]},o=e=>async r=>{let t=n(r.req),o=await (0,a.Sk)(t);if(e&&!e.includes(o.role))throw new i.yj("Insufficient permissions");return{...r,user:o}}},38553:(e,r,t)=>{t.d(r,{m:()=>n});var i=t(26033),a=t(47833);let n=e=>async r=>{let t;try{t=await r.req.json()}catch(r){if(e.isOptional())t=void 0;else throw new a.p8("Invalid JSON body")}try{let i=e.parse(t);return{...r,body:i}}catch(e){if(e instanceof i.jm)throw new a.p8("Validation failed",e.flatten());throw e}}},91941:(e,r,t)=>{t.d(r,{i:()=>n});var i=t(26033),a=t(47833);let n=e=>async r=>{let t=Object.fromEntries(r.query.entries());try{let i=e.parse(t);return{...r,queryData:i}}catch(e){if(e instanceof i.jm)throw new a.p8("Invalid query parameters",e.flatten());throw e}}},92891:(e,r,t)=>{t.d(r,{d:()=>a});var i=t(13538);let a={findById:(e,r)=>i._.church.findUnique({...r??{},where:{id:e}}),findMany:e=>i._.church.findMany(e),create:e=>i._.church.create(e),update:e=>i._.church.update(e),delete:e=>i._.church.delete(e),count:e=>i._.church.count(e)}},6974:(e,r,t)=>{t.d(r,{B:()=>u,R:()=>d});var i=t(13538),a=t(47833);let n=e=>{let r=e.headers.get("x-forwarded-for")??e.headers.get("X-Forwarded-For");return r?r.split(",").map(e=>e.trim()).find(Boolean)??null:(e.headers.get("x-real-ip")??e.headers.get("X-Real-Ip")??e.headers.get("cf-connecting-ip")??e.headers.get("CF-Connecting-Ip"))||null},o=e=>e?`${e.firstName??""} ${e.lastName??""}`.trim()||(e.username??"Unknown"):"Unknown",d=async({req:e,user:r,action:t,details:a})=>{try{let d=n(e),s=e.headers.get("user-agent")??e.headers.get("User-Agent")??null;await i._.auditLog.create({data:{action:t,userName:o(r),userRole:r?.role??null,userId:r?.id??null,unionId:r?.unionId??null,districtId:r?.districtId??null,churchId:r?.churchId??null,ipAddress:d,userAgent:s,details:a??void 0}})}catch(e){console.error("Failed to record audit log",e)}},s=e=>{if(e)return{OR:[{userName:{contains:e,mode:"insensitive"}},{action:{contains:e,mode:"insensitive"}},{ipAddress:{contains:e,mode:"insensitive"}},{userAgent:{contains:e,mode:"insensitive"}}]}},u=async(e,{action:r,role:t,search:n,cursor:o,limit:d=25})=>{if("UNION_ADMIN"!==e.role)throw new a.lY("Only union admins can view audit logs");if(!e.unionId)throw new a.lY("Union context is required to view audit logs");let u={unionId:e.unionId,...r?{action:r}:{},...t?{userRole:t}:{}},c=s(n);c&&(u.AND=u.AND??[],u.AND.push(c));let l=Math.min(Math.max(d,1),100),h=await i._.auditLog.findMany({where:u,orderBy:{createdAt:"desc"},take:l+1,cursor:o?{id:o}:void 0,skip:o?1:0}),m=i._.auditLog.count({where:u}),I=i._.auditLog.groupBy({where:u,by:["action"],_count:{action:!0}}),w=i._.auditLog.groupBy({where:u,by:["userRole"],_count:{userRole:!0}}),[p,f,N]=await Promise.all([m,I,w]),y=null;if(h.length>l){let e=h.pop();y=e?e.id:null}return{logs:h,total:p,countsByAction:f.map(e=>({action:e.action,count:e._count.action})),countsByRole:N.map(e=>({role:e.userRole??null,count:e._count.userRole})),nextCursor:y}}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),i=r.X(0,[416,585,2,381],()=>t(69996));module.exports=i})();