"use strict";(()=>{var e={};e.id=449,e.ids=[449],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},22166:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>q,requestAsyncStorage:()=>D,routeModule:()=>A,serverHooks:()=>g,staticGenerationAsyncStorage:()=>R});var i={};r.r(i),r.d(i,{DELETE:()=>y,OPTIONS:()=>N,PATCH:()=>f});var a=r(49303),n=r(88716),o=r(60670),d=r(87070),s=r(91585),c=r(5754),u=r(9846),l=r(38553),h=r(46526),m=r(81423),I=r(5651);let w=s.Ry({adminId:s.Z_().min(1)}),p=s.Ry({firstName:s.Z_().min(1).optional(),lastName:s.Z_().min(1).optional(),phoneNumber:s.Z_().min(6).optional(),email:s.Z_().email().optional(),churchId:s.Z_().min(1).optional(),isActive:s.O7().optional()}),f=(0,c.o)({middlewares:[(0,u.k)(["UNION_ADMIN","DISTRICT_ADMIN"]),(0,m.r)(w),(0,l.m)(p.partial({})),(0,h.Dy)({key:"churchId",optional:!0})],controller:I.RO}),y=(0,c.o)({middlewares:[(0,u.k)(["UNION_ADMIN","DISTRICT_ADMIN"]),(0,m.r)(w)],controller:I.Uj}),N=(0,c.o)({controller:async()=>new d.NextResponse(null,{status:204})}),A=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/church-admins/[adminId]/route",pathname:"/api/church-admins/[adminId]",filename:"route",bundlePath:"app/api/church-admins/[adminId]/route"},resolvedPagePath:"/Volumes/Macintosh HD - Data/sda/sda-backend/app/api/church-admins/[adminId]/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:D,staticGenerationAsyncStorage:R,serverHooks:g}=A,_="/api/church-admins/[adminId]/route";function q(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:R})}},5651:(e,t,r)=>{r.d(t,{RP:()=>A,Uj:()=>R,F4:()=>N,RO:()=>D});var i=r(53524),a=r(84770),n=r(92891),o=r(54164),d=r(47833),s=r(20471),c=r(75145);let u={id:!0,firstName:!0,lastName:!0,email:!0,phoneNumber:!0,isActive:!0,unionId:!0,districtId:!0,churchId:!0,church:{select:{id:!0,name:!0,districtId:!0}},createdAt:!0},l=e=>{if(e.role!==i.Role.UNION_ADMIN&&e.role!==i.Role.DISTRICT_ADMIN)throw new d.lY("Not allowed to manage church administrators")},h=async(e,t)=>{let r=await n.d.findById(t,{include:{district:{select:{id:!0,unionId:!0}}}});if(!r)throw new d.dR("Church not found");let a=r.district;if(!a)throw new d.dR("Church is missing district context");if(e.role===i.Role.UNION_ADMIN){if(e.unionId&&e.unionId!==a.unionId)throw new d.lY("Church is outside your union");return r}if(e.role===i.Role.DISTRICT_ADMIN){if(!e.districtId||e.districtId!==r.districtId)throw new d.lY("Church is outside your district");return r}throw new d.lY("Not allowed to manage this church")},m=(e,t)=>{if(e.role===i.Role.UNION_ADMIN){if(e.unionId&&t.unionId&&e.unionId!==t.unionId)throw new d.lY("Administrator belongs to another union");return}if(e.role===i.Role.DISTRICT_ADMIN){if(!e.districtId||e.districtId!==t.districtId)throw new d.lY("Administrator belongs to another district");return}throw new d.lY("Not allowed to manage this administrator")},I=async(e,t={})=>{l(e);let r={role:i.Role.CHURCH_ADMIN};if(t.churchId&&(r.churchId=t.churchId),t.districtId&&(r.districtId=t.districtId),e.role===i.Role.UNION_ADMIN)e.unionId&&(r.unionId=e.unionId);else if(e.role===i.Role.DISTRICT_ADMIN){if(!e.districtId)throw new d.lY("District not assigned to this account");r.districtId=e.districtId}return o.T.findMany({where:r,select:u,orderBy:[{lastName:"asc"},{firstName:"asc"}]})},w=async(e,t)=>{l(e);let r=await h(e,t.churchId);if(await o.T.findByEmail(t.email))throw new d.AY("Email already in use");if(await o.T.findByPhoneNumber(t.phoneNumber))throw new d.AY("Phone number already in use");let n=await (0,c.c_)(t.password);try{let e=await o.T.create({data:{firstName:t.firstName,lastName:t.lastName,phoneNumber:t.phoneNumber,email:t.email,username:t.email,nationalId:`church-admin-${Date.now()}-${(0,a.randomBytes)(3).toString("hex")}`,passwordHash:n,role:i.Role.CHURCH_ADMIN,unionId:r.district.unionId,districtId:r.districtId,churchId:r.id,isActive:!0},select:u});if(e.email)try{await (0,s.yp)({to:e.email,role:i.Role.CHURCH_ADMIN,firstName:e.firstName,username:e.email,password:t.password})}catch(e){console.error("Failed to send church admin credentials email",e)}return{admin:e}}catch(e){if(e instanceof i.Prisma.PrismaClientKnownRequestError&&"P2002"===e.code&&e.meta?.target&&Array.isArray(e.meta.target)){if(e.meta.target.includes("email"))throw new d.AY("Email already in use");if(e.meta.target.includes("username"))throw new d.AY("Username already in use")}throw e}},p=async(e,t,r)=>{l(e);let a=await o.T.findById(t,{select:{id:!0,role:!0,unionId:!0,districtId:!0,churchId:!0}});if(!a||a.role!==i.Role.CHURCH_ADMIN)throw new d.dR("Church administrator not found");m(e,a);let n=a.churchId??null,s=a.districtId??null,c=a.unionId??null;if(r.churchId){let t=await h(e,r.churchId),i=t.district;n=t.id,s=t.districtId,c=i.unionId}let I={};n?I.church={connect:{id:n}}:I.church={disconnect:!0},s?I.district={connect:{id:s}}:I.district={disconnect:!0},c?I.union={connect:{id:c}}:I.union={disconnect:!0},void 0!==r.firstName&&(I.firstName=r.firstName),void 0!==r.lastName&&(I.lastName=r.lastName),void 0!==r.phoneNumber&&(I.phoneNumber=r.phoneNumber),void 0!==r.isActive&&(I.isActive=r.isActive),void 0!==r.email&&(I.email=r.email,I.username=r.email);try{return{admin:await o.T.update({where:{id:t},data:I,select:u})}}catch(e){if(e instanceof i.Prisma.PrismaClientKnownRequestError&&"P2002"===e.code&&e.meta?.target&&Array.isArray(e.meta.target)){if(e.meta.target.includes("email"))throw new d.AY("Email already in use");if(e.meta.target.includes("username"))throw new d.AY("Username already in use")}throw e}},f=async(e,t)=>{l(e);let r=await o.T.findById(t,{select:{id:!0,role:!0,unionId:!0,districtId:!0}});if(!r||r.role!==i.Role.CHURCH_ADMIN)throw new d.dR("Church administrator not found");return m(e,r),await o.T.delete({where:{id:t}}),{success:!0}};var y=r(6974);let N=async e=>({admins:await I(e.user,e.queryData??{})}),A=async e=>{if(!e.body)throw Error("Missing request body");let t=await w(e.user,e.body);return await (0,y.R)({req:e.req,user:e.user,action:"churchAdmin.create",details:{adminId:t.admin.id,churchId:t.admin.churchId,email:t.admin.email,phoneNumber:t.admin.phoneNumber}}),t},D=async e=>{if(!e.paramsData?.adminId)throw Error("Administrator id is required");let t=e.body??{},r=await p(e.user,e.paramsData.adminId,t);return await (0,y.R)({req:e.req,user:e.user,action:"churchAdmin.update",details:{adminId:r.admin.id,churchId:r.admin.churchId,changes:t}}),r},R=async e=>{if(!e.paramsData?.adminId)throw Error("Administrator id is required");let t=await f(e.user,e.paramsData.adminId);return await (0,y.R)({req:e.req,user:e.user,action:"churchAdmin.delete",details:{adminId:e.paramsData.adminId}}),t}},46526:(e,t,r)=>{r.d(t,{Dy:()=>u,J$:()=>c});var i=r(13538),a=r(47833);let n=async(e,t)=>{let r=await i._.district.findUnique({where:{id:t},include:{union:!0}});if(!r)throw new a.dR("District not found");if("UNION_ADMIN"===e.role||"DISTRICT_ADMIN"===e.role&&e.districtId===t)return r;throw new a.lY("Not allowed to access this district")},o=async(e,t)=>{let r=await i._.church.findUnique({where:{id:t},include:{district:{include:{union:!0}}}});if(!r)throw new a.dR("Church not found");if("UNION_ADMIN"===e.role||"DISTRICT_ADMIN"===e.role&&e.districtId===r.districtId||"CHURCH_ADMIN"===e.role&&e.churchId===t)return r;throw new a.lY("Not allowed to access this church")},d=(e,t)=>{let r="paramsData"in e&&e.paramsData&&"object"==typeof e.paramsData?e.paramsData[t]:void 0,i=e.params?.[t],a="queryData"in e&&e.queryData&&"object"==typeof e.queryData?e.queryData[t]:void 0,n="body"in e&&e.body&&"object"==typeof e.body?e.body[t]:void 0,o=r??i??a??n;return"string"==typeof o&&o.trim().length>0?o:void 0},s=(e,t,{optional:r}={})=>{let i=d(e,t);if(!i&&!r)throw new a.p8(`Missing or invalid identifier for ${t}`);return i},c=(e={})=>{let t=e.key??"districtId",r=e.optional??!1;return async e=>{if(!e.user)throw new a.yj("Authentication required");let i=s(e,t,{optional:r});if(!i)return{...e,district:e.district};let o=await n(e.user,i);return{...e,district:o}}},u=(e={})=>{let t=e.key??"churchId",r=e.optional??!1;return async e=>{if(!e.user)throw new a.yj("Authentication required");let i=s(e,t,{optional:r});if(!i)return{...e,church:e.church};let n=await o(e.user,i);return{...e,church:n}}}},9846:(e,t,r)=>{r.d(t,{k:()=>o});var i=r(47833),a=r(75145);let n=e=>{let t=e.headers.get("authorization")??e.headers.get("Authorization");if(!t)throw new i.yj("Missing Authorization header");let r=t.split(" ");if(2!==r.length||"Bearer"!==r[0])throw new i.yj("Malformed Authorization header");return r[1]},o=e=>async t=>{let r=n(t.req),o=await (0,a.Sk)(r);if(e&&!e.includes(o.role))throw new i.yj("Insufficient permissions");return{...t,user:o}}},38553:(e,t,r)=>{r.d(t,{m:()=>n});var i=r(26033),a=r(47833);let n=e=>async t=>{let r;try{r=await t.req.json()}catch(t){if(e.isOptional())r=void 0;else throw new a.p8("Invalid JSON body")}try{let i=e.parse(r);return{...t,body:i}}catch(e){if(e instanceof i.jm)throw new a.p8("Validation failed",e.flatten());throw e}}},81423:(e,t,r)=>{r.d(t,{r:()=>n});var i=r(26033),a=r(47833);let n=e=>async t=>{try{let r=e.parse(t.params);return{...t,paramsData:r}}catch(e){if(e instanceof i.jm)throw new a.p8("Invalid route parameters",e.flatten());throw e}}},92891:(e,t,r)=>{r.d(t,{d:()=>a});var i=r(13538);let a={findById:(e,t)=>i._.church.findUnique({...t??{},where:{id:e}}),findMany:e=>i._.church.findMany(e),create:e=>i._.church.create(e),update:e=>i._.church.update(e),delete:e=>i._.church.delete(e),count:e=>i._.church.count(e)}},6974:(e,t,r)=>{r.d(t,{B:()=>c,R:()=>d});var i=r(13538),a=r(47833);let n=e=>{let t=e.headers.get("x-forwarded-for")??e.headers.get("X-Forwarded-For");return t?t.split(",").map(e=>e.trim()).find(Boolean)??null:(e.headers.get("x-real-ip")??e.headers.get("X-Real-Ip")??e.headers.get("cf-connecting-ip")??e.headers.get("CF-Connecting-Ip"))||null},o=e=>e?`${e.firstName??""} ${e.lastName??""}`.trim()||(e.username??"Unknown"):"Unknown",d=async({req:e,user:t,action:r,details:a})=>{try{let d=n(e),s=e.headers.get("user-agent")??e.headers.get("User-Agent")??null;await i._.auditLog.create({data:{action:r,userName:o(t),userRole:t?.role??null,userId:t?.id??null,unionId:t?.unionId??null,districtId:t?.districtId??null,churchId:t?.churchId??null,ipAddress:d,userAgent:s,details:a??void 0}})}catch(e){console.error("Failed to record audit log",e)}},s=e=>{if(e)return{OR:[{userName:{contains:e,mode:"insensitive"}},{action:{contains:e,mode:"insensitive"}},{ipAddress:{contains:e,mode:"insensitive"}},{userAgent:{contains:e,mode:"insensitive"}}]}},c=async(e,{action:t,role:r,search:n,cursor:o,limit:d=25})=>{if("UNION_ADMIN"!==e.role)throw new a.lY("Only union admins can view audit logs");if(!e.unionId)throw new a.lY("Union context is required to view audit logs");let c={unionId:e.unionId,...t?{action:t}:{},...r?{userRole:r}:{}},u=s(n);u&&(c.AND=c.AND??[],c.AND.push(u));let l=Math.min(Math.max(d,1),100),h=await i._.auditLog.findMany({where:c,orderBy:{createdAt:"desc"},take:l+1,cursor:o?{id:o}:void 0,skip:o?1:0}),m=i._.auditLog.count({where:c}),I=i._.auditLog.groupBy({where:c,by:["action"],_count:{action:!0}}),w=i._.auditLog.groupBy({where:c,by:["userRole"],_count:{userRole:!0}}),[p,f,y]=await Promise.all([m,I,w]),N=null;if(h.length>l){let e=h.pop();N=e?e.id:null}return{logs:h,total:p,countsByAction:f.map(e=>({action:e.action,count:e._count.action})),countsByRole:y.map(e=>({role:e.userRole??null,count:e._count.userRole})),nextCursor:N}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[416,585,2,381],()=>r(22166));module.exports=i})();